<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Status Truk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .hidden { display: none; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .sidebar-link.active { background-color: #4f46e5; color: white; }
        .status-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transition: all 0.2s ease-in-out;
        }
        .header-filter-popup {
            position: absolute; background-color: white; border: 1px solid #e2e8f0; border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            z-index: 1010; width: 250px; padding: 0.5rem;
        }
        .filter-options { max-height: 200px; overflow-y: auto; padding: 0.5rem; margin-bottom: 0.5rem; }
        .filter-item { display: block; margin-bottom: 0.5rem; }
        th[data-filter] { cursor: pointer; position: relative; }
        th[data-filter]:hover { background-color: #eef2ff; }
        th[data-filter]::after {
            content: '\f0d7'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
            margin-left: 8px; color: #94a3b8;
            transition: all 0.2s;
        }
        
        th[data-filter].sort-asc::after,
        th[data-filter].sort-desc::after {
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-left: 8px;
            color: #4f46e5;
        }
        th[data-filter].sort-asc::after {
            content: '\f0de';
        }
        th[data-filter].sort-desc::after {
            content: '\f0dd';
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 0.75rem;
            width: 90%; max-width: 900px; max-height: 90vh;
            display: flex; flex-direction: column; position: relative;
        }
        .modal-close {
            position: absolute; top: 1rem; right: 1.5rem;
            font-size: 2rem; font-weight: bold; color: #64748b; cursor: pointer;
        }
        .modal-body { overflow-y: auto; }
        th[data-sort] { cursor: pointer; }
        th[data-sort]:hover { background-color: #eef2ff; }
        .pagination-btn.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="loading-container" class="min-h-screen flex flex-col items-center justify-center">
        <i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i>
        <p class="mt-4 text-slate-600 font-semibold">Memuat...</p>
    </div>

    <div id="login-container" class="min-h-screen flex items-center justify-center bg-slate-100 p-4 hidden">
        <div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl overflow-hidden md:flex">
            <div class="hidden md:block md:w-1/2 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1622979205933-4d51c33d1808?q=80&w=2574&auto=format&fit=crop');">
                <div class="h-full w-full bg-slate-900 bg-opacity-60 p-10 flex flex-col justify-between">
                    <div>
                        <h1 class="text-3xl font-bold tracking-wider text-white"><i class="fas fa-truck-moving mr-2"></i>LOG IKK</h1>
                        <p class="text-slate-200 mt-2">Portal Monitoring & Update Status Truck.</p>
                    </div>
                    <div class="text-slate-100 text-sm">
                        &copy; <span id="copyright-year-login-vendor"></span> Jagaddhita Arya Koswara
                    </div>
                </div>
            </div>

            <div class="w-full md:w-1/2 p-8 md:p-12">
                <h2 class="text-3xl font-bold text-slate-800 mb-2">Login Angkutan</h2>
                <p class="text-slate-500 mb-8">Selamat datang, silakan masuk ke akun Anda.</p>
                
                <div class="space-y-6">
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <i class="fas fa-envelope text-slate-400"></i>
                        </span>
                        <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 pl-10 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <i class="fas fa-lock text-slate-400"></i>
                        </span>
                        <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 pl-10 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                    
                    <div id="loginError" class="text-red-500 text-sm h-4"></div>

                    <button id="loginButton" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Masuk</button>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboard-container" class="hidden">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>
        <div class="relative h-screen flex overflow-hidden">
            <aside id="sidebar" class="bg-slate-800 text-white w-64 flex-shrink-0 fixed inset-y-0 left-0 transform -translate-x-full lg:relative lg:translate-x-0 transition-transform duration-300 ease-in-out z-40 flex flex-col overflow-y-auto">
                <div class="h-16 flex items-center justify-between px-4 border-b border-slate-700 flex-shrink-0">
                     <h1 class="text-2xl font-bold tracking-wider"><i class="fas fa-truck-moving mr-2"></i>LOG IKK</h1>
                     <button id="sidebar-close-btn" class="lg:hidden text-2xl text-slate-400 hover:text-white">&times;</button>
                </div>
                <nav class="flex-grow px-4 py-4 overflow-y-auto">
                    <a href="#" id="nav-home" class="sidebar-link flex items-center px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('home')">
                        <i class="fas fa-home w-6 text-center"></i><span class="ml-3">Home</span>
                    </a>
                    <a href="#" id="nav-statusTruck" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('statusTruck')">
                        <i class="fas fa-eye w-6 text-center"></i><span class="ml-3">Status Truck</span>
                    </a>
                    <a href="#" id="nav-updateStatus" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('updateStatus')">
                        <i class="fas fa-edit w-6 text-center"></i><span class="ml-3">Update Status Truck</span>
                    </a>
                    <a href="#" id="nav-listTruck" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('listTruck')">
                        <i class="fas fa-list-ul w-6 text-center"></i><span class="ml-3">Update List Truck</span>
                    </a>
                    <a href="#" id="nav-updateDimensi" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('updateDimensi')">
                        <i class="fas fa-ruler-combined w-6 text-center"></i><span class="ml-3">Update Dimensi</span>
                    </a>
                    <a href="#" id="nav-ritaseTruck" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('ritaseTruck')">
                        <i class="fas fa-route w-6 text-center"></i><span class="ml-3">Ritase Truck</span>
                    </a>
                    <a href="#" id="nav-summaryReport" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('summaryReport')">
                        <i class="fas fa-chart-pie w-6 text-center"></i><span class="ml-3">Summary Report</span>
                    </a>
                </nav>
            </aside>

            <div class="flex-1 flex flex-col h-full overflow-hidden">
                <header class="bg-white shadow-md flex-shrink-0 z-10">
                    <div class="flex h-16 items-center justify-between px-4 lg:px-8">
                        <div class="flex items-center">
                            <button id="sidebar-open-btn" class="lg:hidden text-2xl mr-4 text-slate-600">
                                <i class="fas fa-bars"></i>
                            </button>
                            <h2 id="page-title" class="text-xl lg:text-2xl font-bold text-slate-700 whitespace-nowrap">Home</h2>
                        </div>
                        <div class="flex items-center gap-2 lg:gap-4">
                             <div id="angkutanNameDisplay" class="text-xs sm:text-sm font-medium text-indigo-600 text-right"></div>
                             <button id="logoutButton" class="bg-slate-200 text-slate-800 font-semibold px-3 py-2 lg:px-4 rounded-lg shadow-sm hover:bg-slate-300 text-sm">Logout</button>
                        </div>
                    </div>
                </header>

                <main class="flex-1 overflow-x-hidden overflow-y-auto p-4 md:p-6 lg:p-8">   
                    <div id="home" class="content-section">
                        <div class="mb-8 p-6 bg-white rounded-xl shadow-md">
                            <h2 id="welcome-title" class="text-2xl font-bold text-slate-800">Selamat Datang!</h2>
                            <p id="current-date" class="text-slate-500"></p>
                        </div>
                    
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                            <div class="bg-indigo-600 text-white p-6 rounded-xl shadow-lg flex items-center">
                                <div class="p-4 bg-indigo-500 rounded-full">
                                    <i class="fas fa-truck text-3xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p id="total-truck-title" class="font-semibold">Total Truk</p>
                                    <p id="total-truck-count" class="text-3xl font-bold">0</p>
                                </div>
                            </div>
                        
                            <div class="bg-orange-600 text-white p-6 rounded-xl shadow-lg flex items-center">
                                <div class="p-4 bg-orange-500 rounded-full">
                                    <i class="fas fa-route text-3xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="font-semibold">Sudah Alokasi</p>
                                    <p id="active-truck-count" class="text-3xl font-bold">0</p>
                                </div>
                            </div>
                            <div class="bg-slate-700 text-white p-6 rounded-xl shadow-lg flex items-center">
                                <div class="p-4 bg-slate-600 rounded-full">
                                    <i class="fas fa-check-circle text-3xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="font-semibold">Belum Alokasi</p>
                                    <p id="available-truck-count" class="text-3xl font-bold">0</p>
                                </div>
                            </div>

                        </div>
                    
                        <div>
                            <h3 class="text-xl font-bold text-slate-700 mb-4">Rincian Status Armada</h3>
                            <div id="status-details-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                                </div>
                        </div>
                    </div>

                    <div id="statusTruck" class="content-section"><div id="readOnlyTruckList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
                    
                    <div id="updateStatus" class="content-section"><div id="truckListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
                    
                    <div id="listTruck" class="content-section">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                            <button class="flex items-center gap-2 bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700" onclick="window.toggleAddForm()"><i class="fas fa-plus"></i> Tambah Data</button>
                            <div class="relative w-full md:w-1/3"><span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-slate-400"></i></span><input type="text" id="searchInput" onkeyup="window.filterTable()" placeholder="Cari data truk..." class="w-full p-2 pl-10 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                        </div>
                        
                        <form class="add-form hidden bg-white p-6 rounded-xl shadow-md mb-6" id="addForm">
                            <h4 class="text-xl font-bold text-slate-700 mb-4">Tambah Truk Baru</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input type="text" id="newNoMobil" placeholder="Plat Nomor" class="w-full p-2 border border-slate-300 rounded-lg" oninput="this.value = this.value.toUpperCase()">
                                <select id="newJenisMobil" class="w-full p-2 border border-slate-300 rounded-lg">
                                    </select>
                                <input type="text" id="newNamaDriver" placeholder="Nama Driver" class="w-full p-2 border border-slate-300 rounded-lg" oninput="this.value = this.value.toUpperCase()">
                                <input type="text" id="newNoHp" placeholder="No HP Driver" class="w-full p-2 border border-slate-300 rounded-lg">
                                <div class="flex items-center gap-2 md:col-start-3">
                                    <button type="button" class="w-full bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700" onclick="window.addTruck()">Simpan</button>
                                    <button type="button" class="w-full bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg" onclick="window.toggleAddForm()">Batal</button>
                                </div>
                            </div>
                        </form>

                        <div class="bg-white rounded-xl shadow-md overflow-x-auto">
                            <table id="truckTable" class="w-full text-sm text-left text-slate-600">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                    <tr>
                                        <th class="px-6 py-3">Plat Nomor</th>
                                        <th class="px-6 py-3">Jenis Truck</th>
                                        <th class="px-6 py-3">Nama Driver</th>
                                        <th class="px-6 py-3">No HP</th>
                                        <th class="px-6 py-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div id="truckTablePagination" class="mt-4 flex justify-center items-center gap-2"></div>
                    </div>
                    
                    <div id="updateDimensi" class="content-section">
                        <div class="bg-white rounded-xl shadow-md overflow-x-auto">
                            <table class="w-full text-sm text-left"><thead class="text-xs uppercase bg-slate-100"><tr><th class="px-6 py-3">Plat Nomor</th><th class="px-6 py-3">Jenis Truck</th><th class="px-6 py-3">Panjang (cm)</th><th class="px-6 py-3">Lebar (cm)</th><th class="px-6 py-3">Tinggi (cm)</th><th class="px-6 py-3">Kubikasi (m³)</th><th class="px-6 py-3">Aksi</th></tr></thead><tbody id="dimensiTableBody"></tbody></table>
                        </div>
                    </div>

                    <div id="ritaseTruck" class="content-section">
                        <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Filter Berdasarkan Tanggal Selesai</h4>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                <div>
                                    <label for="ritaseStartDate" class="block text-sm font-medium text-slate-600 mb-1">Dari Tanggal</label>
                                    <input type="date" id="ritaseStartDate" class="w-full p-2 border border-slate-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="ritaseEndDate" class="block text-sm font-medium text-slate-600 mb-1">Sampai Tanggal</label>
                                    <input type="date" id="ritaseEndDate" class="w-full p-2 border border-slate-300 rounded-lg">
                                </div>
                                <div class="flex gap-2">
                                    <button id="applyDateFilterBtn" class="w-full bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700">
                                        <i class="fas fa-filter mr-2"></i>Terapkan
                                    </button>
                                    <button id="resetDateFilterBtn" class="w-full bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300">
                                        Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end items-center gap-2 mb-4">
                            <button onclick="window.exportRitaseToExcel()" class="flex items-center gap-2 bg-green-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                                <i class="fas fa-file-excel"></i> Export Excel
                            </button>
                            <button onclick="window.exportRitaseToPdf()" class="flex items-center gap-2 bg-red-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-700 text-sm">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                        </div>
                        <div class="bg-white rounded-xl shadow-md overflow-x-auto">
                            <table id="ritaseTable" class="w-full text-sm text-left text-slate-600">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                    <tr>
                                        <th class="px-6 py-3">PLAT NOMOR</th>
                                        <th class="px-6 py-3">JENIS TRUCK</th>
                                        <th class="px-6 py-3">NAMA DRIVER</th>
                                        <th class="px-6 py-3">CUSTOMER</th>
                                        <th class="px-6 py-3">KOTA</th>
                                        <th class="px-6 py-3">QTY</th>
                                        <th class="px-6 py-3">JADWAL BONGKAR</th>
                                        <th class="px-6 py-3 whitespace-nowrap">TIBA MUAT</th>
                                        <th class="px-6 py-3 whitespace-nowrap">KELUAR MUAT</th>
                                        <th class="px-6 py-3 whitespace-nowrap">TIBA BONGKAR</th>
                                        <th class="px-6 py-3 whitespace-nowrap">KELUAR BONGKAR</th>
                                        <th class="px-6 py-3">TANGGAL SELESAI</th>
                                        <th class="px-6 py-3">LAMA INAP</th>
                                        <th class="px-6 py-3">FO/DN</th>
                                    </tr>
                                </thead>
                                <tbody id="ritaseTableBody"></tbody>
                            </table>
                        </div>
                        <div id="ritaseTablePagination" class="mt-4 flex justify-center items-center gap-2"></div>
                    </div>

                    <div id="summaryReport" class="content-section">
                        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Filter Laporan</h4>
                            <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                                <h4 class="text-lg font-semibold text-slate-700 mb-4">Filter Laporan</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label for="summaryFilterJenisMobil" class="block text-sm font-medium text-slate-600 mb-1">Jenis Mobil</label>
                                        <select id="summaryFilterJenisMobil" class="w-full p-2 border border-slate-300 rounded-lg"></select>
                                    </div>
                                    <div>
                                        <label for="summaryFilterStatus" class="block text-sm font-medium text-slate-600 mb-1">Status</label>
                                        <select id="summaryFilterStatus" class="w-full p-2 border border-slate-300 rounded-lg"></select>
                                    </div>
                                    <div>
                                        <label for="summaryFilterCustomer" class="block text-sm font-medium text-slate-600 mb-1">Customer</label>
                                        <select id="summaryFilterCustomer" class="w-full p-2 border border-slate-300 rounded-lg">
                                            <option value="all">Semua Customer</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md" id="summaryReportContainer">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                                <div>
                                    <h4 class="text-xl font-bold text-slate-800">Summary Report</h4>
                                    <p id="export-timestamp" class="text-sm text-slate-500">Data saat ini</p>
                                </div>
                                <div class="flex items-center gap-2 flex-wrap">
                                    <button onclick="window.exportToExcel()" class="flex items-center gap-2 bg-green-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                                        <i class="fas fa-file-excel"></i> Export Excel
                                    </button>
                                    <button onclick="window.exportToPdf()" class="flex items-center gap-2 bg-red-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-700 text-sm">
                                        <i class="fas fa-file-pdf"></i> Export PDF
                                    </button>
                                    <button onclick="window.exportAsImage()" class="flex items-center gap-2 bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">
                                        <i class="fas fa-image"></i> Export Gambar
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table id="summaryTable" class="w-full text-sm text-left">
                                    <thead class="text-xs uppercase bg-slate-100">
                                        <tr>
                                            <th class="px-6 py-3">FO/DN</th>
                                            <th class="px-6 py-3">QTY (KG)</th> 
                                            <th class="px-6 py-3">JADWAL BONGKAR</th>
                                            <th class="px-6 py-3">TIBA LOKASI MUAT</th>
                                            <th class="px-6 py-3">KELUAR LOKASI MUAT</th>
                                            <th class="px-6 py-3">TIBA LOKASI BONGKAR</th>
                                            <th class="px-6 py-3">KELUAR LOKASI BONGKAR</th>
                                            <th class="px-6 py-3">NAMA CUSTOMER</th>
                                            <th class="px-6 py-3">KOTA</th>
                                            <th class="px-6 py-3">STATUS</th>
                                            <th class="px-6 py-3">NAMA DRIVER</th>
                                            <th class="px-6 py-3">NO HP</th>
                                            <th class="px-6 py-3">PLAT NOMOR</th>
                                            <th class="px-6 py-3">JENIS MOBIL</th>
                                        </tr>
                                    </thead>
                                    <tbody id="summaryTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    </main>
                <footer class="text-center p-4 text-sm text-slate-500 mt-auto bg-white border-t">&copy; <span id="copyright-year"></span> Jagaddhita Arya Koswara - Logistik IKK</footer>
            </div>
        </div>
    </div>

    <div id="status-modal" class="modal-overlay hidden" onclick="window.closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="modal-close" onclick="window.closeModal()">&times;</span>
            <h3 id="modal-title" class="text-2xl font-bold text-slate-800 mb-4">Daftar Truk</h3>
            <div class="flex items-center gap-4 mb-4">
                <input type="text" id="modalSearchInput" placeholder="Cari..." class="w-full p-2 border border-slate-300 rounded-lg" oninput="window.applyModalFiltersAndSort()">
            </div>
            <div class="modal-body">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                        <tr>
                            <th class="px-4 py-3" data-sort="no_mobil" onclick="window.sortModalTable('no_mobil')">Plat Nomor</th>
                            <th class="px-4 py-3" data-sort="nama_driver" onclick="window.sortModalTable('nama_driver')">Nama Driver</th>
                            <th class="px-4 py-3" data-sort="no_hp" onclick="window.sortModalTable('no_hp')">No HP</th>
                            <th class="px-4 py-3" data-sort="jenis_mobil" onclick="window.sortModalTable('jenis_mobil')">Jenis Truck</th>
                            <th class="px-4 py-3">Dimensi (cm)</th>
                            <th class="px-4 py-3">Kubikasi (m³)</th>
                        </tr>
                    </thead>
                    <tbody id="modal-truck-list"></tbody>
                </table>
            </div>
        </div>
    </div>


    <div id="inap-status-modal" class="modal-overlay hidden" onclick="window.closeInapStatusModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="modal-close" onclick="window.closeInapStatusModal()">&times;</span>
        <h3 id="inap-modal-title" class="text-2xl font-bold text-slate-800 mb-4">Daftar Truk Inap</h3>
        <div class="modal-body">
            <table class="w-full text-sm text-left text-slate-600">
                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                    <tr>
                        <th class="px-4 py-3" data-sort="angkutan" onclick="window.sortInapModalTable('angkutan')">Angkutan</th>
                        <th class="px-4 py-3" data-sort="no_mobil" onclick="window.sortInapModalTable('no_mobil')">Plat Nomor</th>
                        <th class="px-4 py-3" data-sort="customer" onclick="window.sortInapModalTable('customer')">Nama Customer</th>
                        <th class="px-4 py-3" data-sort="tujuan" onclick="window.sortInapModalTable('tujuan')">Kota</th>
                        <th class="px-4 py-3" data-sort="leadTimeMinutes" onclick="window.sortInapModalTable('leadTimeMinutes')">Lead Time</th>
                    </tr>
                </thead>
                <tbody id="inap-modal-truck-list">
                    </tbody>
            </table>
        </div>
    </div>
    </div>


    <div id="header-filter-popup" class="header-filter-popup hidden">
    
    <div id="inap-status-modal" class="modal-overlay hidden" onclick="window.closeInapStatusModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="modal-close" onclick="window.closeInapStatusModal()">&times;</span>
        <h3 id="inap-modal-title" class="text-2xl font-bold text-slate-800 mb-4">Daftar Truk Inap</h3>
        <div class="modal-body">
            <table class="w-full text-sm text-left text-slate-600">
                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                    <tr>
                        <th class="px-4 py-3" data-sort="angkutan" onclick="window.sortInapModalTable('angkutan')">Angkutan</th>
                        <th class="px-4 py-3" data-sort="no_mobil" onclick="window.sortInapModalTable('no_mobil')">Plat Nomor</th>
                        <th class="px-4 py-3" data-sort="customer" onclick="window.sortInapModalTable('customer')">Nama Customer</th>
                        <th class="px-4 py-3" data-sort="tujuan" onclick="window.sortInapModalTable('tujuan')">Kota</th>
                        <th class="px-4 py-3" data-sort="leadTimeMinutes" onclick="window.sortInapModalTable('leadTimeMinutes')">Lama Inap</th>
                    </tr>
                </thead>
                <tbody id="inap-modal-truck-list">
                    </tbody>
            </table>
            </div>
    </div>
    </div>
        

        <input type="text" id="filter-search" class="w-full p-2 border border-slate-300 rounded-md mb-2" placeholder="Cari opsi...">
        <div id="filter-options" class="filter-options"></div>
        <div class="flex justify-end gap-2 pt-2 border-t">
            <button id="apply-filter-btn" class="bg-indigo-600 text-white px-3 py-1 rounded-md text-sm font-semibold">Terapkan</button>
            <button id="clear-filter-btn" class="bg-slate-200 px-3 py-1 rounded-md text-sm">Hapus Filter</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, updateDoc, query, where, getDoc, addDoc, serverTimestamp, getDocs, orderBy, deleteDoc, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth, currentUserData, unsubscribeFromTrucks, unsubscribeFromCustomers, unsubscribeFromJenisTruck;
        let trucksData = [];
        let customersData = [];
        let jenisTruckData = [];
        let allRitaseData = [];
        let ritaseSort = { column: 'timestamp_selesai', direction: 'desc' };
        let activeFilters = {};
        let currentModalTrucks = [];
        let modalSort = { column: 'no_mobil', direction: 'asc' };
        let currentFilterColumn = null;
        const appId = 'truck-dashboard-app';


        // --- TAMBAHKAN BARIS INI ---
        window.customerTypeMap = new Map();
        // --- BATAS TAMBAHAN ---

        // --- TAMBAHKAN FUNGSI BARU INI ---
        function getDynamicStatus(truck) {
            if (!truck) return 'N/A';
            const originalStatus = truck.keterangan;

            if (originalStatus !== 'INAP' && originalStatus !== 'ANTRI BONGKAR') {
                return originalStatus;
            }
            
            const customerName = truck.customer;
            if (!customerName) {
                return `${originalStatus} (Lainnya)`; 
            }

            const customerType = window.customerTypeMap.get(customerName);
            
            if (originalStatus === 'INAP') { // Handle INAP
                if (customerType === 'BU17') return 'INAP BU17';
                if (customerType === 'CMI') return 'INAP CMI';
                return 'INAP (Lainnya)';
            }
            
            // [PERBAIKAN] Handle ANTRI BONGKAR dengan nama baru
            if (originalStatus === 'ANTRI BONGKAR') { 
                if (customerType === 'BU17') return 'ANTRI BU17'; // <-- REVISI
                if (customerType === 'CMI') return 'ANTRI CMI';   // <-- REVISI
                return 'ANTRI BONGKAR (Lainnya)';
            }
        }
        // --- BATAS FUNGSI BARU ---


        // --- TAMBAHKAN SEMUA KODE BARU DI BAWAH INI ---

        // Variabel global baru untuk modal 'Lama Inap'
        let currentInapModalTrucks = []; 
        let inapModalSort = { column: 'leadTimeMinutes', direction: 'desc' };

        // --- Fungsi untuk Modal LAMA (status-modal) ---
        
        window.closeModal = () => {
            document.getElementById('status-modal').classList.add('hidden');
        }

        function renderModalTable(trucksToRender) {
            const modalList = document.getElementById('modal-truck-list');
            modalList.innerHTML = '';
            if (!trucksToRender || trucksToRender.length === 0) {
                modalList.innerHTML = '<tr><td colspan="7" class="text-center p-6 text-slate-500">Tidak ada truk yang cocok.</td></tr>';
                return;
            }
            trucksToRender.forEach(truck => {
                const p = truck.panjang || 0, l = truck.lebar || 0, t = truck.tinggi || 0;
                const dimensi = `${p}×${l}×${t}`;
                const kubikasi = (p * l * t / 1000000).toFixed(2);
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                    <td class="px-4 py-3">${truck.no_mobil || '-'}</td>
                    <td class="px-4 py-3">${truck.nama_driver || '-'}</td>
                    <td class="px-4 py-3">${truck.no_hp || '-'}</td>
                    <td class="px-4 py-3">${truck.jenis_mobil || '-'}</td>
                    <td class="px-4 py-3">${dimensi}</td>
                    <td class="px-4 py-3 font-semibold">${kubikasi} m³</td>
                `;
                modalList.appendChild(row);
            });
        }
        
        window.applyModalFiltersAndSort = () => {
            const searchTerm = document.getElementById('modalSearchInput').value.toLowerCase();
            let filtered = [...currentModalTrucks];
            if (searchTerm) {
                filtered = filtered.filter(truck => Object.values(truck).some(val => String(val).toLowerCase().includes(searchTerm)));
            }
            filtered.sort((a, b) => {
                const valA = a[modalSort.column] || '';
                const valB = b[modalSort.column] || '';
                const comparison = valA.localeCompare(valB, undefined, { numeric: true });
                return modalSort.direction === 'asc' ? comparison : -comparison;
            });
            renderModalTable(filtered);
        }

        window.sortModalTable = (column) => {
            if (modalSort.column === column) {
                modalSort.direction = modalSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                modalSort.column = column;
                modalSort.direction = 'asc';
            }
            applyModalFiltersAndSort();
        };

        // --- Fungsi untuk Modal BARU (inap-status-modal) ---
        
        window.closeInapStatusModal = () => {
            document.getElementById('inap-status-modal').classList.add('hidden');
        }

        function showInapStatusModal(status) {
            const modal = document.getElementById('inap-status-modal');
            const modalTitle = document.getElementById('inap-modal-title');
            
            modalTitle.textContent = `Daftar Truk: ${status}`;

            let filteredTrucks;
            if (status === 'INAP BU17') {
                filteredTrucks = trucksData.filter(truck => 
                    truck.keterangan === 'INAP' && getDynamicStatus(truck) === 'INAP BU17'
                );
            } else if (status === 'INAP CMI') {
                filteredTrucks = trucksData.filter(truck => 
                    truck.keterangan === 'INAP' && getDynamicStatus(truck) === 'INAP CMI'
                );
            } else if (status === 'INAP (Lainnya)') {
                 filteredTrucks = trucksData.filter(truck => 
                    truck.keterangan === 'INAP' && getDynamicStatus(truck) === 'INAP (Lainnya)'
                );
            } else if (status === 'ANTRI BU17') { 
                filteredTrucks = trucksData.filter(truck => 
                    truck.keterangan === 'ANTRI BONGKAR' && getDynamicStatus(truck) === 'ANTRI BU17'
                );
            } else if (status === 'ANTRI CMI') { 
                filteredTrucks = trucksData.filter(truck => 
                    truck.keterangan === 'ANTRI BONGKAR' && getDynamicStatus(truck) === 'ANTRI CMI'
                );
            } else { 
                 filteredTrucks = trucksData.filter(truck => 
                    truck.keterangan === 'ANTRI BONGKAR' && getDynamicStatus(truck) === 'ANTRI BONGKAR (Lainnya)'
                );
            }

            currentInapModalTrucks = filteredTrucks.map(truck => {
                return {
                    ...truck,
                    leadTimeFormatted: calculateLeadTime(truck.tiba_lokasi_bongkar),
                    leadTimeMinutes: calculateLeadTimeInMinutes(truck.tiba_lokasi_bongkar)
                };
            });

            inapModalSort = { column: 'leadTimeMinutes', direction: 'desc' };
            renderInapModalTable();
            modal.classList.remove('hidden');
        }

        function renderInapModalTable() {
            const modalList = document.getElementById('inap-modal-truck-list');
            modalList.innerHTML = '';

            const sortedData = [...currentInapModalTrucks].sort((a, b) => {
                const col = inapModalSort.column;
                const dir = inapModalSort.direction === 'asc' ? 1 : -1;
                const valA = a[col] || (col === 'leadTimeMinutes' ? 0 : '');
                const valB = b[col] || (col === 'leadTimeMinutes' ? 0 : '');
                if (typeof valA === 'number' && typeof valB === 'number') {
                    return (valA - valB) * dir;
                }
                return String(valA).localeCompare(String(valB), undefined, { numeric: true }) * dir;
            });

            if (sortedData.length === 0) {
                modalList.innerHTML = '<tr><td colspan="5" class="text-center p-6 text-slate-500">Tidak ada truk yang cocok.</td></tr>';
                return;
            }

            sortedData.forEach(truck => {
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                    <td class="px-4 py-3">${truck.angkutan || '-'}</td>
                    <td class="px-4 py-3">${truck.no_mobil || '-'}</td>
                    <td class="px-4 py-3">${truck.customer || '-'}</td>
                    <td class="px-4 py-3">${truck.tujuan || '-'}</td>
                    <td class="px-4 py-3 font-semibold">${truck.leadTimeFormatted || '-'}</td>
                `;
                modalList.appendChild(row);
            });
        }

        window.sortInapModalTable = (column) => {
            if (inapModalSort.column === column) {
                inapModalSort.direction = inapModalSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                inapModalSort.column = column;
                inapModalSort.direction = 'asc';
            }
            renderInapModalTable();
        };

        // --- Fungsi 'Router' (INI ADALAH FUNGSI STEP 5 YANG HILANG) ---
        
        window.showTrucksByStatus = (status) => {
            // Logika untuk mengarahkan ke modal yang benar
            if (status.startsWith('INAP') || status === 'ANTRI BU17' || status === 'ANTRI CMI' || status === 'ANTRI BONGKAR (Lainnya)') {
                showInapStatusModal(status);
                return; 
            }

            // Logika untuk status normal (non-inap)
            const modal = document.getElementById('status-modal');
            const modalTitle = document.getElementById('modal-title');
            
            modalTitle.textContent = `Daftar Truk: ${status}`;

            if (status === 'UNKNOWN') {
                const knownStatuses = [...statusOptions, 'INAP', 'ANTRI BONGKAR']; 
                currentModalTrucks = trucksData.filter(truck => {
                    const s = truck.keterangan;
                    if (!s) return true; 
                    return !knownStatuses.includes(s);
                });
            } else {
                currentModalTrucks = trucksData.filter(truck => truck.keterangan === status);
            }

            const searchInput = document.getElementById('modalSearchInput');
            searchInput.value = '';

            modalSort = { column: 'no_mobil', direction: 'asc' };
            applyModalFiltersAndSort();
            modal.classList.remove('hidden');
        }

        // --- BATAS KODE BARU ---

        const statusOptions = ['TERSEDIA', 'OTW MILL', 'ANTRI MUAT', 'OTW CUSTOMER', 'ANTRI BONGKAR', 'INAP', 'STORING', 'NO DRIVER'];
        const statusInfo = { 'TERSEDIA': { icon: 'fa-check-circle', color: 'slate' }, 'OTW MILL': { icon: 'fa-truck-loading', color: 'purple' }, 'ANTRI MUAT': { icon: 'fa-clock', color: 'cyan' }, 'OTW CUSTOMER': { icon: 'fa-road', color: 'green' }, 'ANTRI BONGKAR': { icon: 'fa-hourglass-half', color: 'yellow' }, 'INAP': { icon: 'fa-bed', color: 'orange' }, 'STORING': { icon: 'fa-tools', color: 'red' }, 'NO DRIVER': { icon: 'fa-user-slash', color: 'rose' } };
        const statusBadgeMap = { 'TERSEDIA': 'bg-slate-100 text-slate-800', 'OTW MILL': 'bg-purple-100 text-purple-800', 'ANTRI MUAT': 'bg-cyan-100 text-cyan-800', 'OTW CUSTOMER': 'bg-green-100 text-green-800', 'ANTRI BONGKAR': 'bg-yellow-100 text-yellow-800', 'INAP': 'bg-orange-100 text-orange-800', 'STORING': 'bg-red-100 text-red-800', 'NO DRIVER': 'bg-rose-100 text-rose-800' };

        const dataToReset = { 
            keterangan: "TERSEDIA", fo: "", customer: "", tujuan: "", waktu: "",
            tiba_lokasi_muat: "", keluar_lokasi_muat: "", tiba_lokasi_bongkar: "", keluar_lokasi_bongkar: "", qty: "", jadwal_bongkar: "" 
        };

        // PAGINATION STATE
        let paginationState = {
            listTruck: { currentPage: 1, filteredData: [] },
            ritaseTruck: { currentPage: 1, filteredData: [] }
        };
        const rowsPerPage = 15;

        function showSuccessAlert(title, text) {
            Swal.fire({
                icon: 'success',
                title: title,
                text: text,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        }

        function showErrorAlert(title, text) {
            Swal.fire({
                icon: 'error',
                title: title,
                text: text,
                confirmButtonColor: '#ef4444' // red-500
            });
        }

        function showConfirmAlert(title, text, confirmButtonText, callback) {
            Swal.fire({
                title: title,
                text: text,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#4f46e5', // indigo-600
                cancelButtonColor: '#6b7280', // gray-500
                confirmButtonText: confirmButtonText || 'Ya, Lanjutkan!'
            }).then((result) => {
                if (result.isConfirmed) {
                    callback(true);
                } else {
                    callback(false);
                }
            });
        }
        
        function calculateLeadTimeInMinutes(startTimeString) {
            if (!startTimeString) return 0;
            const startTime = new Date(startTimeString);
            const now = new Date();
            const diff = now - startTime;
            if (isNaN(diff) || diff < 0) return 0;
            return Math.floor(diff / (1000 * 60));
        }

        function calculateLeadTime(startTimeString) {
            if (!startTimeString) return '-';
            const startTime = new Date(startTimeString);
            const now = new Date();
            let diff = now - startTime;
            if (isNaN(diff) || diff < 0) return 'Invalid Time';
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            diff -= days * (1000 * 60 * 60 * 24);
            const hours = Math.floor(diff / (1000 * 60 * 60));
            diff -= hours * (1000 * 60 * 60);
            const minutes = Math.floor(diff / (1000 * 60));
            let result = [];
            if (days > 0) result.push(`${days} Hari`);
            if (hours > 0) result.push(`${hours} Jam`);
            if (minutes > 0) result.push(`${minutes} Menit`);
            return result.length > 0 ? result.join(' ') : 'Kurang dari semenit';
        }
        function formatTanggalJam(isoString) {
            if (!isoString || !isoString.includes('T')) { return '-'; }
            const [tanggalPart, jamPart] = isoString.split('T');
            if (!tanggalPart || !jamPart) { return '-'; }
            const [tahun, bulan, tanggal] = tanggalPart.split('-');
            if (!tahun || !bulan || !tanggal) { return '-'; }
            return `${tanggal}/${bulan}/${tahun}, ${jamPart}`;
        }
        
        function isValidTimeFlow(t1, t2) {
             if (!t1 || !t2) return true; 
             const time1 = new Date(t1);
             const time2 = new Date(t2);
             return time1 <= time2;
        }


        const firebaseConfig = {
          apiKey: "AIzaSyBQYgVCVzHwBk-Am3MB425FdRXkV4U8bBw", authDomain: "truck-kontrak.firebaseapp.com", projectId: "truck-kontrak",
          storageBucket: "truck-kontrak.firebasestorage.app", messagingSenderId: "198359286959", appId: "1:198359286959:web:5d672f88d73ed05ab9805a", measurementId: "G-V2G0NSDVVB"
        };
        try { const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); } catch(e) { console.error("Firebase Init Error:", e); }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const userDocSnap = await getDoc(doc(db, "users", user.uid));
                    if (userDocSnap.exists() && userDocSnap.data().role === 'angkutan') {
                        if (unsubscribeFromTrucks) unsubscribeFromTrucks();
                        if (unsubscribeFromCustomers) unsubscribeFromCustomers();
                        if (unsubscribeFromJenisTruck) unsubscribeFromJenisTruck();
                        
                        trucksData = []; allRitaseData = []; activeFilters = {};
                        
                        currentUserData = userDocSnap.data();
                        document.getElementById('angkutanNameDisplay').textContent = currentUserData.angkutanName;
                        
                        setupCustomerListener();
                        setupJenisTruckListener();
                        setupTrucksListener(currentUserData.angkutanName);

                        document.getElementById('loading-container').classList.add('hidden');
                        document.getElementById('login-container').classList.add('hidden');
                        document.getElementById('dashboard-container').classList.remove('hidden');
                        window.showContent('home');
                    } else { 
                        if (unsubscribeFromTrucks) unsubscribeFromTrucks();
                        if (unsubscribeFromCustomers) unsubscribeFromCustomers();
                        if (unsubscribeFromJenisTruck) unsubscribeFromJenisTruck();
                        await signOut(auth); 
                    }
                } catch (error) { 
                    if (unsubscribeFromTrucks) unsubscribeFromTrucks();
                    if (unsubscribeFromCustomers) unsubscribeFromCustomers();
                    if (unsubscribeFromJenisTruck) unsubscribeFromJenisTruck();
                    await signOut(auth); 
                }
            } else {
                if (unsubscribeFromTrucks) unsubscribeFromTrucks();
                if (unsubscribeFromCustomers) unsubscribeFromCustomers();
                if (unsubscribeFromJenisTruck) unsubscribeFromJenisTruck();
                document.getElementById('loading-container').classList.add('hidden');
                document.getElementById('dashboard-container').classList.add('hidden');
                document.getElementById('login-container').classList.remove('hidden');
            }
        });

        function renderPagination(containerId, pageStateKey, renderFunction) {
            const container = document.getElementById(containerId);
            const { currentPage, filteredData } = paginationState[pageStateKey];
            container.innerHTML = '';
            
            const totalItems = filteredData.length;
            if (totalItems <= rowsPerPage) return;

            const totalPages = Math.ceil(totalItems / rowsPerPage);

            const createButton = (text, page, disabled = false) => {
                const button = document.createElement('button');
                button.innerHTML = text;
                button.disabled = disabled;
                button.className = `pagination-btn px-3 py-1 border rounded-md text-sm font-medium transition ${disabled ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-white hover:bg-slate-50'}`;
                
                if (page === currentPage && text !== '...' && !String(text).includes('i')) {
                    button.classList.add('active');
                }
                
                button.onclick = () => {
                    paginationState[pageStateKey].currentPage = page;
                    renderFunction();
                };
                return button;
            };

            // Previous button
            container.appendChild(createButton('<i class="fas fa-chevron-left"></i>', currentPage - 1, currentPage === 1));

            // Page numbers
            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) {
                    container.appendChild(createButton(i, i));
                }
            } else {
                container.appendChild(createButton(1, 1));
                if (currentPage > 3) container.appendChild(createButton('...', currentPage - 2, true));
                
                let startPage = Math.max(2, currentPage - 1);
                let endPage = Math.min(totalPages - 1, currentPage + 1);

                if (currentPage <= 3) {
                    endPage = 4;
                }
                if (currentPage >= totalPages - 2) {
                    startPage = totalPages - 3;
                }

                for (let i = startPage; i <= endPage; i++) {
                    container.appendChild(createButton(i, i));
                }

                if (currentPage < totalPages - 2) container.appendChild(createButton('...', currentPage + 2, true));
                container.appendChild(createButton(totalPages, totalPages));
            }

            // Next button
            container.appendChild(createButton('<i class="fas fa-chevron-right"></i>', currentPage + 1, currentPage === totalPages));
        }

        function setupCustomerListener() {
            const customersRef = query(collection(db, "customers"), orderBy("name"));
            unsubscribeFromCustomers = onSnapshot(customersRef, (snapshot) => {

                window.customerTypeMap.clear(); // Bersihkan map lama
                customersData = snapshot.docs.map(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    window.customerTypeMap.set(data.name, data.customer_type); // Isi map
                    return data;
                });

                // --- TAMBAHAN PENTING ---
                // Panggil ulang semua render yang bergantung pada map ini
                // Cek dulu apakah data truk sudah ada
                if (trucksData && trucksData.length > 0) {
                    if (document.getElementById('home').classList.contains('active')) {
                         renderHomePage(trucksData);
                    }
                    if (document.getElementById('statusTruck').classList.contains('active')) {
                        displayStatusCards(trucksData);
                    }
                    if (document.getElementById('summaryReport').classList.contains('active')) {
                        renderSummaryReport();
                    }
                }
                
                if (document.getElementById('updateStatus').classList.contains('active')) {
                    rerenderUpdateStatusCards();
                }
            });
        }

        function setupJenisTruckListener() {
            const jenisTruckRef = query(collection(db, "jenis_truck"), orderBy("name"));
            unsubscribeFromJenisTruck = onSnapshot(jenisTruckRef, (snapshot) => {
                jenisTruckData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateJenisTruckDropdowns();
            });
        }

        function populateJenisTruckDropdowns() {
            const newJenisMobilSelect = document.getElementById('newJenisMobil');
            if (newJenisMobilSelect) {
                let optionsHtml = '';
                jenisTruckData.forEach(jenis => {
                    optionsHtml += `<option value="${jenis.name}">${jenis.name}</option>`;
                });
                newJenisMobilSelect.innerHTML = optionsHtml;
            }

            const editingSelect = document.querySelector('td[data-field="jenis_mobil"] select');
            if (editingSelect) {
                const selectedValue = editingSelect.value;
                let optionsHtml = '';
                jenisTruckData.forEach(jenis => {
                    const isSelected = jenis.name === selectedValue ? 'selected' : '';
                    optionsHtml += `<option value="${jenis.name}" ${isSelected}>${jenis.name}</option>`;
                });
                editingSelect.innerHTML = optionsHtml;
            }
        }

        function setupTrucksListener(angkutanName) {
            const trucksCollectionRef = collection(db, `artifacts/${appId}/public/data/trucks`);
            const q = query(trucksCollectionRef, where("angkutan", "==", angkutanName));
            unsubscribeFromTrucks = onSnapshot(q, (snapshot) => {
                trucksData = snapshot.docs.map(doc => ({ ...doc.data(), firestoreId: doc.id }));
                
                populateSummaryFilters();
                renderHomePage(trucksData);
                displayStatusCards(trucksData);
                displayDimensiTable(trucksData);

                if (document.getElementById('updateStatus').classList.contains('active')) {
                   rerenderUpdateStatusCards();
                }

                if (document.getElementById('listTruck').classList.contains('active')) {
                    filterTable();
                }
                
                if (document.getElementById('summaryReport').classList.contains('active')) {
                    renderSummaryReport();
                }
            }, (error) => console.error("Gagal mengambil data truk: ", error));
        }

        function rerenderUpdateStatusCards() {
             const container = document.getElementById('truckListContainer');
             container.innerHTML = '';
             trucksData.forEach(truck => container.appendChild(createTruckCard(truck)));

             if (trucksData.length === 0) {
                 container.innerHTML = `<p class="text-slate-500 col-span-full text-center">Tidak ada data truk yang perlu diperbarui.</p>`;
             }
        }

        function populateSummaryFilters() {
            const jenisMobilSelect = document.getElementById('summaryFilterJenisMobil');
            const statusSelect = document.getElementById('summaryFilterStatus');
            const customerSelect = document.getElementById('summaryFilterCustomer'); // <--- BARU
            
            // Populate Jenis Mobil
            const uniqueJenisMobil = [...new Set(jenisTruckData.map(j => j.name))].sort();
            jenisMobilSelect.innerHTML = '<option value="all">Semua Jenis</option>';
            uniqueJenisMobil.forEach(j => jenisMobilSelect.innerHTML += `<option value="${j}">${j}</option>`);
            
            // Populate Status
            statusSelect.innerHTML = '<option value="all">Semua Status</option>';
            statusOptions.forEach(s => statusSelect.innerHTML += `<option value="${s}">${s}</option>`);
            statusSelect.innerHTML += `<option value="ANTRI BONGKAR + INAP">ANTRI BONGKAR + INAP</option>`;

            // --- KODE BARU: Populate Customer ---
            // Kita ambil data unique customer dari customersData (Master Data)
            if (customersData && customersData.length > 0) {
                 const sortedCustomers = [...customersData].sort((a, b) => a.name.localeCompare(b.name));
                 customerSelect.innerHTML = '<option value="all">Semua Customer</option>';
                 sortedCustomers.forEach(c => {
                     customerSelect.innerHTML += `<option value="${c.name}">${c.name}</option>`;
                 });
            }
        }
        
        function renderHomePage(data) {
            if (!data) return;
            document.getElementById('welcome-title').textContent = `Selamat Datang, ${currentUserData.angkutanName}!`;
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            const totalTrucks = data.length;
            
            // [PERBAIKAN] Logika 'availableTrucks' (sekarang Belum Alokasi) diubah
            const belumAlokasi = data.filter(t => ['TERSEDIA', 'STORING', 'NO DRIVER'].includes(t.keterangan)).length;
            
            // Logika 'activeTrucks' (sekarang Sudah Alokasi) sudah benar
            const activeTrucks = data.filter(t => ['OTW MILL', 'ANTRI MUAT', 'OTW CUSTOMER', 'ANTRI BONGKAR', 'INAP'].includes(t.keterangan)).length;

            document.getElementById('total-truck-count').textContent = totalTrucks;
            document.getElementById('active-truck-count').textContent = activeTrucks;
            // [PERBAIKAN] Mengirim hasil 'belumAlokasi' ke elemen card
            document.getElementById('available-truck-count').textContent = belumAlokasi;
            
            const container = document.getElementById('status-details-grid');
            container.innerHTML = '';

            // [PERBAIKAN] Fungsi helper internal dimodifikasi
            const createStatusCard = (status, count) => {
                let originalStatus = status;
                if (status.startsWith('INAP')) {
                    originalStatus = 'INAP';
                } else if (status.startsWith('ANTRI')) { 
                    originalStatus = 'ANTRI BONGKAR'; 
                    if (status === 'ANTRI MUAT') originalStatus = 'ANTRI MUAT'; 
                }
                
                const info = statusInfo[originalStatus] || { icon: 'fa-question-circle', color: 'gray' };
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-xl shadow-md flex items-center status-card';
                card.style.cursor = 'pointer';
                card.innerHTML = `
                    <div class="p-3 bg-${info.color}-100 rounded-full"><i class="fas ${info.icon} text-2xl text-${info.color}-600"></i></div>
                    <div class="ml-4">
                        <p class="text-slate-500 font-semibold">${status}</p>
                        <p class="text-2xl font-bold text-slate-800">${count}</p>
                    </div>`;
                // Onclick ini memanggil fungsi modal di file index.html
                card.onclick = () => window.showTrucksByStatus(status);
                container.appendChild(card);
            };

            // [PERBAIKAN] Tentukan urutan status baru
            const orderedStatuses = [
                'TERSEDIA',
                'OTW MILL',
                'ANTRI MUAT',
                'OTW CUSTOMER',
                'ANTRI BU17', // <-- BARU
                'ANTRI CMI',  // <-- BARU
                'INAP BU17',
                'INAP CMI',
                'STORING',
                'NO DRIVER'
            ];

            // Hitung SEMUA count terlebih dahulu
            const counts = {};
            counts['TERSEDIA'] = data.filter(t => t.keterangan === 'TERSEDIA').length;
            counts['OTW MILL'] = data.filter(t => t.keterangan === 'OTW MILL').length;
            counts['ANTRI MUAT'] = data.filter(t => t.keterangan === 'ANTRI MUAT').length;
            counts['OTW CUSTOMER'] = data.filter(t => t.keterangan === 'OTW CUSTOMER').length;
            counts['ANTRI BU17'] = data.filter(t => t.keterangan === 'ANTRI BONGKAR' && getDynamicStatus(t) === 'ANTRI BU17').length;
            counts['ANTRI CMI'] = data.filter(t => t.keterangan === 'ANTRI BONGKAR' && getDynamicStatus(t) === 'ANTRI CMI').length;
            counts['INAP BU17'] = data.filter(t => t.keterangan === 'INAP' && getDynamicStatus(t) === 'INAP BU17').length;
            counts['INAP CMI'] = data.filter(t => t.keterangan === 'INAP' && getDynamicStatus(t) === 'INAP CMI').length;
            counts['STORING'] = data.filter(t => t.keterangan === 'STORING').length;
            counts['NO DRIVER'] = data.filter(t => t.keterangan === 'NO DRIVER').length;
            
            // Loop melalui urutan yang DIINGINKAN dan render kartunya (termasuk yg 0)
            orderedStatuses.forEach(status => {
                createStatusCard(status, counts[status] || 0);
            });

            // Tampilkan (Lainnya) HANYA JIKA count > 0
            const inapLainnyaCount = data.filter(t => t.keterangan === 'INAP' && getDynamicStatus(t) === 'INAP (Lainnya)').length;
            if (inapLainnyaCount > 0) {
                 createStatusCard('INAP (Lainnya)', inapLainnyaCount);
            }
            const antriLainnyaCount = data.filter(t => t.keterangan === 'ANTRI BONGKAR' && getDynamicStatus(t) === 'ANTRI BONGKAR (Lainnya)').length;
            if (antriLainnyaCount > 0) {
                 createStatusCard('ANTRI BONGKAR (Lainnya)', antriLainnyaCount);
            }

            // Tampilkan 'STATUS TIDAK DIKENALI' HANYA JIKA count > 0
            const knownStatuses = [...statusOptions, 'INAP', 'ANTRI BONGKAR']; 
            const unknownTrucks = data.filter(truck => {
                const status = truck.keterangan;
                if (!status) return true; 
                return !knownStatuses.includes(status);
            });
            const unknownCount = unknownTrucks.length;

            if (unknownCount > 0) {
                const info = { icon: 'fa-question-circle', color: 'gray' };
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-xl shadow-md flex items-center status-card';
                card.style.cursor = 'pointer';
                card.style.border = '2px solid #ef4444'; 
                card.innerHTML = `
                    <div class="p-3 bg-${info.color}-100 rounded-full"><i class="fas ${info.icon} text-2xl text-${info.color}-600"></i></div>
                    <div class="ml-4">
                        <p class="text-slate-500 font-semibold">STATUS TIDAK DIKENALI</p>
                        <p class="text-2xl font-bold text-red-600">${unknownCount}</p>
                    </div>`;
                card.onclick = () => window.showTrucksByStatus('UNKNOWN'); // Kirim sinyal UNKNOWN
                container.appendChild(card);
            }
        }

        // GANTI SELURUH FUNGSI createTruckCard DENGAN INI (ATAU UPDATE BAGIAN HTML-NYA):
        function createTruckCard(truck) {
            const card = document.createElement('div');
            card.className = 'bg-white p-6 rounded-xl shadow-md transition hover:shadow-lg flex flex-col justify-between';
            card.setAttribute('data-id', truck.firestoreId);
            const isAvailable = truck.keterangan === 'TERSEDIA';
            
            let customerOptionsHtml = '<option value="">Pilih Customer...</option>';
            const customerNamesSet = new Set(customersData.map(c => c.name));
            customersData.forEach(customer => {
                const isSelected = truck.customer === customer.name ? 'selected' : '';
                customerOptionsHtml += `<option value="${customer.name}" ${isSelected}>${customer.name}</option>`;
            });
            if (truck.customer && !customerNamesSet.has(truck.customer)) {
                    customerOptionsHtml += `<option value="${truck.customer}" selected>${truck.customer} (Data Lama)</option>`;
            }
            
            const customerFieldHtml = `
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">Customer</label>
                    <select id="customer-select-${truck.firestoreId}" class="w-full p-2 border border-slate-300 rounded-lg" ${isAvailable ? 'disabled' : ''}>
                        ${isAvailable ? '<option value="">-</option>' : customerOptionsHtml}
                    </select>
                </div>`;

            let statusOptionsHtml = statusOptions.map(opt => `<option value="${opt}" ${truck.keterangan === opt ? 'selected' : ''}>${opt}</option>`).join('');
            const finishButtonHtml = `<button class="w-full bg-green-600 text-white font-semibold px-4 py-2 rounded-lg mt-2 shadow-sm hover:bg-green-700" onclick="window.finishDelivery('${truck.firestoreId}')">Delivery Selesai</button>`;
            
            const foDisabledAttr = isAvailable ? 'disabled' : '';
            const foRequiredAttr = isAvailable ? '' : 'required'; 
            
            // --- HTML UPDATE DI SINI (Menambahkan input Qty dan Jadwal Bongkar) ---
            card.innerHTML = `
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-800">${truck.no_mobil}</h3>
                        <span class="text-xs font-semibold bg-slate-200 text-slate-700 px-2 py-1 rounded-full">${truck.jenis_mobil}</span>
                    </div>
                    <div class="space-y-3">
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">Status</label><select id="status-select-${truck.firestoreId}" class="w-full p-2 border border-slate-300 rounded-lg">${statusOptionsHtml}</select></div>
                        ${customerFieldHtml}
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Kota</label><input type="text" id="tujuan-input-${truck.firestoreId}" value="${truck.tujuan || ''}" placeholder="-" class="w-full p-2 border border-slate-300 rounded-lg" ${isAvailable ? 'disabled' : ''} oninput="this.value = this.value.toUpperCase()"></div>
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Qty (Kg)</label><input type="number" id="qty-input-${truck.firestoreId}" value="${truck.qty || ''}" placeholder="0" class="w-full p-2 border border-slate-300 rounded-lg" ${isAvailable ? 'disabled' : ''}></div>
                        </div>

                        <div><label class="block text-sm font-medium text-slate-600 mb-1">Jadwal Bongkar</label><input type="datetime-local" id="jadwal-bongkar-input-${truck.firestoreId}" value="${truck.jadwal_bongkar || ''}" class="w-full p-2 border border-slate-300 rounded-lg" ${isAvailable ? 'disabled' : ''}></div>

                        <div><label class="block text-sm font-medium text-slate-600 mb-1">Tiba Lokasi Muat</label><input type="datetime-local" id="tiba-muat-input-${truck.firestoreId}" value="${truck.tiba_lokasi_muat || ''}" class="w-full p-2 border border-slate-300 rounded-lg" ${isAvailable ? 'disabled' : ''}></div>
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">Keluar Lokasi Muat</label><input type="datetime-local" id="keluar-muat-input-${truck.firestoreId}" value="${truck.keluar_lokasi_muat || ''}" class="w-full p-2 border border-slate-300 rounded-lg" ${isAvailable ? 'disabled' : ''}></div>
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">Tiba Lokasi Bongkar</label><input type="datetime-local" id="tiba-bongkar-input-${truck.firestoreId}" value="${truck.tiba_lokasi_bongkar || ''}" class="w-full p-2 border border-slate-300 rounded-lg" ${isAvailable ? 'disabled' : ''}></div>
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">Keluar Lokasi Bongkar</label><input type="datetime-local" id="keluar-bongkar-input-${truck.firestoreId}" value="${truck.keluar_lokasi_bongkar || ''}" class="w-full p-2 border border-slate-300 rounded-lg" ${isAvailable ? 'disabled' : ''}></div>
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">Terakhir Update Status</label><input type="datetime-local" id="waktu-input-${truck.firestoreId}" value="${truck.waktu || ''}" class="w-full p-2 border border-slate-300 rounded-lg bg-slate-100" readonly></div>
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">Nama Driver</label><input type="text" id="driver-input-${truck.firestoreId}" value="${truck.nama_driver || ''}" placeholder="-" class="w-full p-2 border border-slate-300 rounded-lg" oninput="this.value = this.value.toUpperCase()"></div>
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">No HP</label><input type="text" id="hp-input-${truck.firestoreId}" value="${truck.no_hp || ''}" placeholder="-" class="w-full p-2 border border-slate-300 rounded-lg"></div>
                        <div><label class="block text-sm font-medium text-slate-600 mb-1">FO/DN</label><input type="text" id="fo-input-${truck.firestoreId}" value="${truck.fo || ''}" placeholder="-" class="w-full p-2 border border-slate-300 rounded-lg" ${foDisabledAttr} ${foRequiredAttr} oninput="this.value = this.value.toUpperCase()"></div>
                    </div>
                </div>
                <div class="mt-4">
                    <button class="w-full bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700" onclick="window.updateTruckStatus('${truck.firestoreId}', this)">Update Semua Info</button>
                    ${finishButtonHtml}
                </div>`;

            const statusSelect = card.querySelector(`#status-select-${truck.firestoreId}`);
            const customerSelect = card.querySelector(`#customer-select-${truck.firestoreId}`);
            const foInput = card.querySelector(`#fo-input-${truck.firestoreId}`);
            
            // Tambahkan input baru ke array relatedInputs agar otomatis disabled saat "TERSEDIA"
            const relatedInputs = [
                card.querySelector(`#tujuan-input-${truck.firestoreId}`),
                card.querySelector(`#qty-input-${truck.firestoreId}`), // <-- Qty
                card.querySelector(`#jadwal-bongkar-input-${truck.firestoreId}`), // <-- Jadwal Bongkar
                foInput, 
                card.querySelector(`#tiba-muat-input-${truck.firestoreId}`),
                card.querySelector(`#keluar-muat-input-${truck.firestoreId}`),
                card.querySelector(`#tiba-bongkar-input-${truck.firestoreId}`),
                card.querySelector(`#keluar-bongkar-input-${truck.firestoreId}`)
            ];

            statusSelect.addEventListener('change', (e) => {
                const isNowAvailable = e.target.value === 'TERSEDIA';
                
                customerSelect.disabled = isNowAvailable;
                relatedInputs.forEach(field => { 
                    if(field) {
                        field.disabled = isNowAvailable;
                        if(field.id.includes('fo-input')) {
                            field.required = !isNowAvailable;
                        }
                    } 
                });

                if (isNowAvailable) {
                    customerSelect.innerHTML = '<option value="">-</option>';
                    relatedInputs.forEach(field => { if(field) field.value = ""; });
                } else {
                    customerSelect.innerHTML = customerOptionsHtml;
                }

                const waktuInput = card.querySelector(`#waktu-input-${truck.firestoreId}`);
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                waktuInput.value = now.toISOString().slice(0, 16);
            });
            
            return card;
        }

        window.updateTruckStatus = async (firestoreId, buttonElement) => {
            buttonElement.disabled = true; buttonElement.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            
            const newStatus = document.getElementById(`status-select-${firestoreId}`).value;
            let dataToUpdate;

            if (newStatus === 'TERSEDIA') {
                dataToUpdate = { ...dataToReset, 
                    nama_driver: document.getElementById(`driver-input-${firestoreId}`).value,
                    no_hp: document.getElementById(`hp-input-${firestoreId}`).value
                    };
            } else {
                
                const tibaMuat = document.getElementById(`tiba-muat-input-${firestoreId}`).value;
                const keluarMuat = document.getElementById(`keluar-muat-input-${firestoreId}`).value;
                const tibaBongkar = document.getElementById(`tiba-bongkar-input-${firestoreId}`).value;
                const keluarBongkar = document.getElementById(`keluar-bongkar-input-${firestoreId}`).value;
                const foInput = document.getElementById(`fo-input-${firestoreId}`).value;
                
                // --- LOGIC BARU: AMBIL INPUT ---
                const qtyInput = document.getElementById(`qty-input-${firestoreId}`).value;
                const jadwalBongkarInput = document.getElementById(`jadwal-bongkar-input-${firestoreId}`).value;

                // --- VALIDASI QTY WAJIB ---
                if (!qtyInput) {
                    showErrorAlert("Validasi Gagal", "Qty (Kg) harus diisi.");
                    buttonElement.innerHTML = 'Update Semua Info'; buttonElement.disabled = false;
                    document.getElementById(`qty-input-${firestoreId}`).focus();
                    return;
                }

                if (!foInput) {
                    showErrorAlert("Validasi Gagal", "Field FO/DN harus diisi.");
                    buttonElement.innerHTML = 'Update Semua Info'; buttonElement.disabled = false;
                    document.getElementById(`fo-input-${firestoreId}`).focus();
                    return;
                }
                
                // ... (Kode validasi waktu lama tetap sama di sini) ...
                if (keluarMuat || tibaBongkar || keluarBongkar) {
                    if (!tibaMuat) {
                        showErrorAlert("Validasi Waktu Gagal", "Tanggal Tiba Lokasi Muat harus diisi sebelum mengisi waktu berikutnya.");
                        buttonElement.innerHTML = 'Update Semua Info'; buttonElement.disabled = false;
                        return;
                    }
                }
                if (tibaBongkar || keluarBongkar) {
                    if (!keluarMuat) {
                        showErrorAlert("Validasi Waktu Gagal", "Tanggal Keluar Lokasi Muat harus diisi sebelum mengisi Tiba Lokasi Bongkar atau waktu berikutnya.");
                        buttonElement.innerHTML = 'Update Semua Info'; buttonElement.disabled = false;
                        return;
                    }
                }
                if (keluarBongkar) {
                    if (!tibaBongkar) {
                        showErrorAlert("Validasi Waktu Gagal", "Tanggal Tiba Lokasi Bongkar harus diisi sebelum mengisi Keluar Lokasi Bongkar.");
                        buttonElement.innerHTML = 'Update Semua Info'; buttonElement.disabled = false;
                        return;
                    }
                }

                if (!isValidTimeFlow(tibaMuat, keluarMuat)) {
                    showErrorAlert("Validasi Waktu Gagal", "Keluar Lokasi Muat tidak boleh mendahului Tiba Lokasi Muat.");
                    buttonElement.innerHTML = 'Update Semua Info'; buttonElement.disabled = false;
                    return;
                }
                if (!isValidTimeFlow(keluarMuat, tibaBongkar)) {
                    showErrorAlert("Validasi Waktu Gagal", "Tiba Lokasi Bongkar tidak boleh mendahului Keluar Lokasi Muat.");
                    buttonElement.innerHTML = 'Update Semua Info'; buttonElement.disabled = false;
                    return;
                }
                if (!isValidTimeFlow(tibaBongkar, keluarBongkar)) {
                    showErrorAlert("Validasi Waktu Gagal", "Keluar Lokasi Bongkar tidak boleh mendahului Tiba Lokasi Bongkar.");
                    buttonElement.innerHTML = 'Update Semua Info'; buttonElement.disabled = false;
                    return;
                }

                dataToUpdate = {
                    keterangan: newStatus,
                    nama_driver: document.getElementById(`driver-input-${firestoreId}`).value,
                    no_hp: document.getElementById(`hp-input-${firestoreId}`).value,
                    fo: foInput,
                    customer: document.getElementById(`customer-select-${firestoreId}`).value,
                    tujuan: document.getElementById(`tujuan-input-${firestoreId}`).value,
                    waktu: document.getElementById(`waktu-input-${firestoreId}`).value,
                    // --- SIMPAN FIELD BARU ---
                    qty: qtyInput,
                    jadwal_bongkar: jadwalBongkarInput,
                    // -------------------------
                    tiba_lokasi_muat: tibaMuat,
                    keluar_lokasi_muat: keluarMuat,
                    tiba_lokasi_bongkar: tibaBongkar,
                    keluar_lokasi_bongkar: keluarBongkar
                };
            }
            
            const truckDocRef = doc(db, `artifacts/${appId}/public/data/trucks`, firestoreId);
            
            try {
                await updateDoc(truckDocRef, dataToUpdate);
                showSuccessAlert("Berhasil", "Status truk berhasil diperbarui.");
                buttonElement.innerHTML = `✓ Berhasil`;
                setTimeout(() => { buttonElement.innerHTML = 'Update Semua Info'; buttonElement.disabled = false; }, 2000);
            } catch (error) { 
                console.error("Gagal update:", error);
                showErrorAlert("Gagal Menyimpan", "Gagal menyimpan perubahan.");
                buttonElement.innerHTML = 'Update Semua Info'; 
                buttonElement.disabled = false; 
            }
        };
        
        window.finishDelivery = (firestoreId) => {
            const truck = trucksData.find(t => t.firestoreId === firestoreId) || {};
            
            const fieldsToValidate = [
                { id: `customer-select-${firestoreId}`, name: 'Customer', key: 'customer' },
                { id: `tujuan-input-${firestoreId}`, name: 'Kota', key: 'tujuan' },
                // --- VALIDASI QTY DI SINI JUGA ---
                { id: `qty-input-${firestoreId}`, name: 'Qty', key: 'qty' },
                // ---------------------------------
                { id: `tiba-muat-input-${firestoreId}`, name: 'Tiba Lokasi Muat', key: 'tiba_lokasi_muat' },
                { id: `keluar-muat-input-${firestoreId}`, name: 'Keluar Lokasi Muat', key: 'keluar_lokasi_muat' },
                { id: `tiba-bongkar-input-${firestoreId}`, name: 'Tiba Lokasi Bongkar', key: 'tiba_lokasi_bongkar' },
                { id: `keluar-bongkar-input-${firestoreId}`, name: 'Keluar Lokasi Bongkar', key: 'keluar_lokasi_bongkar' },
                { id: `driver-input-${firestoreId}`, name: 'Nama Driver', key: 'nama_driver' },
                { id: `hp-input-${firestoreId}`, name: 'No HP', key: 'no_hp' },
                { id: `fo-input-${firestoreId}`, name: 'FO/DN', key: 'fo' }
            ];
            
            // ... (Logika validasi yang sudah ada tetap sama) ...
            const currentData = {};
            let isDataValid = true;
            let errorMessage = "";

            for (const field of fieldsToValidate) {
                const element = document.getElementById(field.id);
                currentData[field.key || field.id.split('-')[0]] = element.value; 
                
                if (!element.value) {
                    errorMessage = `Data '${field.name}' harus diisi sebelum menyelesaikan delivery.`;
                    isDataValid = false;
                    element.focus();
                    break;
                }
            }

            if (!isDataValid) {
                showErrorAlert("Validasi Gagal", errorMessage);
                return;
            }
            
            // Ambil Jadwal Bongkar (Opsional, jadi tidak masuk loop validasi)
            const jadwalBongkarVal = document.getElementById(`jadwal-bongkar-input-${firestoreId}`).value;

            // ... (Validasi waktu tetap sama) ...
            const tibaMuat = currentData.tiba_lokasi_muat;
            const keluarMuat = currentData.keluar_lokasi_muat;
            const tibaBongkar = currentData.tiba_lokasi_bongkar;
            const keluarBongkar = currentData.keluar_lokasi_bongkar;

            if (!isValidTimeFlow(tibaMuat, keluarMuat)) {
                showErrorAlert("Validasi Waktu Gagal", "Keluar Lokasi Muat tidak boleh mendahului Tiba Lokasi Muat.");
                return;
            }
            // ... (validasi waktu lainnya sama) ...

            showConfirmAlert(
                "Konfirmasi Delivery Selesai",
                "Semua data akan dicatat sebagai 1 ritase dan status truk akan diubah menjadi TERSEDIA. Lanjutkan?",
                "Ya, Selesaikan Delivery",
                async (isConfirmed) => {
                    if (isConfirmed) {
                        const truckDocRef = doc(db, `artifacts/${appId}/public/data/trucks`, firestoreId);
                        
                        try {
                            const ritaseData = {
                                angkutanName: currentUserData.angkutanName, truckId: firestoreId, 
                                truckId: firestoreId,
                                plat_nomor: truck.no_mobil || 'N/A',
                                jenis_mobil: truck.jenis_mobil || '-', // TAMBAHKAN BARIS INI
                                nama_driver: currentData.nama_driver || '-', 
                                customer: currentData.customer || '-',
                                tujuan: currentData.tujuan || '-', 
                                fo: currentData.fo || '-', 
                                // --- SIMPAN KE RITASE ---
                                qty: currentData.qty || '0',
                                jadwal_bongkar: jadwalBongkarVal || '',
                                // ------------------------
                                tiba_lokasi_muat: tibaMuat || '', 
                                keluar_lokasi_muat: keluarMuat || '',
                                tiba_lokasi_bongkar: tibaBongkar || '',
                                keluar_lokasi_bongkar: keluarBongkar || '',
                                timestamp_selesai: serverTimestamp()
                            };
                            await addDoc(collection(db, "completed_deliveries"), ritaseData);
                            
                            const finalResetData = { ...dataToReset, 
                                nama_driver: currentData.nama_driver,
                                no_hp: currentData.no_hp
                            };

                            await updateDoc(truckDocRef, finalResetData);
                            
                            const cardElement = document.querySelector(`#updateStatus div[data-id="${firestoreId}"]`);
                            if (cardElement) {
                                cardElement.remove();
                            }
                            
                            showSuccessAlert('Selesai!', 'Delivery selesai dan 1 ritase telah dicatat. Status truk diperbarui instan.');
                            
                            const container = document.getElementById('truckListContainer');
                            if (container.children.length === 0) {
                                container.innerHTML = `<p class="text-slate-500 col-span-full text-center">Semua truk tersedia atau tidak ada data yang perlu diperbarui.</p>`;
                            }

                        } catch (error) {
                            console.error("Error pada proses finishDelivery: ", error);
                            showErrorAlert("Gagal", "Gagal menyelesaikan delivery. Silakan coba lagi.");
                        }
                    }
                }
            );
        };

        function displayStatusCards(trucks) {
            const container = document.getElementById('readOnlyTruckList'); container.innerHTML = '';
            if (!trucks || trucks.length === 0) { container.innerHTML = `<p class="text-slate-500 col-span-full text-center">Tidak ada data.</p>`; return; }
            trucks.forEach((truck) => container.appendChild(createStatusCard(truck)));
        }

        function createStatusCard(truck) {
            const card = document.createElement('div');
            card.className = 'bg-white p-6 rounded-xl shadow-md';
            card.setAttribute('data-id', truck.firestoreId);
            
            // [PERBAIKAN] Gunakan getDynamicStatus agar badge-nya benar
            const dynamicStatus = getDynamicStatus(truck) || 'N/A';
            const badgeClasses = statusBadgeMap[dynamicStatus] || 'bg-slate-100 text-slate-800';
            
            const p = truck.panjang || 0, l = truck.lebar || 0, t = truck.tinggi || 0;
            const kubikasi = (p * l * t / 1000000).toFixed(2);
            const [tanggal, jam] = (truck.waktu || 'T').split('T');
            const waktuDisplay = tanggal && jam ? `${tanggal}, ${jam}` : '-';
            
            const timestampHTML = `
            <div class="border-t border-slate-100 pt-2 mt-2 space-y-2 text-xs">
                <div class="flex justify-between"><span class="text-slate-500">Tiba Muat:</span><span class="text-slate-700 font-semibold">${formatTanggalJam(truck.tiba_lokasi_muat)}</span></div>
                <div class="flex justify-between"><span class="text-slate-500">Keluar Muat:</span><span class="text-slate-700 font-semibold">${formatTanggalJam(truck.keluar_lokasi_muat)}</span></div>
                <div class="flex justify-between"><span class="text-slate-500">Tiba Bongkar:</span><span class="text-slate-700 font-semibold">${formatTanggalJam(truck.tiba_lokasi_bongkar)}</span></div>
                <div class="flex justify-between"><span class="text-slate-500">Keluar Bongkar:</span><span class="text-slate-700 font-semibold">${formatTanggalJam(truck.keluar_lokasi_bongkar)}</span></div>
            </div>`;
            
            // [PERBAIKAN] Tampilkan dynamicStatus di badge
            // card.innerHTML = `<div class="flex justify-between items-start"><h3 class="text-lg font-bold text-slate-800">${truck.no_mobil}</h3><span class="px-3 py-1 text-xs font-semibold leading-tight rounded-full ${badgeClasses}">${dynamicStatus}</span></div><p class="text-sm text-slate-500 mb-4">${truck.jenis_mobil || ''}</p><div class="border-t border-slate-200 pt-4 mt-4 space-y-2 text-sm"><div class="flex justify-between"><span class="text-slate-500 font-medium">Customer:</span><span class="text-slate-700 font-semibold">${truck.customer || '-'}</span></div><div class="flex justify-between">
            //     <span class="text-slate-500 font-medium">Qty:</span>
            //     <span class="text-slate-700 font-semibold">${truck.qty || '-'}</span>
            // </div>
            // <div class="flex justify-between">
            //     <span class="text-slate-500 font-medium">Jadwal Bongkar:</span>
            //     <span class="text-slate-700 font-semibold">${truck.jadwal_bongkar ? formatTanggalJam(truck.jadwal_bongkar) : '-'}</span>
            // </div><div class="flex justify-between"><span class="text-slate-500 font-medium">Kota:</span><span class="text-slate-700 font-semibold">${truck.tujuan || '-'}</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">Angkutan:</span><span class="text-slate-700 font-semibold">${truck.angkutan || '-'}</span></div>${timestampHTML}<div class="flex justify-between"><span class="text-slate-500 font-medium">Terakhir Update Status:</span><span class="text-slate-700 font-semibold">${waktuDisplay}</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">Driver:</span><span class="text-slate-700 font-semibold">${truck.nama_driver || '-'}</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">No HP:</span><span class="text-slate-700 font-semibold">${truck.no_hp || '-'}</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">No. FO:</span><span class="text-slate-700 font-semibold">${truck.fo || '-'}</span></div></div><div class="border-t border-slate-200 pt-2 mt-2 space-y-2 text-sm"><div class="flex justify-between"><span class="text-slate-500 font-medium">Dimensi:</span><span class="text-slate-700 font-semibold">${p}×${l}×${t} cm</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">Kubikasi:</span><span class="text-slate-700 font-bold text-indigo-600">${kubikasi} m³</span></div></div>`;
            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xl font-bold text-slate-800">${truck.no_mobil}</h3>
                    <span class="px-3 py-1 text-xs font-bold uppercase tracking-wider rounded-full ${badgeClasses}">
                        ${dynamicStatus}
                    </span>
                </div>
                <p class="text-sm font-bold text-indigo-600 mb-4">${truck.jenis_mobil || ''}</p>

                <div class="border-t border-slate-200 pt-4 space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-slate-500 font-medium">Customer:</span>
                        <span class="text-slate-800 font-bold text-right">${truck.customer || '-'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-500 font-medium">Qty:</span>
                        <span class="text-slate-800 font-bold">${truck.qty || '-'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-500 font-medium">Kota Tujuan:</span>
                        <span class="text-slate-800 font-bold">${truck.tujuan || '-'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-500 font-medium">No. FO / DN:</span>
                        <span class="text-slate-800 font-bold">${truck.fo || '-'}</span>
                    </div>
                </div>

                <div class="border-t border-slate-100 pt-3 mt-3 space-y-2 text-sm">
                    <div class="flex justify-between bg-amber-50 p-1 rounded">
                        <span class="text-amber-700 font-medium">Jadwal Bongkar:</span>
                        <span class="text-amber-800 font-bold">${truck.jadwal_bongkar ? formatTanggalJam(truck.jadwal_bongkar) : '-'}</span>
                    </div>
                    ${timestampHTML}
                    <div class="flex justify-between">
                        <span class="text-slate-500 font-medium">Last Update:</span>
                        <span class="text-slate-700 font-bold">${waktuDisplay}</span>
                    </div>
                </div>

                <div class="border-t border-slate-100 pt-3 mt-3 space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-slate-500 font-medium">Angkutan:</span>
                        <span class="text-slate-800 font-bold">${truck.angkutan || '-'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-500 font-medium">Driver:</span>
                        <span class="text-slate-800 font-bold">${truck.nama_driver || '-'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-500 font-medium">No HP:</span>
                        <span class="text-slate-800 font-bold">${truck.no_hp || '-'}</span>
                    </div>
                </div>

                <div class="border-t border-slate-200 pt-3 mt-3 flex justify-between items-center text-sm">
                    <div>
                        <span class="text-slate-500 font-medium">Dimensi:</span>
                        <span class="text-slate-800 font-bold ml-1">${p}×${l}×${t} cm</span>
                    </div>
                    <div class="bg-indigo-50 px-3 py-1 rounded">
                        <span class="text-indigo-700 font-bold">${kubikasi} m³</span>
                    </div>
                </div>
            `;           
            return card;
        }

        function displayDimensiTable(trucks) {
            const tableBody = document.getElementById('dimensiTableBody');
            tableBody.innerHTML = '';
            if (!trucks || trucks.length === 0) { tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-slate-500">Tidak ada data.</td></tr>`; return; }
            trucks.forEach(truck => tableBody.appendChild(createDimensionRow(truck)));
        }

        function createDimensionRow(truck) {
            const row = document.createElement('tr');
            row.className = 'bg-white border-b hover:bg-slate-50';
            row.setAttribute('data-id', truck.firestoreId);
            const p = truck.panjang || 0, l = truck.lebar || 0, t = truck.tinggi || 0;
            const kubikasi = (p * l * t / 1000000).toFixed(2);
            row.innerHTML = `<td class="px-6 py-4 font-medium">${truck.no_mobil}</td><td class="px-6 py-4">${truck.jenis_mobil || '-'}</td><td data-field="panjang" class="px-6 py-4">${p}</td><td data-field="lebar" class="px-6 py-4">${l}</td><td data-field="tinggi" class="px-6 py-4">${t}</td><td data-field="kubikasi" class="px-6 py-4 font-semibold">${kubikasi}</td><td class="px-6 py-4 action-buttons"><button class="edit p-2 text-xs text-white bg-amber-500 rounded-lg hover:bg-amber-600" onclick="window.editDimensions('${truck.firestoreId}')"><i class="fas fa-pencil-alt"></i></button></td>`;
            return row;
        }

        window.editDimensions = (firestoreId) => {
            window.cancelEditDimensions();
            const row = document.querySelector(`#dimensiTableBody tr[data-id="${firestoreId}"]`);
            if (!row) return;
            const createInput = (value) => `<input type="number" class="w-full p-2 border border-slate-300 rounded-lg" value="${value}" oninput="window.updateKubikasi('${firestoreId}')">`;
            row.querySelector('td[data-field="panjang"]').innerHTML = createInput(row.querySelector('td[data-field="panjang"]').textContent);
            row.querySelector('td[data-field="lebar"]').innerHTML = createInput(row.querySelector('td[data-field="lebar"]').textContent);
            row.querySelector('td[data-field="tinggi"]').innerHTML = createInput(row.querySelector('td[data-field="tinggi"]').textContent);
            row.querySelector('.action-buttons').innerHTML = `<button class="save p-2 text-xs text-white bg-green-600 rounded-lg" onclick="window.saveDimensions('${firestoreId}')"><i class="fas fa-check"></i></button><button class="cancel p-2 text-xs text-white bg-gray-500 rounded-lg ml-2" onclick="window.cancelEditDimensions()"><i class="fas fa-times"></i></button>`;
        };

        window.updateKubikasi = (firestoreId) => {
            const row = document.querySelector(`#dimensiTableBody tr[data-id="${firestoreId}"]`);
            if (!row) return;
            const p = parseFloat(row.querySelector('td[data-field="panjang"] input').value) || 0;
            const l = parseFloat(row.querySelector('td[data-field="lebar"] input').value) || 0;
            const t = parseFloat(row.querySelector('td[data-field="tinggi"] input').value) || 0;
            row.querySelector('td[data-field="kubikasi"]').textContent = (p * l * t / 1000000).toFixed(2);
        };

        window.saveDimensions = async (firestoreId) => {
            const row = document.querySelector(`#dimensiTableBody tr[data-id="${firestoreId}"]`);
            if (!row) return;
            const dataToUpdate = { 
                panjang: parseFloat(row.querySelector('td[data-field="panjang"] input').value) || 0, 
                lebar: parseFloat(row.querySelector('td[data-field="lebar"] input').value) || 0, 
                tinggi: parseFloat(row.querySelector('td[data-field="tinggi"] input').value) || 0, 
            };
            const truckDocRef = doc(db, `artifacts/${appId}/public/data/trucks`, firestoreId);
            try { 
                await updateDoc(truckDocRef, dataToUpdate);
                window.cancelEditDimensions(); 
                showSuccessAlert("Berhasil", "Dimensi truk berhasil diperbarui.");
            } catch(e) { 
                showErrorAlert("Gagal Menyimpan", "Gagal menyimpan data dimensi.");
                console.error("Gagal menyimpan dimensi:", e);
            }
        };

        window.cancelEditDimensions = () => displayDimensiTable(trucksData);

        function renderSummaryReport() {
            // Gunakan fungsi helper yang baru kita buat
            const filteredData = getFilteredSummaryData(); 

            const tableBody = document.getElementById('summaryTableBody');
            tableBody.innerHTML = '';
            
            if (!filteredData || filteredData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="12" class="text-center p-8 text-slate-500">Tidak ada data yang cocok dengan filter.</td></tr>`;
                return;
            }

            const formatWaktuTabel = (waktu) => waktu ? waktu.replace('T', ' ') : '-';
            
            filteredData.forEach(truck => {
                // ... (Kode render row di dalam sini TETAP SAMA seperti sebelumnya) ...
                // Copy isi loop forEach dari kode lama kamu ke sini
                 const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-slate-50';
                const badgeClasses = statusBadgeMap[truck.keterangan] || 'bg-slate-100 text-slate-800';
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium">${truck.fo || '-'}</td>
                    <td class="px-6 py-4">${truck.qty || '0'}</td> 
                    <td class="px-6 py-4">${formatWaktuTabel(truck.jadwal_bongkar)}</td>
                    <td class="px-6 py-4">${formatWaktuTabel(truck.tiba_lokasi_muat)}</td>
                    <td class="px-6 py-4">${formatWaktuTabel(truck.keluar_lokasi_muat)}</td>
                    <td class="px-6 py-4">${formatWaktuTabel(truck.tiba_lokasi_bongkar)}</td>
                    <td class="px-6 py-4">${formatWaktuTabel(truck.keluar_lokasi_bongkar)}</td>
                    <td class="px-6 py-4">${truck.customer || '-'}</td>
                    <td class="px-6 py-4">${truck.tujuan || '-'}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${badgeClasses}">${truck.keterangan || 'N/A'}</span></td>
                    <td class="px-6 py-4">${truck.nama_driver || '-'}</td>
                    <td class="px-6 py-4">${truck.no_hp || '-'}</td>
                    <td class="px-6 py-4">${truck.no_mobil || '-'}</td>
                    <td class="px-6 py-4">${truck.jenis_mobil || '-'}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        // --- FUNGSI HELPER BARU UNTUK FILTER ---
        function getFilteredSummaryData() {
            let filteredData = [...trucksData];
            
            const selectedJenisMobil = document.getElementById('summaryFilterJenisMobil').value;
            const selectedStatus = document.getElementById('summaryFilterStatus').value;
            const selectedCustomer = document.getElementById('summaryFilterCustomer').value; // <--- BARU

            // Filter Jenis Mobil
            if (selectedJenisMobil !== 'all') {
                filteredData = filteredData.filter(t => t.jenis_mobil === selectedJenisMobil);
            }

            // Filter Status
            if (selectedStatus === 'ANTRI BONGKAR + INAP') {
                filteredData = filteredData.filter(t => t.keterangan === 'ANTRI BONGKAR' || t.keterangan === 'INAP');
            } else if (selectedStatus !== 'all') {
                filteredData = filteredData.filter(t => t.keterangan === selectedStatus);
            }

            // Filter Customer (BARU)
            if (selectedCustomer !== 'all') {
                filteredData = filteredData.filter(t => t.customer === selectedCustomer);
            }

            return filteredData;
        }

        // --- 0. HELPER: WARNA STATUS (Untuk PDF & Image) ---
        const getStatusColorCode = (status) => {
            // Warna Background (Hex) untuk PDF/Image
            switch (status) {
                case 'TERSEDIA': return '#d1fae5'; // Hijau Muda
                case 'OTW MILL': return '#f3e8ff'; // Ungu Muda
                case 'ANTRI MUAT': return '#cffafe'; // Cyan Muda
                case 'OTW CUSTOMER': return '#dcfce7'; // Hijau Muda
                case 'ANTRI BONGKAR': 
                case 'ANTRI BU17':
                case 'ANTRI CMI': return '#fef9c3'; // Kuning Muda
                case 'INAP':
                case 'INAP BU17':
                case 'INAP CMI': return '#ffedd5'; // Orange Muda
                case 'STORING': return '#fee2e2'; // Merah Muda
                case 'NO DRIVER': return '#ffe4e6'; // Rose Muda
                default: return '#f1f5f9'; // Abu-abu
            }
        };

        const getStatusTextColorCode = (status) => {
            // Warna Teks (Hex)
            switch (status) {
                case 'TERSEDIA': return '#065f46';
                case 'OTW MILL': return '#6b21a8';
                case 'ANTRI MUAT': return '#155e75';
                case 'OTW CUSTOMER': return '#166534';
                case 'ANTRI BONGKAR': 
                case 'ANTRI BU17':
                case 'ANTRI CMI': return '#854d0e';
                case 'INAP':
                case 'INAP BU17':
                case 'INAP CMI': return '#9a3412';
                case 'STORING': return '#991b1b';
                case 'NO DRIVER': return '#9f1239';
                default: return '#1e293b';
            }
        };

        // --- 1. EXPORT TO EXCEL ---
        window.exportToExcel = () => {
            const angkutanName = currentUserData.angkutanName || 'Report';
            const cleanAngkutanName = angkutanName.replace(/ /g, '_');
            
            // Menggunakan helper filter yang sudah dibuat sebelumnya
            let filteredData = getFilteredSummaryData(); 

            // Cek apakah perlu kolom Lead Time
            const selectedStatus = document.getElementById('summaryFilterStatus').value;
            const showLeadTimeColumn = (selectedStatus.includes('INAP') || selectedStatus.includes('ANTRI'));

            const headers = [
                "No", "FO/DN", "Qty (Kg)", "Jadwal Bongkar", 
                "Tiba Muat", "Keluar Muat", 
                "Tiba Bongkar", "Keluar Bongkar", 
                "Customer", "Kota", "Status", 
                "Driver", "No HP", "Plat Nomor", "Jenis Truck"
            ];
            if (showLeadTimeColumn) headers.push("Lead Time");

            const body = filteredData.map((truck, index) => {
                const row = [
                    index + 1,
                    truck.fo || '-',
                    truck.qty || '0',
                    formatTanggalJam(truck.jadwal_bongkar),
                    formatTanggalJam(truck.tiba_lokasi_muat),
                    formatTanggalJam(truck.keluar_lokasi_muat),
                    formatTanggalJam(truck.tiba_lokasi_bongkar),
                    formatTanggalJam(truck.keluar_lokasi_bongkar),
                    truck.customer || '-',
                    truck.tujuan || '-',
                    truck.keterangan || '-',
                    truck.nama_driver || '-',
                    truck.no_hp || '-',
                    truck.no_mobil || '-',
                    truck.jenis_mobil || '-'
                ];
                if (showLeadTimeColumn) {
                    row.push(calculateLeadTime(truck.tiba_lokasi_bongkar));
                }
                return row;
            });

            const worksheet = XLSX.utils.aoa_to_sheet([headers, ...body]);

            // Styling Header Sederhana (Bold)
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const address = XLSX.utils.encode_col(C) + "1";
                if (!worksheet[address]) continue;
                worksheet[address].s = { font: { bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "4F46E5" } } };
            }

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Summary Report");
            XLSX.writeFile(workbook, `Summary_${cleanAngkutanName}_${getFilenameTimestamp()}.xlsx`);
        };

        // --- 2. EXPORT TO PDF (TAMPILAN BAGUS & BERWARNA) ---
        window.exportToPdf = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            
            const angkutanName = currentUserData.angkutanName || 'Report';
            const timestamp = getFormattedTimestamp();
            
            let filteredData = getFilteredSummaryData();

            const selectedStatus = document.getElementById('summaryFilterStatus').value;
            const showLeadTimeColumn = (selectedStatus.includes('INAP') || selectedStatus.includes('ANTRI'));

            // Judul Dokumen
            doc.setFontSize(16);
            doc.setTextColor(30, 41, 59); // Slate-800
            doc.text(`Summary Report - ${angkutanName}`, 14, 15);
            
            doc.setFontSize(10);
            doc.setTextColor(100, 116, 139); // Slate-500
            doc.text(`Dicetak pada: ${timestamp}`, 14, 22);

            // Definisi Kolom
            const columns = [
                { header: 'No', dataKey: 'no' },
                { header: 'FO/DN', dataKey: 'fo' },
                { header: 'Qty', dataKey: 'qty' },
                { header: 'Jadwal', dataKey: 'jadwal' },
                { header: 'Tiba Bongkar', dataKey: 'tiba_bongkar' }, // Fokus info penting
                { header: 'Customer', dataKey: 'customer' },
                { header: 'Kota', dataKey: 'kota' },
                { header: 'Status', dataKey: 'status' }, // Kolom ini akan diwarnai
                { header: 'Driver', dataKey: 'driver' },
                { header: 'Plat No', dataKey: 'plat' },
                { header: 'Jenis', dataKey: 'jenis' }
            ];
            if (showLeadTimeColumn) columns.push({ header: 'Lead Time', dataKey: 'leadtime' });

            const body = filteredData.map((truck, index) => {
                const row = {
                    no: index + 1,
                    fo: truck.fo || '-',
                    qty: truck.qty || '0',
                    jadwal: formatTanggalJam(truck.jadwal_bongkar),
                    tiba_bongkar: formatTanggalJam(truck.tiba_lokasi_bongkar),
                    customer: truck.customer || '-',
                    kota: truck.tujuan || '-',
                    status: truck.keterangan || '-',
                    driver: truck.nama_driver || '-',
                    plat: truck.no_mobil || '-',
                    jenis: truck.jenis_mobil || '-'
                };
                if (showLeadTimeColumn) row.leadtime = calculateLeadTime(truck.tiba_lokasi_bongkar);
                return row;
            });

            doc.autoTable({
                columns: columns,
                body: body,
                startY: 28,
                theme: 'grid',
                styles: { 
                    fontSize: 7, 
                    cellPadding: 2, 
                    valign: 'middle', 
                    halign: 'center',
                    lineColor: [226, 232, 240] // Slate-200
                },
                headStyles: { 
                    fillColor: [79, 70, 229], // Indigo-600
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [248, 250, 252] // Slate-50
                },
                // --- LOGIKA PEWARNAAN OTOMATIS (BADGE STATUS) ---
                didParseCell: function(data) {
                    if (data.section === 'body' && data.column.dataKey === 'status') {
                        const statusRaw = data.cell.raw;
                        // Ubah warna teks berdasarkan status
                        // Kita gunakan RGB manual karena jspdf butuh array/hex
                        const hexColor = getStatusTextColorCode(statusRaw);
                        const r = parseInt(hexColor.substr(1,2), 16);
                        const g = parseInt(hexColor.substr(3,2), 16);
                        const b = parseInt(hexColor.substr(5,2), 16);
                        
                        data.cell.styles.textColor = [r, g, b];
                        data.cell.styles.fontStyle = 'bold';
                    }
                }
            });

            doc.save(`Summary_Report_${getFilenameTimestamp()}.pdf`);
        };

        // --- 3. EXPORT AS IMAGE (FORMAT CARD RAPIBH) ---
        window.exportAsImage = async () => {
            const angkutanName = currentUserData.angkutanName || 'Report';
            
            let filteredData = getFilteredSummaryData();
            
            // Logic Sort khusus Image (Prioritas Inap/Antri di atas)
            const selectedStatus = document.getElementById('summaryFilterStatus').value;
            const showLeadTimeColumn = (selectedStatus.includes('INAP') || selectedStatus.includes('ANTRI'));
            
            if (showLeadTimeColumn) {
                filteredData.sort((a, b) => {
                    const leadTimeA = calculateLeadTimeInMinutes(a.tiba_lokasi_bongkar);
                    const leadTimeB = calculateLeadTimeInMinutes(b.tiba_lokasi_bongkar);
                    return leadTimeB - leadTimeA;
                });
            }

            // --- MEMBUAT ELEMEN HTML TEMPORARY UNTUK SCREENSHOT ---
            const container = document.createElement('div');
            // Styling Container agar terlihat seperti "Kertas Laporan"
            container.style.position = 'absolute';
            container.style.left = '-9999px'; // Sembunyikan dari layar user
            container.style.top = '0';
            container.style.width = '1400px'; // Lebar fix agar tabel luas
            container.style.padding = '40px';
            container.style.backgroundColor = '#ffffff';
            container.style.fontFamily = "'Inter', sans-serif";
            container.style.color = '#1e293b';

            // Header Laporan
            let htmlContent = `
                <div style="margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="font-size: 24px; font-weight: 800; color: #1e293b; margin: 0;">SUMMARY REPORT</h1>
                        <h2 style="font-size: 18px; color: #4f46e5; margin: 5px 0 0 0;">${angkutanName}</h2>
                    </div>
                    <div style="text-align: right;">
                        <p style="font-size: 14px; color: #64748b; margin: 0;">Generated Date:</p>
                        <p style="font-size: 14px; font-weight: 600; color: #334155; margin: 0;">${getFormattedTimestamp()}</p>
                    </div>
                </div>
            `;

            // Tabel
            htmlContent += `
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #f1f5f9; color: #334155;">
                            <th style="padding: 12px; border: 1px solid #cbd5e1; text-align: center;">No</th>
                            <th style="padding: 12px; border: 1px solid #cbd5e1; text-align: left;">FO/DN</th>
                            <th style="padding: 12px; border: 1px solid #cbd5e1; text-align: center;">Qty</th>
                            <th style="padding: 12px; border: 1px solid #cbd5e1; text-align: center;">Jadwal Bongkar</th>
                            <th style="padding: 12px; border: 1px solid #cbd5e1; text-align: center;">Tiba Bongkar</th>
                            <th style="padding: 12px; border: 1px solid #cbd5e1; text-align: left;">Customer</th>
                            <th style="padding: 12px; border: 1px solid #cbd5e1; text-align: center;">Kota</th>
                            <th style="padding: 12px; border: 1px solid #cbd5e1; text-align: center;">Status</th>
                            <th style="padding: 12px; border: 1px solid #cbd5e1; text-align: left;">Driver</th>
                            <th style="padding: 12px; border: 1px solid #cbd5e1; text-align: center;">Plat Nomor</th>
                            ${showLeadTimeColumn ? '<th style="padding: 12px; border: 1px solid #cbd5e1; text-align: center;">Lead Time</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredData.forEach((truck, index) => {
                // Style Badge Status Manual (Inline CSS)
                const bgStatus = getStatusColorCode(truck.keterangan);
                const textStatus = getStatusTextColorCode(truck.keterangan);
                const badgeStyle = `display: inline-block; padding: 4px 12px; border-radius: 9999px; background-color: ${bgStatus}; color: ${textStatus}; font-weight: 700; font-size: 11px; text-transform: uppercase;`;

                htmlContent += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #e2e8f0; text-align: center;">${index + 1}</td>
                        <td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: 600;">${truck.fo || '-'}</td>
                        <td style="padding: 10px; border: 1px solid #e2e8f0; text-align: center;">${truck.qty || '0'}</td>
                        <td style="padding: 10px; border: 1px solid #e2e8f0; text-align: center;">${formatTanggalJam(truck.jadwal_bongkar)}</td>
                        <td style="padding: 10px; border: 1px solid #e2e8f0; text-align: center;">${formatTanggalJam(truck.tiba_lokasi_bongkar)}</td>
                        <td style="padding: 10px; border: 1px solid #e2e8f0;">${truck.customer || '-'}</td>
                        <td style="padding: 10px; border: 1px solid #e2e8f0; text-align: center;">${truck.tujuan || '-'}</td>
                        <td style="padding: 10px; border: 1px solid #e2e8f0; text-align: center;">
                            <span style="${badgeStyle}">${truck.keterangan || '-'}</span>
                        </td>
                        <td style="padding: 10px; border: 1px solid #e2e8f0;">${truck.nama_driver || '-'}</td>
                        <td style="padding: 10px; border: 1px solid #e2e8f0; text-align: center; font-weight: 600;">${truck.no_mobil || '-'}</td>
                        ${showLeadTimeColumn ? `<td style="padding: 10px; border: 1px solid #e2e8f0; text-align: center; color: #dc2626; font-weight: 700;">${calculateLeadTime(truck.tiba_lokasi_bongkar)}</td>` : ''}
                    </tr>
                `;
            });

            htmlContent += `</tbody></table>`;
            
            // Footer
            htmlContent += `
                <div style="margin-top: 20px; text-align: center; color: #94a3b8; font-size: 11px; border-top: 1px solid #f1f5f9; padding-top: 10px;">
                    &copy; ${new Date().getFullYear()} Logistik IKK - System Monitoring
                </div>
            `;

            container.innerHTML = htmlContent;
            document.body.appendChild(container);

            try {
                // Scale 2 untuk resolusi tinggi (tidak buram saat di-zoom di WA)
                const canvas = await html2canvas(container, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                const link = document.createElement('a');
                link.download = `Report_Image_${getFilenameTimestamp()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            } catch (error) {
                console.error("Gagal export gambar:", error);
                showErrorAlert("Error", "Gagal membuat gambar.");
            } finally {
                document.body.removeChild(container);
            }
        };
        
        function closeFilterPopup() {
            const popup = document.getElementById('header-filter-popup');
            if (popup) popup.classList.add('hidden');
            currentFilterColumn = null;
        }

        window.openFilterPopup = (event, column) => {
            event.stopPropagation();
            const popup = document.getElementById('header-filter-popup');
            const filterOptions = document.getElementById('filter-options');
            const searchInput = document.getElementById('filter-search');
            if (currentFilterColumn === column && !popup.classList.contains('hidden')) {
                closeFilterPopup();
                return;
            }
            currentFilterColumn = column;
            const uniqueValues = [...new Set(allRitaseData.map(item => item[column]))].filter(Boolean).sort();
            filterOptions.innerHTML = '';
            uniqueValues.forEach(value => {
                const isChecked = activeFilters[column] && activeFilters[column].includes(String(value));
                const itemHtml = `<label class="filter-item flex items-center"><input type="checkbox" value="${value}" ${isChecked ? 'checked' : ''} class="mr-2 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><span>${value}</span></label>`;
                filterOptions.innerHTML += itemHtml;
            });
            searchInput.value = '';
            searchInput.onkeyup = () => {
                const term = searchInput.value.toLowerCase();
                document.querySelectorAll('#filter-options .filter-item').forEach(item => {
                    const text = item.querySelector('span').textContent.toLowerCase();
                    item.style.display = text.includes(term) ? 'flex' : 'none';
                });
            };
            document.getElementById('apply-filter-btn').onclick = applyHeaderFilters;
            document.getElementById('clear-filter-btn').onclick = clearHeaderFilters;
            const headerRect = event.currentTarget.getBoundingClientRect();
            popup.style.left = `${headerRect.left}px`;
            popup.style.top = `${headerRect.bottom + window.scrollY}px`;
            popup.classList.remove('hidden');
        }

        function applyHeaderFilters() {
            if (!currentFilterColumn) return;
            const selectedValues = [];
            document.querySelectorAll('#filter-options input[type="checkbox"]:checked').forEach(checkbox => {
                selectedValues.push(checkbox.value);
            });
            if (selectedValues.length > 0) {
                activeFilters[currentFilterColumn] = selectedValues;
            } else {
                delete activeFilters[currentFilterColumn];
            }
            applyRitaseFiltersAndSort();
            closeFilterPopup();
        }

        function clearHeaderFilters() {
            if (!currentFilterColumn) return;
            delete activeFilters[currentFilterColumn];
            applyRitaseFiltersAndSort();
            closeFilterPopup();
        }

        window.sortRitaseTable = (column) => {
            if (ritaseSort.column === column) {
                ritaseSort.direction = ritaseSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                ritaseSort.column = column;
                ritaseSort.direction = 'asc';
            }
            applyRitaseFiltersAndSort();
        };
        
        window.handleHeaderClick = (event, column) => {
            if (event.shiftKey) {
                window.sortRitaseTable(column);
            } else {
                window.openFilterPopup(event, column);
            }
        };

        function displayRitaseTable() {
            const tableBody = document.getElementById('ritaseTableBody');
            tableBody.innerHTML = '';
            const { currentPage, filteredData } = paginationState.ritaseTruck;

            // Cek jika data kosong
            if (!filteredData || filteredData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="14" class="text-center p-8 text-slate-500">Tidak ada data ritase yang cocok.</td></tr>`;
                renderPagination('ritaseTablePagination', 'ritaseTruck', displayRitaseTable);
                return;
            }

            // Logika Pagination
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedData = filteredData.slice(start, end);

            paginatedData.forEach(data => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-slate-50';
                
                // Format Tanggal Selesai
                const formattedDateSelesai = data.timestamp_selesai?.toDate() 
                    ? formatTanggalJam(data.timestamp_selesai.toDate().toISOString().slice(0, 16)) 
                    : '-';
                
                // Hitung Lama Inap
                const lamaInap = calculateLeadTime(data.tiba_lokasi_bongkar);
                
                // --- LOGIKA PERBAIKAN: CARI JENIS MOBIL ---
                // 1. Ambil jenis mobil dari data ritase (history)
                let displayJenisMobil = data.jenis_mobil;
                
                // 2. Jika kosong/tidak ada, cari di daftar truk master (trucksData) berdasarkan plat nomor
                if (!displayJenisMobil || displayJenisMobil === '-' || displayJenisMobil === '' || displayJenisMobil === undefined) {
                    const masterTruck = trucksData.find(t => t.no_mobil === data.plat_nomor);
                    if (masterTruck) {
                        displayJenisMobil = masterTruck.jenis_mobil; // Pakai data terbaru dari master truk
                    } else {
                        displayJenisMobil = '-'; // Tetap strip jika plat nomor sudah tidak ada di sistem
                    }
                }
                // ------------------------------------------

                row.innerHTML = `
                    <td class="px-6 py-4 font-medium">${data.plat_nomor || '-'}</td>
                    <td class="px-6 py-4">${displayJenisMobil}</td> <td class="px-6 py-4">${data.nama_driver || '-'}</td>
                    <td class="px-6 py-4">${data.customer || '-'}</td>
                    <td class="px-6 py-4">${data.tujuan || '-'}</td>
                    <td class="px-6 py-4">${data.qty || '0'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs">${formatTanggalJam(data.jadwal_bongkar)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs">${formatTanggalJam(data.tiba_lokasi_muat)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs">${formatTanggalJam(data.keluar_lokasi_muat)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs">${formatTanggalJam(data.tiba_lokasi_bongkar)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs">${formatTanggalJam(data.keluar_lokasi_bongkar)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs">${formattedDateSelesai}</td>
                    <td class="px-6 py-4 font-semibold text-indigo-600">${lamaInap}</td>
                    <td class="px-6 py-4">${data.fo || '-'}</td>
                `;
                tableBody.appendChild(row);
            });
            
            // Render tombol pagination
            renderPagination('ritaseTablePagination', 'ritaseTruck', displayRitaseTable);
        }
        
        function updateSortIndicators() {
            const headers = document.querySelectorAll('#ritaseTable th[data-filter]');
            headers.forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
                const column = header.getAttribute('data-filter');
                if (column === ritaseSort.column) {
                    header.classList.add(ritaseSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        // GANTI FUNGSI INI DI SCRIPT
        async function fetchAndRenderRitase(isFilterMode = false) {
            const tableBody = document.getElementById('ritaseTableBody');
            const loadingMsg = isFilterMode ? 'Mengambil data lengkap sesuai tanggal...' : 'Memuat data ritase (20 Terakhir)...';
            
            tableBody.innerHTML = `<tr><td colspan="10" class="text-center p-8 text-slate-500"><i class="fas fa-spinner fa-spin mr-2"></i>${loadingMsg}</td></tr>`;

            try {
                allRitaseData = []; // <--- TAMBAHKAN INI (Reset variabel penampung)
                const ritaseRef = collection(db, "completed_deliveries");
                let q;

                // Cek Input Tanggal
                const startDateVal = document.getElementById('ritaseStartDate').value;
                const endDateVal = document.getElementById('ritaseEndDate').value;

                if (isFilterMode && startDateVal && endDateVal) {
                    // --- MODE FILTER TANGGAL (AMBIL SEMUA SESUAI TANGGAL) ---
                    // Set jam agar mencakup seluruh hari (00:00 s/d 23:59)
                    const startDate = new Date(startDateVal);
                    startDate.setHours(0, 0, 0, 0);
                    
                    const endDate = new Date(endDateVal);
                    endDate.setHours(23, 59, 59, 999);

                    console.log("Mengambil data dari server range:", startDate, "s/d", endDate);

                    q = query(ritaseRef, 
                        where("angkutanName", "==", currentUserData.angkutanName), 
                        where("timestamp_selesai", ">=", startDate),
                        where("timestamp_selesai", "<=", endDate),
                        orderBy("timestamp_selesai", "desc")
                        // TIDAK ADA LIMIT DI SINI (Agar data sebulan penuh terambil)
                    );
                } else {
                    // --- MODE DEFAULT (HEMAT KUOTA) ---
                    // Hanya ambil 50 terakhir
                    q = query(ritaseRef, 
                        where("angkutanName", "==", currentUserData.angkutanName), 
                        orderBy("timestamp_selesai", "desc"),
                        limit(20) // LIMIT AKTIF
                    );
                }
                
                const querySnapshot = await getDocs(q);
                
                // Simpan ke variabel global
                allRitaseData = querySnapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
                
                if (isFilterMode) {
                    console.log(`Berhasil menarik ${allRitaseData.length} data ritase (Full Range).`);
                    showSuccessAlert("Data Terupdate", `Berhasil memuat ${allRitaseData.length} data ritase sesuai tanggal.`);
                } else {
                    console.log(`Berhasil memuat ${allRitaseData.length} data ritase (Default Limit).`);
                }
                
                // Panggil fungsi filter lokal untuk merender tabel
                applyRitaseFiltersAndSort();

            } catch (error) {
                console.error("Gagal memuat data ritase:", error);
                
                if (error.code === 'resource-exhausted') {
                    tableBody.innerHTML = `<tr><td colspan="10" class="text-center p-8 text-red-600 font-bold">Kuota Harian Habis. Silakan coba lagi besok.</td></tr>`;
                } else if (error.code === 'failed-precondition') {
                    // Error ini biasanya muncul jika Index belum dibuat di Firebase
                    tableBody.innerHTML = `<tr><td colspan="10" class="text-center p-8 text-red-500">Perlu Index Firestore. (Hubungi Admin)</td></tr>`;
                    console.log("Perlu membuat index komposisi: angkutanName + timestamp_selesai");
                } else {
                    tableBody.innerHTML = `<tr><td colspan="10" class="text-center p-8 text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
                }
            }
        }

        function applyRitaseFiltersAndSort() {
            let filtered = [...allRitaseData];
            const startDateString = document.getElementById('ritaseStartDate').value;
            const endDateString = document.getElementById('ritaseEndDate').value;
            if (startDateString || endDateString) {
                const startDate = startDateString ? new Date(startDateString) : null;
                const endDate = endDateString ? new Date(endDateString) : null;
                if(startDate) startDate.setHours(0, 0, 0, 0);
                if(endDate) endDate.setHours(23, 59, 59, 999);
                filtered = filtered.filter(item => {
                    if (!item.timestamp_selesai || !item.timestamp_selesai.toDate) return false;
                    const itemDate = item.timestamp_selesai.toDate();
                    if (startDate && itemDate < startDate) return false;
                    if (endDate && itemDate > endDate) return false;
                    return true;
                });
            }
            for (const column in activeFilters) {
                if (activeFilters[column] && activeFilters[column].length > 0) {
                    filtered = filtered.filter(item => activeFilters[column].includes(String(item[column])));
                }
            }
            filtered.sort((a, b) => {
                const valA = a[ritaseSort.column];
                const valB = b[ritaseSort.column];
                if (ritaseSort.column === 'timestamp_selesai') {
                    const timeA = valA?.toMillis() || 0;
                    const timeB = valB?.toMillis() || 0;
                    return ritaseSort.direction === 'asc' ? timeA - timeB : timeB - timeA;
                }
                const comparison = String(valA || '').localeCompare(String(valB || ''), undefined, { numeric: true });
                return ritaseSort.direction === 'asc' ? comparison : -comparison;
            });

            paginationState.ritaseTruck.filteredData = filtered;
            paginationState.ritaseTruck.currentPage = 1;
            displayRitaseTable();
            updateSortIndicators();
        }
        
        window.exportRitaseToExcel = () => {
            const dataToExport = paginationState.ritaseTruck.filteredData;
            if (!dataToExport || dataToExport.length === 0) {
                showErrorAlert("Gagal Export", "Tidak ada data untuk diexport.");
                return;
            }

            const fmtTime = (isoString) => {
                if (!isoString || !isoString.includes('T')) return '-';
                const [datePart, timePart] = isoString.split('T');
                const [year, month, day] = datePart.split('-');
                return `${day}/${month}/${year}, ${timePart}`;
            };

            const headers = [
                "PLAT NOMOR", "JENIS TRUCK", "NAMA DRIVER", "CUSTOMER", "KOTA", 
                "QTY", "JADWAL BONGKAR", "TIBA MUAT", "KELUAR MUAT", "TIBA BONGKAR", 
                "KELUAR BONGKAR", "TANGGAL SELESAI", "LAMA INAP", "FO"
            ];
            
            const body = dataToExport.map((row) => {
                const tglSelesai = row.timestamp_selesai?.toDate() 
                    ? fmtTime(row.timestamp_selesai.toDate().toISOString().slice(0, 16)) 
                    : '-';

                // --- LOGIKA PERBAIKAN: CARI JENIS MOBIL ---
                // Sama persis seperti tampilan di Tabel
                let displayJenisMobil = row.jenis_mobil;
                if (!displayJenisMobil || displayJenisMobil === '-' || displayJenisMobil === '' || displayJenisMobil === 'N/A') {
                    const masterTruck = trucksData.find(t => t.no_mobil === row.plat_nomor);
                    displayJenisMobil = masterTruck ? masterTruck.jenis_mobil : '-';
                }
                // ------------------------------------------

                return [
                    row.plat_nomor || '-',
                    displayJenisMobil, // Menggunakan hasil pencarian
                    row.nama_driver || '-',
                    row.customer || '-',
                    row.tujuan || '-',
                    row.qty || '0',
                    fmtTime(row.jadwal_bongkar),
                    fmtTime(row.tiba_lokasi_muat),
                    fmtTime(row.keluar_lokasi_muat),
                    fmtTime(row.tiba_lokasi_bongkar),
                    fmtTime(row.keluar_lokasi_bongkar),
                    tglSelesai,
                    calculateLeadTime(row.tiba_lokasi_bongkar),
                    row.fo || '-'
                ];
            });

            const finalData = [headers, ...body];
            const worksheet = XLSX.utils.aoa_to_sheet(finalData);
            
            // Styling Header Sedikit (Opsional agar rapi)
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const address = XLSX.utils.encode_col(C) + "1";
                if (!worksheet[address]) continue;
                worksheet[address].s = { font: { bold: true }, fill: { fgColor: { rgb: "E2E8F0" } } };
            }

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Laporan Ritase");
            XLSX.writeFile(workbook, `Laporan_Ritase_${getFilenameTimestamp()}.xlsx`);
        };

        window.exportRitaseToPdf = () => {
            const dataToExport = paginationState.ritaseTruck.filteredData;
            if (!dataToExport || dataToExport.length === 0) {
                showErrorAlert("Gagal Export", "Tidak ada data untuk diexport.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });
            
            const fmtTime = (isoString) => {
                if (!isoString || !isoString.includes('T')) return '-';
                const [datePart, timePart] = isoString.split('T');
                const [year, month, day] = datePart.split('-');
                return `${day}/${month}/${year}\n${timePart}`;
            };

            const head = [[
                "PLAT NOMOR", "JENIS", "DRIVER", "CUSTOMER", "KOTA", "QTY", "JADWAL",
                "TIBA MUAT", "KELUAR MUAT", "TIBA BONGKAR", "KELUAR BONGKAR", 
                "TGL SELESAI", "LAMA INAP", "FO"
            ]];
            
            const body = dataToExport.map((row) => {
                const tglSelesai = row.timestamp_selesai?.toDate() 
                    ? fmtTime(row.timestamp_selesai.toDate().toISOString().slice(0, 16)) 
                    : '-';

                // --- LOGIKA PERBAIKAN: CARI JENIS MOBIL ---
                // Sama persis seperti tampilan di Tabel
                let displayJenisMobil = row.jenis_mobil;
                if (!displayJenisMobil || displayJenisMobil === '-' || displayJenisMobil === '' || displayJenisMobil === 'N/A') {
                    const masterTruck = trucksData.find(t => t.no_mobil === row.plat_nomor);
                    displayJenisMobil = masterTruck ? masterTruck.jenis_mobil : '-';
                }
                // ------------------------------------------

                return [
                    row.plat_nomor || '-',
                    displayJenisMobil, // Menggunakan hasil pencarian
                    row.nama_driver || '-',
                    row.customer || '-',
                    row.tujuan || '-',
                    row.qty || '0',
                    fmtTime(row.jadwal_bongkar),
                    fmtTime(row.tiba_lokasi_muat),
                    fmtTime(row.keluar_lokasi_muat),
                    fmtTime(row.tiba_lokasi_bongkar),
                    fmtTime(row.keluar_lokasi_bongkar),
                    tglSelesai,
                    calculateLeadTime(row.tiba_lokasi_bongkar),
                    row.fo || '-'
                ];
            });

            doc.autoTable({ 
                head: head,
                body: body,
                startY: 20, 
                theme: 'grid', 
                styles: { fontSize: 5, halign: 'center', cellPadding: 1, valign: 'middle' }, 
                headStyles: { fillColor: [79, 70, 229], valign: 'middle' }
            });
            
            doc.save(`Laporan_Ritase_${getFilenameTimestamp()}.pdf`);
        };
        
        function updateRealTimeClock() {
            const clockElement = document.getElementById('export-timestamp');
            if (clockElement) {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
                clockElement.textContent = now.toLocaleString('id-ID', options);
            }
        }

        function getFormattedTimestamp() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short' };
            return now.toLocaleString('id-ID', options);
        }

        function getFilenameTimestamp() {
            const now = new Date();
            const YYYY = now.getFullYear();
            const MM = String(now.getMonth() + 1).padStart(2, '0');
            const DD = String(now.getDate()).padStart(2, '0');
            const HH = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            return `${YYYY}-${MM}-${DD}_${HH}-${mm}`;
        }
        
        const pageTitles = { home: 'Home', statusTruck: 'Status Truck (View Only)', updateStatus: 'Update Status Truck', listTruck: 'List Truck Anda', updateDimensi: 'Update Dimensi Truck', ritaseTruck: 'Laporan Ritase Truck', summaryReport: 'Summary Report' };
        
        window.showContent = (contentId) => {
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(contentId).classList.add('active');
            document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
            document.getElementById(`nav-${contentId}`).classList.add('active');
            document.getElementById('page-title').textContent = pageTitles[contentId];

            if (contentId === 'listTruck') filterTable();
            if (contentId === 'ritaseTruck') fetchAndRenderRitase();
            if (contentId === 'summaryReport') {
                document.getElementById('summaryFilterJenisMobil').value = 'all';
                document.getElementById('summaryFilterStatus').value = 'all';
                renderSummaryReport();
            } 
            else if (contentId === 'updateStatus') { rerenderUpdateStatusCards(); }
            else if (contentId === 'statusTruck') displayStatusCards(trucksData);
            else if (contentId === 'updateDimensi') displayDimensiTable(trucksData);
        };

        window.toggleAddForm = (forceClose = false) => {
            const form = document.getElementById('addForm');
            const isHidden = form.classList.contains('hidden');
            if (forceClose || !isHidden) {
                form.classList.add('hidden');
            } else {
                form.reset();
                form.classList.remove('hidden');
            }
        };

        window.addTruck = async function() {
            const newTruck = {
                angkutan: currentUserData.angkutanName,
                no_mobil: document.getElementById('newNoMobil').value.trim(),
                jenis_mobil: document.getElementById('newJenisMobil').value,
                nama_driver: document.getElementById('newNamaDriver').value.trim(),
                no_hp: document.getElementById('newNoHp').value.trim(),
                keterangan: "TERSEDIA",
                fo: "", customer: "", tujuan: ""
            };
            if (!newTruck.no_mobil || !newTruck.jenis_mobil) {
                showErrorAlert("Input Tidak Lengkap", "Kolom Plat Nomor dan Jenis Mobil wajib diisi.");
                return;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/trucks`), newTruck);
                window.toggleAddForm(true);
                showSuccessAlert("Berhasil", `Truk ${newTruck.no_mobil} berhasil ditambahkan.`);
            } 
            catch (error) {
                showErrorAlert("Gagal Menambahkan", "Gagal menyimpan data baru.");
                console.error("Add truck error: ", error);
            }
        };
        
        window.filterTable = function() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            paginationState.listTruck.filteredData = trucksData.filter(truck => 
                Object.values(truck).some(val => String(val).toLowerCase().includes(searchTerm))
            );
            paginationState.listTruck.currentPage = 1;
            renderTruckList();
        }

        function renderTruckList() {
            const tableBody = document.getElementById('truckTable').querySelector('tbody');
            tableBody.innerHTML = '';
            const { currentPage, filteredData } = paginationState.listTruck;

            if (!filteredData || filteredData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-slate-500">Belum ada data truk. Silakan tambahkan.</td></tr>`;
                renderPagination('truckTablePagination', 'listTruck', renderTruckList);
                return;
            }
            
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedData = filteredData.slice(start, end);

            paginatedData.forEach((truck) => tableBody.appendChild(createTableRow(truck)));
            renderPagination('truckTablePagination', 'listTruck', renderTruckList);
        }

        function createTableRow(truck) {
            const row = document.createElement('tr');
            row.className = 'bg-white border-b hover:bg-slate-50';
            row.setAttribute('data-id', truck.firestoreId);
            updateTableRow(truck, row);
            return row;
        }

        function updateTableRow(truck, rowElement) {
            const row = rowElement || document.querySelector(`#truckTable tr[data-id="${truck.firestoreId}"]`);
            if (!row) return;
            row.innerHTML = `
                <td data-field="no_mobil" class="px-6 py-4 font-medium">${truck.no_mobil || '-'}</td>
                <td data-field="jenis_mobil" class="px-6 py-4">${truck.jenis_mobil || '-'}</td>
                <td data-field="nama_driver" class="px-6 py-4">${truck.nama_driver || '-'}</td>
                <td data-field="no_hp" class="px-6 py-4">${truck.no_hp || '-'}</td>
                <td class="px-6 py-4 action-buttons flex items-center gap-2">
                    <button class="edit p-2 text-xs text-white bg-amber-500 rounded-lg hover:bg-amber-600" title="Edit" onclick="window.editRow('${truck.firestoreId}')"><i class="fas fa-pencil-alt"></i></button>
                    <button class="delete p-2 text-xs text-white bg-red-600 rounded-lg hover:bg-red-700" title="Hapus" onclick="window.deleteTruck('${truck.firestoreId}', '${truck.no_mobil}')"><i class="fas fa-trash"></i></button>
                </td>`;
        }
        
        window.cancelEdit = () => filterTable();

        window.deleteTruck = async (firestoreId, noMobil) => {
            showConfirmAlert(
                "Konfirmasi Hapus",
                `Yakin ingin menghapus truk ${noMobil}? Tindakan ini tidak dapat dibatalkan.`,
                "Ya, Hapus!",
                async (isConfirmed) => {
                    if (isConfirmed) {
                        try { 
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/trucks`, firestoreId));
                            showSuccessAlert("Dihapus!", `Truk ${noMobil} telah berhasil dihapus.`);
                        }
                        catch (error) { 
                            showErrorAlert("Gagal Menghapus", "Terjadi kesalahan saat menghapus data.");
                            console.error("Delete truck error: ", error);
                        }
                    }
                }
            );
        };

        window.editRow = (firestoreId) => {
            cancelEdit();
            const row = document.querySelector(`tr[data-id="${firestoreId}"]`); if (!row) return;
            const truck = trucksData.find(t => t.firestoreId === firestoreId); if (!truck) return;
            
            const createInput = (value) => `<input type="text" class="w-full p-2 border border-slate-300 rounded-lg" value="${value}">`;
            
            const createJenisTruckSelect = (selectedValue) => {
                let optionsHtml = jenisTruckData.map(jenis => 
                    `<option value="${jenis.name}" ${jenis.name === selectedValue ? 'selected' : ''}>${jenis.name}</option>`
                ).join('');
                return `<select class="w-full p-2 border border-slate-300 rounded-lg">${optionsHtml}</select>`;
            };

            row.querySelector('td[data-field="no_mobil"]').innerHTML = createInput(truck.no_mobil || '');
            row.querySelector('td[data-field="jenis_mobil"]').innerHTML = createJenisTruckSelect(truck.jenis_mobil);
            row.querySelector('td[data-field="nama_driver"]').innerHTML = createInput(truck.nama_driver || '');
            row.querySelector('td[data-field="no_hp"]').innerHTML = createInput(truck.no_hp || '');
            
            row.querySelector('.action-buttons').innerHTML = `<button class="save p-2 text-xs text-white bg-green-600 rounded-lg" onclick="window.saveRow('${firestoreId}')"><i class="fas fa-check"></i></button><button class="cancel p-2 text-xs text-white bg-gray-500 rounded-lg ml-2" onclick="window.cancelEdit()"><i class="fas fa-times"></i></button>`;
        };

        window.saveRow = async (firestoreId) => {
            const row = document.querySelector(`tr[data-id="${firestoreId}"]`); if (!row) return;
            const updatedData = {
                no_mobil: row.querySelector('td[data-field="no_mobil"] input').value,
                jenis_mobil: row.querySelector('td[data-field="jenis_mobil"] select').value,
                nama_driver: row.querySelector('td[data-field="nama_driver"] input').value,
                no_hp: row.querySelector('td[data-field="no_hp"] input').value,
            };
            
            const truckDocRef = doc(db, `artifacts/${appId}/public/data/trucks`, firestoreId);
            try { 
                await updateDoc(truckDocRef, updatedData); 
                showSuccessAlert("Berhasil", `Data truk ${updatedData.no_mobil} berhasil disimpan.`);
            } catch (error) { 
                showErrorAlert("Gagal Menyimpan", "Gagal menyimpan perubahan.");
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            setInterval(updateRealTimeClock, 1000);
            document.getElementById('copyright-year-login-vendor').textContent = new Date().getFullYear();
            
            document.getElementById('loginButton').addEventListener('click', () => signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value).catch(e => {
                 document.getElementById('loginError').textContent = 'Email atau password salah.';
                 showErrorAlert('Login Gagal', 'Email atau password salah.');
            }));
            
            document.getElementById('logoutButton').addEventListener('click', () => {
                showConfirmAlert(
                    "Konfirmasi Logout", 
                    "Apakah Anda yakin ingin keluar?", 
                    "Ya, Logout", 
                    (isConfirmed) => {
                        if (isConfirmed) {
                            signOut(auth);
                        }
                    }
                );
            });
            document.getElementById('copyright-year').textContent = new Date().getFullYear();
            
            // GANTI DENGAN INI
            document.getElementById('applyDateFilterBtn').addEventListener('click', () => {
                // Panggil fetch dengan mode filter = true
                fetchAndRenderRitase(true);
            });
            // GANTI DENGAN INI
            // GANTI LOGIKA TOMBOL RESET DENGAN INI
            document.getElementById('resetDateFilterBtn').addEventListener('click', () => {
                // 1. Kosongkan Input Tanggal Secara Visual
                document.getElementById('ritaseStartDate').value = '';
                document.getElementById('ritaseEndDate').value = '';
                
                // 2. Tampilkan Loading di Tabel
                const tableBody = document.getElementById('ritaseTableBody');
                tableBody.innerHTML = `<tr><td colspan="10" class="text-center p-8 text-slate-500"><i class="fas fa-sync fa-spin mr-2"></i>Mereset data...</td></tr>`;

                // 3. Panggil Fetch Mode Default (False)
                // Ini akan mengambil ulang 50 data terakhir dari database
                fetchAndRenderRitase(false); 
            });

            document.getElementById('summaryFilterJenisMobil').addEventListener('change', renderSummaryReport);
            document.getElementById('summaryFilterStatus').addEventListener('change', renderSummaryReport);
            document.getElementById('summaryFilterCustomer').addEventListener('change', renderSummaryReport); // <--- TAMBAHKAN INI

            document.addEventListener('click', (event) => {
                const popup = document.getElementById('header-filter-popup');
                if (!popup.classList.contains('hidden') && !popup.contains(event.target) && !event.target.closest('th[data-filter]')) {
                    closeFilterPopup();
                }
            });

            const sidebar = document.getElementById('sidebar');
            const openBtn = document.getElementById('sidebar-open-btn');
            const closeBtn = document.getElementById('sidebar-close-btn');
            const overlay = document.getElementById('sidebar-overlay');

            const openSidebar = () => {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            };

            const closeSidebar = () => {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            };

            openBtn.addEventListener('click', openSidebar);
            closeBtn.addEventListener('click', closeSidebar);
            overlay.addEventListener('click', closeSidebar);

            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth < 1024) { 
                        closeSidebar();
                    }
                });
            });
        });
    </script>
</body>
</html>
