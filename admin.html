<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Status Truck</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .hidden { display: none; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .sidebar-link.active { background-color: #4f46e5; color: white; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 0.75rem;
            width: 90%; max-width: 900px; max-height: 90vh;
            display: flex; flex-direction: column; position: relative;
        }
        .modal-close {
            position: absolute; top: 1rem; right: 1.5rem;
            font-size: 2rem; font-weight: bold; color: #64748b; cursor: pointer;
        }
        .modal-body { overflow-y: auto; }
        .status-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transition: all 0.2s ease-in-out;
        }
        th[data-sort], th[data-filter] { cursor: pointer; position: relative; }
        th[data-sort]:hover, th[data-filter]:hover { background-color: #eef2ff; }
        th[data-filter]::after {
            content: '\f0d7';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-left: 8px;
            color: #94a3b8;
        }

        .header-filter-popup {
            position: absolute;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            z-index: 1010;
            width: 250px;
            padding: 0.5rem;
        }
        .filter-options {
            max-height: 200px;
            overflow-y: auto;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .filter-item { display: block; margin-bottom: 0.5rem; }
        
        .group-header {
            background-color: #e5e7eb; /* slate-200 */
            color: #1f2937; /* slate-900 */
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .pagination-btn.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        /* Custom styles for GPS Monitoring Page */
        .gps-truck-item:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        .gps-truck-item.active {
            background-color: #e0e7ff; /* indigo-100 */
            border-left-color: #4f46e5; /* indigo-600 */
        }
        /* BARU: Aturan untuk sidebar collapse */
        #sidebar.sidebar-collapsed {
            width: 5rem; /* 80px */
        }
        #sidebar.sidebar-collapsed .sidebar-text {
            display: none;
        }
        #sidebar.sidebar-collapsed .sidebar-link {
            justify-content: center;
        }
        #sidebar.sidebar-collapsed .sidebar-link .ml-3 { /* Dibutuhkan untuk override span */
            margin-left: 0;
        }
        #sidebar.sidebar-collapsed .sidebar-toggle-icon-collapse {
            display: none;
        }
        #sidebar.sidebar-collapsed .sidebar-toggle-icon-expand {
            display: block;
        }
        #sidebar.sidebar-collapsed h1 {
            justify-content: center;
        }
        /* Transisi */
        #sidebar {
            transition: width 0.2s ease-in-out;
        }
        /* ================= KODE FINAL UNTUK LAYOUT PROYEKTOR (Full Box) ================= */

        /* Kode ini hanya aktif saat sidebar di-hide (.sidebar-collapsed) */

        /* === 1. Reset Card Padding & Alignment === */
        #sidebar.sidebar-collapsed ~ .flex-1 #home .grid.mb-8 > div,
        #sidebar.sidebar-collapsed ~ .flex-1 #home .status-card,
        #sidebar.sidebar-collapsed ~ .flex-1 #home #jenis-truck-details-grid > div {
            padding: 0; /* Hapus padding asli card (p-6) */
            align-items: stretch; /* Paksa anak-anaknya (icon, text) untuk setinggi card */
        }

        /* === 2. Pusatkan Icon & Beri Jarak === */
        #sidebar.sidebar-collapsed ~ .flex-1 #home .grid.mb-8 .p-4,
        #sidebar.sidebar-collapsed ~ .flex-1 #home .status-card .p-3,
        #sidebar.sidebar-collapsed ~ .flex-1 #home #jenis-truck-details-grid .p-3 {
            align-self: center; /* Buat icon tetap di tengah (vertikal) */
            margin: 1.5rem 0.5rem 1.5rem 1.5rem; /* Atur jarak icon */
            flex-shrink: 0; /* Mencegah icon penyok */
        }
        
        /* === 3. Atur Kontainer Teks (Judul + Angka) === */
        #sidebar.sidebar-collapsed ~ .flex-1 #home .ml-4 {
            flex: 1; 
            display: flex; 
            align-items: stretch; /* Buat Judul & Angka setinggi kontainer */
            margin-left: 0; /* Jarak icon sudah diatur */
            min-width: 0; 
        }
        
        /* === 4. Atur Blok Judul (Layout & Centering) === */
        /* Blok ini mengatur layout untuk SEMUA kartu, termasuk 4 kartu atas */
        #sidebar.sidebar-collapsed ~ .flex-1 #home .grid.mb-8 p.font-semibold,
        #sidebar.sidebar-collapsed ~ .flex-1 #home #status-details-grid p.text-slate-500,
        #sidebar.sidebar-collapsed ~ .flex-1 #home #vendor-details-grid p.text-slate-500,
        #sidebar.sidebar-collapsed ~ .flex-1 #home #jenis-truck-details-grid p.text-slate-500 {
            display: flex;
            align-items: center;     
            justify-content: center; 
            text-align: center;      
            flex: 1;                 
            padding: 1rem 0.5rem;    
            
            font-size: 2rem; 
            font-weight: 600; 
            white-space: normal;  
            line-height: 1.1;     
            min-width: 0;
            overflow: visible;
            text-overflow: clip;
            /* Garis 'color: #1f2937;' DIHAPUS dari sini */
        }

        /* === 4B. Atur Warna Hitam (Hanya Kartu Rincian) === */
        /* Blok ini HANYA menargetkan kartu rincian agar berwarna hitam */
        #sidebar.sidebar-collapsed ~ .flex-1 #home #status-details-grid p.text-slate-500,
        #sidebar.sidebar-collapsed ~ .flex-1 #home #vendor-details-grid p.text-slate-500,
        #sidebar.sidebar-collapsed ~ .flex-1 #home #jenis-truck-details-grid p.text-slate-500 {
            color: #1f2937; /* Warna hitam (slate-900) */
        }

        /* === 5. Atur Blok Angka (Kotak Abu-abu) === */
        #sidebar.sidebar-collapsed ~ .flex-1 #home .grid.mb-8 p.text-3xl,
        #sidebar.sidebar-collapsed ~ .flex-1 #home #status-details-grid p.text-2xl,
        #sidebar.sidebar-collapsed ~ .flex-1 #home #vendor-details-grid p.text-2xl,
        #sidebar.sidebar-collapsed ~ .flex-1 #home #jenis-truck-details-grid p.text-2xl {
            /* Layout */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; 
            margin-left: auto;  
            white-space: nowrap; 
            width: 12rem; /* 192px - Atur LEBAR TETAP */
            padding: 1rem 0; /* Hapus padding kiri-kanan, ganti dengan width */

            /* Font */
            font-size: 4.5rem; /* 72px - SANGAT BESAR */
            line-height: 1;
            font-weight: 700;
            color: #2735F5; /* Teks hitam */

            /* Style Kotak */
            background-color: #e5e7eb; /* Kotak abu-abu (bg-gray-200) */
            border-top-right-radius: 0.75rem; 
            border-bottom-right-radius: 0.75rem;
        }
        
        /* === 6. Perbaikan Warna Kotak untuk 4 Card di Atas === */
        #sidebar.sidebar-collapsed ~ .flex-1 #home .grid.mb-8 .bg-indigo-600 p.text-3xl { background-color: rgba(255,255,255,0.25); color: white; }
        #sidebar.sidebar-collapsed ~ .flex-1 #home .grid.mb-8 .bg-green-600 p.text-3xl { background-color: rgba(255,255,255,0.25); color: white; }
        #sidebar.sidebar-collapsed ~ .flex-1 #home .grid.mb-8 .bg-orange-600 p.text-3xl { background-color: rgba(255,255,255,0.25); color: white; }
        #sidebar.sidebar-collapsed ~ .flex-1 #home .grid.mb-8 .bg-slate-700 p.text-3xl { background-color: rgba(255,255,255,0.25); color: white; }


        /* === 7. Sembunyikan "Truk" === */
        #sidebar.sidebar-collapsed ~ .flex-1 #home .text-suffix-truk { display: none; }
        
        /* === 8. Judul Bagian === */
        #sidebar.sidebar-collapsed ~ .flex-1 #home h3.text-xl {
            font-size: 2.25rem; 
            line-height: 2.5rem;
            margin-bottom: 1.5rem; 
        }
        
        /* === 9. Hapus 'overflow-hidden' dari kontainer teks === */
        #sidebar.sidebar-collapsed ~ .flex-1 #home .ml-4.overflow-hidden {
            overflow: visible; 
        }
        
        /* ======================= AKHIR DARI KODE BARU ======================= */
        
        /* ======================= AKHIR DARI KODE BARU ======================= */
        /* === BARU: Sembunyikan suffix "Truk" saat di-hide === */
        #sidebar.sidebar-collapsed ~ .flex-1 #home .text-suffix-truk {
            display: none;
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="loading-container" class="min-h-screen flex flex-col items-center justify-center">
        <i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i>
        <p class="mt-4 text-slate-600 font-semibold">Memuat Aplikasi...</p>
    </div>

    <div id="login-container" class="min-h-screen flex items-center justify-center bg-slate-100 p-4 hidden">
        <div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl overflow-hidden md:flex">
            <div class="hidden md:block md:w-1/2 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1579869847514-432b8a3d3b37?q=80&w=2574&auto=format&fit=crop');">
                <div class="h-full w-full bg-indigo-900 bg-opacity-60 p-10 flex flex-col justify-between">
                    <div>
                        <h1 class="text-3xl font-bold tracking-wider text-white"><i class="fas fa-truck-moving mr-2"></i>LOG IKK</h1>
                        <p class="text-indigo-200 mt-2">Platform Monitoring Status Truck.</p>
                    </div>
                    <div class="text-indigo-100 text-sm">
                        &copy; <span id="copyright-year-login-admin"></span> Jagaddhita Arya Koswara
                    </div>
                </div>
            </div>

            <div class="w-full md:w-1/2 p-8 md:p-12">
                <h2 class="text-3xl font-bold text-slate-800 mb-2">Login Admin</h2>
                <p class="text-slate-500 mb-8">Selamat datang kembali, silakan masuk.</p>
                
                <div class="space-y-6">
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <i class="fas fa-envelope text-slate-400"></i>
                        </span>
                        <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 pl-10 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <i class="fas fa-lock text-slate-400"></i>
                        </span>
                        <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 pl-10 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    </div>

                    <div id="loginError" class="text-red-500 text-sm h-4"></div>
                    
                    <button id="loginButton" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Masuk</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="dashboard-container" class="hidden">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>

        <div class="relative min-h-screen lg:flex">
            <aside id="sidebar" class="bg-slate-800 text-white w-64 flex-shrink-0 fixed inset-y-0 left-0 transform -translate-x-full lg:relative lg:translate-x-0 transition-transform duration-300 ease-in-out z-40 flex flex-col">
                <div class="h-16 flex items-center justify-between px-4 border-b border-slate-700 flex-shrink-0">
                     <h1 class="text-2xl font-bold tracking-wider flex items-center"><i class="fas fa-truck-moving w-6 text-center"></i><span class="ml-3 sidebar-text">LOG IKK</span></h1>
                     <button id="sidebar-close-btn" class="lg:hidden text-2xl text-slate-400 hover:text-white">&times;</button>
                </div>
                <nav class="flex-grow px-4 py-4 overflow-y-auto">
                    <a href="#" id="nav-home" class="sidebar-link flex items-center px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('home')">
                        <i class="fas fa-home w-6 text-center"></i><span class="ml-3 sidebar-text">Home</span>
                    </a>
                    <a href="#" id="nav-realtimeMonitoring" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('realtimeMonitoring')">
                        <i class="fas fa-map-marked-alt w-6 text-center"></i><span class="ml-3 sidebar-text">Realtime Monitoring</span>
                    </a>
                    <a href="#" id="nav-statusTruck" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('statusTruck')">
                        <i class="fas fa-eye w-6 text-center"></i><span class="ml-3 sidebar-text">Status Truck</span>
                    </a>
                    <a href="#" id="nav-listTruck" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('listTruck')">
                        <i class="fas fa-list-ul w-6 text-center"></i><span class="ml-3 sidebar-text">List Truck</span>
                    </a>
                    <a href="#" id="nav-masterCustomer" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('masterCustomer')">
                        <i class="fas fa-users w-6 text-center"></i><span class="ml-3 sidebar-text">Master Customer</span>
                    </a>
                    <a href="#" id="nav-masterJenisTruck" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('masterJenisTruck')">
                        <i class="fas fa-tags w-6 text-center"></i><span class="ml-3 sidebar-text">Master Jenis Truck</span>
                    </a>
                    <a href="#" id="nav-ritaseTruck" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('ritaseTruck')">
                        <i class="fas fa-route w-6 text-center"></i><span class="ml-3 sidebar-text">Ritase Truck</span>
                    </a>
                    <a href="#" id="nav-summaryReport" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('summaryReport')">
                        <i class="fas fa-chart-pie w-6 text-center"></i><span class="ml-3 sidebar-text">Summary Report</span>
                    </a>
                    <a href="#" id="nav-laporanInap" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('laporanInap')">
                        <i class="fas fa-bed w-6 text-center"></i><span class="ml-3 sidebar-text">Summary Inap</span>
                    </a>
                    <a href="#" id="nav-costAnalysis" class="sidebar-link flex items-center mt-2 px-4 py-3 rounded-lg font-semibold hover:bg-slate-700" onclick="window.showContent('costAnalysis')">
                        <i class="fas fa-money-bill-wave w-6 text-center"></i><span class="ml-3 sidebar-text">Analisa Biaya</span>
                    </a>
                </nav>

                <div class="border-t border-slate-700 p-4 flex-shrink-0 hidden lg:flex">
                    <button id="sidebar-toggle-btn" class="w-full flex items-center justify-start text-slate-400 hover:text-white" title="Toggle Sidebar">
                        <i class="fas fa-chevron-left w-6 text-center sidebar-toggle-icon-collapse"></i>
                        <i class="fas fa-chevron-right w-6 text-center sidebar-toggle-icon-expand hidden"></i>
                    </button>
                </div>
            </aside>

            <div class="flex-1 flex flex-col overflow-hidden">
                <header class="bg-white shadow-md">
                    <div class="flex h-16 items-center justify-between px-4 lg:px-8">
                        <div class="flex items-center">
                            <button id="sidebar-open-btn" class="lg:hidden text-2xl mr-4 text-slate-600">
                                <i class="fas fa-bars"></i>
                            </button>
                            <h2 id="page-title" class="text-xl lg:text-2xl font-bold text-slate-700 whitespace-nowrap">Home</h2>
                        </div>
                        <div class="flex items-center gap-2 lg:gap-4">
                            <div id="currentUserDisplay" class="text-xs sm:text-sm font-medium text-slate-500 text-right"></div>
                            <button id="logoutButton" class="bg-red-500 text-white font-semibold px-3 py-2 lg:px-4 rounded-lg hover:bg-red-600 text-sm">Logout</button>
                        </div>
                    </div>
                </header>
                
                <main class="flex-grow p-4 md:p-6 lg:p-8 overflow-y-auto">
                    <div id="home" class="content-section">
                        <div class="mb-8 p-6 bg-white rounded-xl shadow-md">
                            <h2 id="welcome-title" class="text-2xl font-bold text-slate-800">Selamat Datang!</h2>
                            <p id="current-date" class="text-slate-500"></p>
                        </div>
                    
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="bg-indigo-600 text-white p-6 rounded-xl shadow-lg flex items-center">
                                <div class="p-4 bg-indigo-500 rounded-full">
                                    <i class="fas fa-truck text-3xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p id="total-truck-title" class="font-semibold">Total Truk</p>
                                    <p id="total-truck-count" class="text-3xl font-bold">0</p>
                                </div>
                            </div>
                            <div id="total-angkutan-card" class="bg-orange-600 text-white p-6 rounded-xl shadow-lg flex items-center">
                                <div class="p-4 bg-orange-500 rounded-full"><i class="fas fa-building text-3xl"></i></div>
                                <div class="ml-4">
                                    <p class="font-semibold">Total Vendor</p>
                                    <p id="total-angkutan-count" class="text-3xl font-bold">0</p>
                                </div>
                            </div>
                            
                            <div class="bg-green-600 text-white p-6 rounded-xl shadow-lg flex items-center">
                            <div class="p-4 bg-green-500 rounded-full">
                                <i class="fas fa-check-circle text-3xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="font-semibold">Sudah Alokasi</p>
                                <p id="active-truck-count" class="text-3xl font-bold">0</p>
                            </div>
                            </div>
                            <div class="bg-slate-700 text-white p-6 rounded-xl shadow-lg flex items-center">
                                <div class="p-4 bg-slate-600 rounded-full">
                                    <i class="fas fa-times-circle text-3xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="font-semibold">Belum Alokasi</p>
                                    <p id="available-truck-count" class="text-3xl font-bold">0</p>
                                </div>
                            </div>



                        </div>
                    
                        <div>
                            <h3 class="text-xl font-bold text-slate-700 mb-4">Rincian Status Armada</h3>
                            <div id="status-details-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            </div>
                        </div>

                        <div class="mt-8">
                            <h3 class="text-xl font-bold text-slate-700 mb-4">Rincian Armada per Vendor</h3>
                            <div id="vendor-details-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            </div>
                        </div>
                        
                        <div class="mt-8">
                            <h3 class="text-xl font-bold text-slate-700 mb-4">Rincian Armada per Jenis Truk</h3>
                            <div id="jenis-truck-details-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                                </div>
                        </div>
                    </div>
                    
                    <div id="realtimeMonitoring" class="content-section">
                        <div class="bg-white rounded-xl shadow-md overflow-hidden">
                            <div class="p-4 border-b flex justify-between items-center">
                                <h4 class="text-lg font-bold text-slate-800">Realtime GPS Monitoring</h4>
                                <div class="flex items-center gap-4">
                                    <span id="gps-loading-indicator" class="hidden text-sm text-slate-500"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat data...</span>
                                    <button id="refresh-gps-btn" onclick="window.updateTrucksOnRealtimeMap()" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm flex items-center gap-2">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="flex flex-col md:flex-row" style="height: 78vh;">
                                <div id="map-container" class="w-full md:w-3/4 h-64 md:h-full">
                                    <div id="realtimemap" class="w-full h-full"></div>
                                </div>
                                <div id="gps-truck-list-panel" class="w-full md:w-1/4 h-full bg-slate-50 border-l overflow-y-auto">
                                    <div class="p-4 border-b">
                                        <input type="text" id="gps-search-input" placeholder="Cari plat nomor..." class="w-full p-2 border rounded-lg">
                                    </div>
                                    <div id="gps-truck-list" class="divide-y">
                                        </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="statusTruck" class="content-section">
                        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Filter Status</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label for="statusCardFilterAngkutan" class="block text-sm font-medium text-slate-600 mb-1">Angkutan</label><select id="statusCardFilterAngkutan" onchange="window.displayStatusCards()" class="w-full p-2 border border-slate-300 rounded-lg"></select></div>
                                <div><label for="statusCardFilterJenisMobil" class="block text-sm font-medium text-slate-600 mb-1">Jenis Truck</label><select id="statusCardFilterJenisMobil" onchange="window.displayStatusCards()" class="w-full p-2 border border-slate-300 rounded-lg"></select></div>
                                <div><label for="statusCardFilterStatus" class="block text-sm font-medium text-slate-600 mb-1">Status</label><select id="statusCardFilterStatus" onchange="window.displayStatusCards()" class="w-full p-2 border border-slate-300 rounded-lg"></select></div>
                            </div>
                        </div>
                        <div id="readOnlyTruckList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>

                    <div id="listTruck" class="content-section">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                            <button class="flex items-center gap-2 bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700" onclick="window.toggleAddForm()"><i class="fas fa-plus"></i> Tambah Data</button>
                            <div class="relative w-full md:w-1/3"><span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-slate-400"></i></span><input type="text" id="searchInput" onkeyup="window.filterTable()" placeholder="Cari data truk..." class="w-full p-2 pl-10 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></div>
                        </div>
                        
                        <form class="add-form hidden bg-white p-6 rounded-xl shadow-md mb-6" id="addForm">
                            <h4 class="text-xl font-bold text-slate-700 mb-4">Tambah Truk Baru</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <select id="newAngkutan" class="w-full p-2 border border-slate-300 rounded-lg"></select>
                                <input type="text" id="newNoMobil" placeholder="Plat Nomor" class="w-full p-2 border border-slate-300 rounded-lg">
                                <select id="newJenisMobil" class="w-full p-2 border border-slate-300 rounded-lg">
                                </select>
                                <input type="text" id="newNamaDriver" placeholder="Nama Driver" class="w-full p-2 border border-slate-300 rounded-lg">
                                <input type="text" id="newNoHp" placeholder="No HP Driver" class="w-full p-2 border border-slate-300 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <button type="button" class="w-full bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700" onclick="window.addTruck()">Simpan</button>
                                    <button type="button" class="w-full bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg" onclick="window.toggleAddForm()">Batal</button>
                                </div>
                            </div>
                        </form>

                        <div class="bg-white rounded-xl shadow-md overflow-x-auto">
                            <table id="truckTable" class="w-full text-sm text-left text-slate-600">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                    <tr>
                                        <th class="px-6 py-3">Angkutan</th>
                                        <th class="px-6 py-3">Plat Nomor</th>
                                        <th class="px-6 py-3">Jenis Mobil</th>
                                        <th class="px-6 py-3">Status</th>
                                        <th class="px-6 py-3">Customer</th>
                                        <th class="px-6 py-3">Tujuan</th>
                                        <th class="px-6 py-3">Driver</th>
                                        <th class="px-6 py-3">No HP</th>
                                        <th class="px-6 py-3">FO</th>
                                        <th class="px-6 py-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div id="truckTablePagination" class="mt-4 flex justify-center items-center gap-2"></div>
                    </div>

                    <div id="masterCustomer" class="content-section">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                            <button class="flex items-center gap-2 bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700" onclick="window.toggleAddCustomerForm()"><i class="fas fa-plus"></i> Tambah Customer</button>
                            <div class="relative w-full md:w-1/3">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-slate-400"></i></span>
                                <input type="text" id="customerSearchInput" onkeyup="window.filterCustomerTable()" placeholder="Cari nama customer..." class="w-full p-2 pl-10 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                        
                        <form class="hidden bg-white p-6 rounded-xl shadow-md mb-6" id="addCustomerForm">
                            <h4 class="text-xl font-bold text-slate-700 mb-4">Tambah Customer Baru</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input type="text" id="newCustomerName" placeholder="Nama Customer" class="w-full p-2 border border-slate-300 rounded-lg">
                                <select id="newCustomerType" class="w-full p-2 border border-slate-300 rounded-lg">
                                    <option value="BU17">BU17</option>
                                    <option value="CMI">CMI</option>
                                </select>
                                <div class="flex items-center gap-2">
                                    <button type="button" class="w-full bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700" onclick="window.addCustomer()">Simpan</button>
                                    <button type="button" class="w-full bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg" onclick="window.toggleAddCustomerForm()">Batal</button>
                                </div>
                            </div>
                        </form>

                        <div class="bg-white rounded-xl shadow-md overflow-x-auto">
                            <table id="customerTable" class="w-full text-sm text-left text-slate-600">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                    <tr>
                                        <th class="px-6 py-3">Nama Customer</th>
                                        <th class="px-6 py-3">Tipe</th>
                                        <th class="px-6 py-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div id="customerTablePagination" class="mt-4 flex justify-center items-center gap-2"></div>
                    </div>

                    <div id="masterJenisTruck" class="content-section">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                            <button class="flex items-center gap-2 bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700" onclick="window.toggleAddJenisTruckForm()"><i class="fas fa-plus"></i> Tambah Jenis Truck</button>
                            <div class="relative w-full md:w-1/3">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-slate-400"></i></span>
                                <input type="text" id="jenisTruckSearchInput" onkeyup="window.filterJenisTruckTable()" placeholder="Cari nama jenis truck..." class="w-full p-2 pl-10 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                        
                        <form class="hidden bg-white p-6 rounded-xl shadow-md mb-6" id="addJenisTruckForm">
                            <h4 class="text-xl font-bold text-slate-700 mb-4">Tambah Jenis Truck Baru</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input type="text" id="newJenisTruckName" placeholder="Nama Jenis Truck (e.g., WINGBOX)" class="w-full p-2 border border-slate-300 rounded-lg md:col-span-2">
                                <div class="flex items-center gap-2">
                                    <button type="button" class="w-full bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700" onclick="window.addJenisTruck()">Simpan</button>
                                    <button type="button" class="w-full bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg" onclick="window.toggleAddJenisTruckForm()">Batal</button>
                                </div>
                            </div>
                        </form>

                        <div class="bg-white rounded-xl shadow-md overflow-x-auto">
                            <table id="jenisTruckTable" class="w-full text-sm text-left text-slate-600">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                    <tr>
                                        <th class="px-6 py-3">Nama Jenis Truck</th>
                                        <th class="px-6 py-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                         <div id="jenisTruckTablePagination" class="mt-4 flex justify-center items-center gap-2"></div>
                    </div>

                    <div id="ritaseTruck" class="content-section">
                        <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Filter Berdasarkan Tanggal Selesai</h4>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                <div>
                                    <label for="ritaseStartDate" class="block text-sm font-medium text-slate-600 mb-1">Dari Tanggal</label>
                                    <input type="date" id="ritaseStartDate" class="w-full p-2 border border-slate-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="ritaseEndDate" class="block text-sm font-medium text-slate-600 mb-1">Sampai Tanggal</label>
                                    <input type="date" id="ritaseEndDate" class="w-full p-2 border border-slate-300 rounded-lg">
                                </div>
                                <div class="flex gap-2">
                                    <button id="applyDateFilterBtn" class="w-full bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700">
                                        <i class="fas fa-filter mr-2"></i>Terapkan
                                    </button>
                                    <button id="resetDateFilterBtn" class="w-full bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300">
                                        Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4 mt-6">
                            
                            <div class="relative w-full md:w-1/3">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                                    <i class="fas fa-search text-slate-400"></i>
                                </span>
                                <input type="text" id="ritaseSearchInput" onkeyup="window.applyRitaseFiltersAndSort()" placeholder="Cari Plat, Driver, Customer, Jenis..." class="w-full p-2 pl-10 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 shadow-sm">
                            </div>

                            <div class="flex items-center gap-2 flex-wrap justify-end">
                                <button onclick="window.openRitaseModal('add')" class="flex items-center gap-2 bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm shadow-sm transition-transform hover:scale-105">
                                    <i class="fas fa-plus"></i> Tambah Manual
                                </button>
                                <button onclick="window.loadRitaseData()" class="flex items-center gap-2 bg-slate-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-slate-600 text-sm shadow-sm transition-transform hover:scale-105" title="Muat Ulang Data">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button onclick="window.exportRitaseToExcel()" class="flex items-center gap-2 bg-green-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-700 text-sm shadow-sm transition-transform hover:scale-105">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                                <button onclick="window.exportRitaseToPdf()" class="flex items-center gap-2 bg-red-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-700 text-sm shadow-sm transition-transform hover:scale-105">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-md overflow-x-auto">
                            <table id="ritaseTable" class="w-full text-sm text-left text-slate-600">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                    <tr>
                                        <th class="px-6 py-3" data-filter="angkutanName" onclick="handleHeaderClick(event, 'angkutanName')">Angkutan</th>
                                        <th class="px-6 py-3" data-filter="plat_nomor" onclick="handleHeaderClick(event, 'plat_nomor')">Plat Nomor</th>
                                        
                                        <th class="px-6 py-3" data-filter="jenis_mobil" onclick="handleHeaderClick(event, 'jenis_mobil')">Jenis Truck</th>
                                        
                                        <th class="px-6 py-3" data-filter="nama_driver" onclick="handleHeaderClick(event, 'nama_driver')">Nama Driver</th>
                                        <th class="px-6 py-3" data-filter="customer" onclick="handleHeaderClick(event, 'customer')">Customer</th>
                                        <th class="px-6 py-3" data-filter="tujuan" onclick="handleHeaderClick(event, 'tujuan')">Kota</th>
                                        
                                        <th class="px-6 py-3">Tiba Muat</th>
                                        <th class="px-6 py-3">Keluar Muat</th>
                                        <th class="px-6 py-3">Tiba Bongkar</th>
                                        <th class="px-6 py-3">Keluar Bongkar</th>
                                        <th class="px-6 py-3" data-filter="timestamp_selesai" onclick="handleHeaderClick(event, 'timestamp_selesai')">Tanggal Selesai</th>
                                        <th class="px-6 py-3 whitespace-nowrap">Lama Inap</th>
                                        <th class="px-6 py-3" data-filter="fo" onclick="handleHeaderClick(event, 'fo')">FO</th>
                                        <th class="px-6 py-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="ritaseTableBody"></tbody>
                            </table>
                        </div>
                        <div id="ritaseTablePagination" class="mt-4 flex justify-center items-center gap-2"></div>
                    </div>

                    <div id="summaryReport" class="content-section">
                         <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">Filter Laporan</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label for="summaryFilterAngkutan" class="block text-sm font-medium text-slate-600 mb-1">Angkutan</label><select id="summaryFilterAngkutan" onchange="window.renderSummaryReport()" class="w-full p-2 border border-slate-300 rounded-lg"></select></div>
                                <div><label for="summaryFilterJenisMobil" class="block text-sm font-medium text-slate-600 mb-1">Jenis Mobil</label><select id="summaryFilterJenisMobil" onchange="window.renderSummaryReport()" class="w-full p-2 border border-slate-300 rounded-lg"></select></div>
                                <div><label for="summaryFilterStatus" class="block text-sm font-medium text-slate-600 mb-1">Status</label><select id="summaryFilterStatus" onchange="window.renderSummaryReport()" class="w-full p-2 border border-slate-300 rounded-lg"></select></div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-xl shadow-md" id="summaryReportContainer">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                                <div>
                                    <h4 class="text-xl font-bold text-slate-800">Summary Report</h4>
                                    <p id="export-timestamp" class="text-sm text-slate-500">Data saat ini</p>
                                </div>
                                <div class="flex items-center gap-2 flex-wrap">
                                    <button onclick="window.exportToExcel()" class="flex items-center gap-2 bg-green-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                                        <i class="fas fa-file-excel"></i> Export Excel
                                    </button>
                                    <button onclick="window.exportToPdf()" class="flex items-center gap-2 bg-red-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-700 text-sm">
                                        <i class="fas fa-file-pdf"></i> Export PDF
                                    </button>
                                    <button onclick="window.exportAsImage()" class="flex items-center gap-2 bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">
                                        <i class="fas fa-image"></i> Export Gambar
                                    </button>
                                </div>
                            </div>

                            <div class="overflow-x-auto">
                                <table id="summaryTable" class="w-full text-sm text-left text-slate-600">
                                    <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                        <tr>
                                            <th class="px-6 py-3">ANGKUTAN</th>
                                            <th class="px-6 py-3">FO</th>
                                            <th class="px-6 py-3">TIBA LOKASI MUAT</th>
                                            <th class="px-6 py-3">KELUAR LOKASI MUAT</th>
                                            <th class="px-6 py-3">TIBA LOKASI BONGKAR</th>
                                            <th class="px-6 py-3">KELUAR LOKASI BONGKAR</th>
                                            <th class="px-6 py-3">NAMA CUSTOMER</th>
                                            <th class="px-6 py-3">KOTA</th>
                                            <th class="px-6 py-3">STATUS</th>
                                            <th class="px-6 py-3">NAMA DRIVER</th>
                                            <th class="px-6 py-3">NO HP</th>
                                            <th class="px-6 py-3">PLAT NOMOR</th>
                                            <th class="px-6 py-3">JENIS TRUCK</th>
                                        </tr>
                                        </thead>
                                    <tbody id="summaryTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    
                    <div id="laporanInap" class="content-section">
                        <h4 id="summary-inap-title" class="text-xl font-bold text-slate-700 uppercase mb-4">SUMMARY INAP PER CUSTOMER & KOTA</h4>

                        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-lg font-bold text-slate-800">SUMMARY INAP - BU17</h4>
                                <button onclick="window.exportInapTableAsImage('inap-bu17-table', 'Summary Inap - BU17')" class="flex items-center gap-2 bg-blue-600 text-white font-semibold px-3 py-1.5 rounded-lg hover:bg-blue-700 text-sm">
                                    <i class="fas fa-image"></i> Export Gambar
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table id="inap-bu17-table" class="w-full text-sm text-left text-slate-600">
                                    <thead class="text-xs text-white uppercase bg-slate-800">
                                        <tr>
                                            <th class="px-4 py-3 w-1/2">Customer</th>
                                            <th class="px-4 py-3">Kota</th>
                                            <th class="px-4 py-3 text-center">Total Truck Inap</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inap-by-customer-table-body-bu17"></tbody>
                                    <tfoot class="bg-slate-800 font-bold text-white">
                                        <tr>
                                            <td class="px-4 py-3 text-left" colspan="2">GRAND TOTAL (BU17)</td>
                                            <td id="inap-grand-total-bu17" class="px-4 py-3 text-center text-xl">0</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-lg font-bold text-slate-800">SUMMARY INAP - CMI</h4>
                                <button onclick="window.exportInapTableAsImage('inap-cmi-table', 'Summary Inap - CMI')" class="flex items-center gap-2 bg-blue-600 text-white font-semibold px-3 py-1.5 rounded-lg hover:bg-blue-700 text-sm">
                                    <i class="fas fa-image"></i> Export Gambar
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table id="inap-cmi-table" class="w-full text-sm text-left text-slate-600">
                                    <thead class="text-xs text-white uppercase bg-slate-800">
                                        <tr>
                                            <th class="px-4 py-3 w-1/2">Customer</th>
                                            <th class="px-4 py-3">Kota</th>
                                            <th class="px-4 py-3 text-center">Total Truck Inap</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inap-by-customer-table-body-cmi"></tbody>
                                    <tfoot class="bg-slate-800 font-bold text-white">
                                        <tr>
                                            <td class="px-4 py-3 text-left" colspan="2">GRAND TOTAL (CMI)</td>
                                            <td id="inap-grand-total-cmi" class="px-4 py-3 text-center text-xl">0</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-xl font-bold text-slate-700">
                                    INAP : &lt; 3 Hari | TOTAL TRUCK : <span id="total-less-3days" class="text-indigo-600"></span>
                                </h4>
                                <button onclick="window.exportInapTableAsImage('inap-table-less-3days-table', 'INAP : < 3 Hari')" class="flex items-center gap-2 bg-blue-600 text-white font-semibold px-3 py-1.5 rounded-lg hover:bg-blue-700 text-sm">
                                    <i class="fas fa-image"></i> Export Gambar
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table id="inap-table-less-3days-table" class="w-full text-sm text-left text-slate-600">
                                    <thead class="bg-slate-800 text-white font-bold">
                                        <tr>
                                            <th class="px-6 py-3 text-left">NAMA CUSTOMER</th>
                                            <th class="px-6 py-3 text-left">KOTA</th>
                                            <th class="px-6 py-3 text-left">ANGKUTAN</th>
                                            <th class="px-6 py-3 text-left">PLAT NOMOR</th>
                                            <th class="px-6 py-3 text-left">LAMA INAP</th>
                                            <th class="px-6 py-3 text-center">JUMLAH</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inap-table-less-3days"></tbody>
                                    <tfoot id="inap-tfoot-less-3days"></tfoot>
                                </table>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-xl font-bold text-slate-700">
                                    INAP : 3 - 6 Hari | TOTAL TRUCK : <span id="total-3-6days" class="text-indigo-600"></span>
                                </h4>
                                <button onclick="window.exportInapTableAsImage('inap-table-3-6days-table', 'INAP : 3 - 6 Hari')" class="flex items-center gap-2 bg-blue-600 text-white font-semibold px-3 py-1.5 rounded-lg hover:bg-blue-700 text-sm">
                                    <i class="fas fa-image"></i> Export Gambar
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table id="inap-table-3-6days-table" class="w-full text-sm text-left text-slate-600">
                                    <thead class="bg-slate-800 text-white font-bold">
                                        <tr>
                                            <th class="px-6 py-3 text-left">NAMA CUSTOMER</th>
                                            <th class="px-6 py-3 text-left">KOTA</th>
                                            <th class="px-6 py-3 text-left">ANGKUTAN</th>
                                            <th class="px-6 py-3 text-left">PLAT NOMOR</th>
                                            <th class="px-6 py-3 text-left">LAMA INAP</th>
                                            <th class="px-6 py-3 text-center">JUMLAH</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inap-table-3-6days"></tbody>
                                    <tfoot id="inap-tfoot-3-6days"></tfoot>
                                </table>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-xl font-bold text-slate-700">
                                    INAP : 6 - 9 Hari | TOTAL TRUCK : <span id="total-6-9days" class="text-indigo-600"></span>
                                </h4>
                                <button onclick="window.exportInapTableAsImage('inap-table-6-9days-table', 'INAP : 6 - 9 Hari')" class="flex items-center gap-2 bg-blue-600 text-white font-semibold px-3 py-1.5 rounded-lg hover:bg-blue-700 text-sm">
                                    <i class="fas fa-image"></i> Export Gambar
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table id="inap-table-6-9days-table" class="w-full text-sm text-left text-slate-600">
                                    <thead class="bg-slate-800 text-white font-bold">
                                        <tr>
                                            <th class="px-6 py-3 text-left">NAMA CUSTOMER</th>
                                            <th class="px-6 py-3 text-left">KOTA</th>
                                            <th class="px-6 py-3 text-left">ANGKUTAN</th>
                                            <th class="px-6 py-3 text-left">PLAT NOMOR</th>
                                            <th class="px-6 py-3 text-left">LAMA INAP</th>
                                            <th class="px-6 py-3 text-center">JUMLAH</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inap-table-6-9days"></tbody>
                                    <tfoot id="inap-tfoot-6-9days"></tfoot>
                                </table>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-xl font-bold text-slate-700">
                                    INAP : > 9 Hari | TOTAL TRUCK : <span id="total-more-9days" class="text-indigo-600"></span>
                                </h4>
                                <button onclick="window.exportInapTableAsImage('inap-table-more-9days-table', 'INAP : > 9 Hari')" class="flex items-center gap-2 bg-blue-600 text-white font-semibold px-3 py-1.5 rounded-lg hover:bg-blue-700 text-sm">
                                    <i class="fas fa-image"></i> Export Gambar
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table id="inap-table-more-9days-table" class="w-full text-sm text-left text-slate-600">
                                    <thead class="bg-slate-800 text-white font-bold">
                                        <tr>
                                            <th class="px-6 py-3 text-left">NAMA CUSTOMER</th>
                                            <th class="px-6 py-3 text-left">KOTA</th>
                                            <th class="px-6 py-3 text-left">ANGKUTAN</th>
                                            <th class="px-6 py-3 text-left">PLAT NOMOR</th>
                                            <th class="px-6 py-3 text-left">LAMA INAP</th>
                                            <th class="px-6 py-3 text-center">JUMLAH</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inap-table-more-9days"></tbody>
                                    <tfoot id="inap-tfoot-more-9days"></tfoot>
                                </table>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-xl shadow-md mt-8">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-xl font-bold text-slate-700">DETAIL STATUS TRUCK INAP</h4>
                                <button onclick="window.exportInapTableAsImage('inap-detail-table', 'Detail Status Truck Inap')" class="flex items-center gap-2 bg-blue-600 text-white font-semibold px-3 py-1.5 rounded-lg hover:bg-blue-700 text-sm">
                                    <i class="fas fa-image"></i> Export Gambar
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table id="inap-detail-table" class="w-full text-sm text-left text-slate-600">
                                    <thead class="text-xs text-white uppercase bg-slate-800">
                                        <tr>
                                            <th class="px-4 py-3">No</th>
                                            <th class="px-4 py-3">Angkutan</th>
                                            <th class="px-4 py-3">FO</th>
                                            <th class="px-4 py-3">Tiba Lokasi Muat</th>
                                            <th class="px-4 py-3">Keluar Lokasi Muat</th>
                                            <th class="px-4 py-3">Tiba Lokasi Bongkar</th>
                                            <th class="px-4 py-3">Keluar Lokasi Bongkar</th>
                                            <th class="px-4 py-3">Nama Customer</th>
                                            <th class="px-4 py-3">Kota</th>
                                            <th class="px-4 py-3">Status</th>
                                            <th class="px-4 py-3">Nama Driver</th>
                                            <th class="px-4 py-3">No HP</th>
                                            <th class="px-4 py-3">Plat Nomor</th>
                                            <th class="px-4 py-3">Jenis Truck</th>
                                            <th class="px-4 py-3">Lama Inap</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inap-detail-table-body"></tbody>
                                </table>
                            </div>
                        </div>

                    </div>

                    <div id="costAnalysis" class="content-section">

                        <div class="mb-6 flex space-x-4 border-b border-slate-300">
                            <button onclick="window.switchCostTab('tab-master-fix')" class="cost-tab-btn px-4 py-2 border-b-2 border-indigo-600 font-bold text-indigo-600 focus:outline-none" id="btn-tab-master-fix">Master Fix Cost</button>
                            <button onclick="window.switchCostTab('tab-master-var')" class="cost-tab-btn px-4 py-2 border-b-2 border-transparent font-medium text-slate-500 hover:text-indigo-600 focus:outline-none" id="btn-tab-master-var">Master Variable Cost</button>
                            <button onclick="window.switchCostTab('tab-report')" class="cost-tab-btn px-4 py-2 border-b-2 border-transparent font-medium text-slate-500 hover:text-indigo-600 focus:outline-none" id="btn-tab-report">Laporan Keuangan</button>
                        </div>

                        <div id="tab-master-fix" class="cost-tab-content">
                            <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                                <h4 class="text-lg font-bold text-slate-700 mb-4">Input Fix Cost (Sewa Bulanan)</h4>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600">Pilih Vendor</label>
                                        <select id="fixCostVendor" class="w-full p-2 border rounded-lg" onchange="window.populatePlateForFixCost()"></select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600">Pilih Plat Nomor</label>
                                        <select id="fixCostPlate" class="w-full p-2 border rounded-lg"></select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600">Biaya Sewa (Rp/Bulan)</label>
                                        <input type="number" id="fixCostValue" class="w-full p-2 border rounded-lg" placeholder="Contoh: 25000000">
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="window.saveFixCost()" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 w-full">Simpan Manual</button>
                                        <button onclick="window.autoGenerateFixCost()" class="bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-700 w-full" title="Isi otomatis sesuai harga kontrak vendor">
                                            <i class="fas fa-magic mr-2"></i>Auto Generate
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                                <table class="w-full text-sm text-left text-slate-600">
                                    <thead class="bg-slate-100 text-slate-700 uppercase">
                                        <tr>
                                            <th class="px-6 py-3">Vendor</th>
                                            <th class="px-6 py-3">Plat Nomor</th>
                                            <th class="px-6 py-3">Jenis Truck</th>
                                            <th class="px-6 py-3">Biaya Sewa (Fix Cost)</th>
                                            <th class="px-6 py-3">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fixCostTableBody"></tbody>
                                </table>
                            </div>
                        </div>

                        <div id="tab-master-var" class="cost-tab-content hidden">
                            <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                                <h4 class="text-lg font-bold text-slate-700 mb-4">Input Variable Cost (Uang Jalan)</h4>
                                
                                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600">Vendor</label>
                                        <select id="varCostVendor" class="w-full p-2 border rounded-lg"></select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600">Jenis Truck</label>
                                        <select id="varCostJenisTruck" class="w-full p-2 border rounded-lg">
                                            <option value="">Pilih Jenis...</option>
                                            </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-slate-600">Kota Muat (Origin)</label>
                                        <input type="text" id="varCostOrigin" class="w-full p-2 border rounded-lg" value="KARAWANG" placeholder="Kota Muat">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600">Kota Bongkar (Destination)</label>
                                        <input type="text" id="varCostDest" class="w-full p-2 border rounded-lg" placeholder="Kota Bongkar">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600">Uang Jalan (Rp)</label>
                                        <input type="number" id="varCostValue" class="w-full p-2 border rounded-lg" placeholder="Contoh: 650000">
                                    </div>
                                    <button onclick="window.saveVarCost()" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Simpan</button>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                                <table class="w-full text-sm text-left text-slate-600">
                                    <thead class="bg-slate-100 text-slate-700 uppercase">
                                        <tr>
                                            <th class="px-6 py-3">Vendor</th>
                                            <th class="px-6 py-3">Jenis Truck</th> <th class="px-6 py-3">Rute (Muat -> Bongkar)</th>
                                            <th class="px-6 py-3">Uang Jalan</th>
                                            <th class="px-6 py-3">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="varCostTableBody"></tbody>
                                </table>
                            </div>
                        </div>                        

                        <div id="tab-report" class="cost-tab-content hidden">
                            <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                                <h4 class="text-lg font-bold text-slate-700 mb-4">Filter Laporan Bulanan</h4>
                                <div class="flex gap-4 items-end">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600">Bulan</label>
                                        <input type="month" id="reportMonth" class="p-2 border rounded-lg">
                                    </div>
                                    <button onclick="window.generateFinancialReport()" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">
                                        <i class="fas fa-calculator mr-2"></i>Hitung
                                    </button>
                                    
                                    <button id="btnCloseBook" onclick="window.closeBook()" class="bg-slate-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-800 hidden">
                                        <i class="fas fa-lock mr-2"></i>CLOSING
                                    </button>
                                    <button id="btnReopenBook" onclick="window.reopenBook()" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 hidden">
                                            <i class="fas fa-lock-open mr-2"></i>Buka Kembali
                                    </button>
                                    <div id="lockStatus" class="hidden flex items-center text-red-600 font-bold bg-red-100 px-3 py-2 rounded-lg border border-red-200">
                                        <i class="fas fa-lock mr-2"></i> DATA TERKUNCI
                                    </div>

                                    <button onclick="window.exportFinancialExcel()" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">
                                        <i class="fas fa-file-excel mr-2"></i>Excel
                                    </button>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                <div class="bg-indigo-600 text-white p-6 rounded-xl shadow-lg">
                                    <p class="font-semibold opacity-80">Total Pengeluaran (Grand Total)</p>
                                    <p id="rptGrandTotal" class="text-3xl font-bold mt-2">Rp 0</p>
                                </div>
                                <div class="bg-orange-600 text-white p-6 rounded-xl shadow-lg">
                                    <p class="font-semibold opacity-80">Total Fix Cost (Sewa)</p>
                                    <p id="rptTotalFix" class="text-3xl font-bold mt-2">Rp 0</p>
                                </div>
                                <div class="bg-green-600 text-white p-6 rounded-xl shadow-lg">
                                    <p class="font-semibold opacity-80">Total Variable Cost (Uang Jalan)</p>
                                    <p id="rptTotalVar" class="text-3xl font-bold mt-2">Rp 0</p>
                                </div>
                            </div>

                            <div id="ritase-dashboard-area" class="mt-10 border-t-4 border-slate-200 pt-8 hidden">
                                
                                <h3 class="text-2xl font-bold text-slate-700 mb-6">Analisa Performa Vendor</h3>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500 flex items-center justify-between">
                                        <div>
                                            <p class="text-2xl font-semibold text-slate-500 uppercase">Total Ritase (All)</p>
                                            <p id="kpi-total-ritase" class="text-3xl font-bold text-slate-800 mt-1">0</p>
                                        </div>
                                        <div class="p-3 bg-blue-100 rounded-full text-blue-600"><i class="fas fa-route text-2xl"></i></div>
                                    </div>
                                    
                                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-orange-500 flex items-center justify-between">
                                        <div>
                                            <p class="text-2xl font-semibold text-slate-500 uppercase">Rata-rata Ritase / Unit</p>
                                            <p id="kpi-avg-ritase" class="text-3xl font-bold text-slate-800 mt-1">0</p>
                                        </div>
                                        <div class="p-3 bg-orange-100 rounded-full text-orange-600"><i class="fas fa-calculator text-2xl"></i></div>
                                    </div>

                                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500 flex items-center justify-between">
                                        <div>
                                            <p class="text-2xl font-semibold text-slate-500 uppercase">Total Unit Operasional</p>
                                            <p id="kpi-total-unit" class="text-3xl font-bold text-slate-800 mt-1">0</p>
                                        </div>
                                        <div class="p-3 bg-green-100 rounded-full text-green-600"><i class="fas fa-truck text-2xl"></i></div>
                                    </div>
                                </div>

                                <div id="ritase-cards-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"></div>
                                
                                <!-- <div class="flex justify-end mb-8">
                                    <button onclick="window.exportRitaseSummaryExcel()" class="flex items-center gap-2 bg-green-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-700 text-sm shadow-sm transition-transform hover:scale-105">
                                        <i class="fas fa-file-excel"></i> Download Rekap Excel
                                    </button>
                                </div> -->

                                <div class="bg-white rounded-xl shadow-md overflow-x-auto p-4">
                                    <h4 class="text-xl font-bold text-slate-800 mb-4">Rincian Per Vendor & Truck (Keuangan)</h4>
                                    <table class="w-full text-sm text-left text-slate-600" id="financialTable">
                                        <thead class="bg-slate-800 text-white uppercase text-xs">
                                            <tr>
                                                <th class="px-6 py-3">Vendor</th>
                                                <th class="px-6 py-3">Plat Nomor</th>
                                                <th class="px-6 py-3 text-right">Fix Cost (Sewa)</th>
                                                <th class="px-6 py-3 text-center">Jml Ritase</th>
                                                <th class="px-6 py-3 text-right">Variable Cost (Total Uang Jalan)</th>
                                                <th class="px-6 py-3 text-right font-bold bg-slate-900">TOTAL BIAYA</th>
                                            </tr>
                                        </thead>
                                        <tbody id="financialReportBody"></tbody>
                                    </table>
                                </div>
                            </div>
                    </div>

                </main>
                <footer class="text-center p-4 text-sm text-slate-500 mt-auto bg-white border-t">&copy; <span id="copyright-year"></span> Jagaddhita Arya Koswara - Logistik IKK</footer>
            </div>
        </div>
    </div>
    
    <div id="status-modal" class="modal-overlay hidden" onclick="window.closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="modal-close" onclick="window.closeModal()">&times;</span>
            <h3 id="modal-title" class="text-2xl font-bold text-slate-800 mb-4">Daftar Truk</h3>
            <div class="flex items-center gap-4 mb-4">
                <input type="text" id="modalSearchInput" placeholder="Cari..." class="w-full p-2 border border-slate-300 rounded-lg">
                <select id="modalFilterAngkutan" class="p-2 border border-slate-300 rounded-lg"><option value="">Semua Angkutan</option></select>
            </div>
            <div class="modal-body">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                        <tr>
                            <th class="px-4 py-3" data-sort="angkutan" onclick="window.sortModalTable('angkutan')">Angkutan</th>
                            <th class="px-4 py-3" data-sort="no_mobil" onclick="window.sortModalTable('no_mobil')">Plat Nomor</th>
                            <th class="px-4 py-3" data-sort="nama_driver" onclick="window.sortModalTable('nama_driver')">Nama Driver</th>
                            <th class="px-4 py-3" data-sort="customer" onclick="window.sortModalTable('customer')">Customer</th>
                            <th class="px-4 py-3" data-sort="fo" onclick="window.sortModalTable('fo')">DN</th>
                            <th class="px-4 py-3" data-sort="no_hp" onclick="window.sortModalTable('no_hp')">No HP</th>
                            <th class="px-4 py-3" data-sort="jenis_mobil" onclick="window.sortModalTable('jenis_mobil')">Jenis Truck</th>
                            <th class="px-4 py-3">Dimensi (cm)</th>
                            <th class="px-4 py-3">Kubikasi (m)</th>
                        </tr>
                    </thead>
                    <tbody id="modal-truck-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="log-modal" class="modal-overlay hidden" onclick="window.closeLogModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="modal-close" onclick="window.closeLogModal()">&times;</span>
            <h3 id="log-modal-title" class="text-2xl font-bold text-slate-800 mb-4">Log Perubahan Status</h3>
            <div class="modal-body">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-white uppercase bg-slate-800">
                        <tr>
                            <th class="px-4 py-3">Waktu</th>
                            <th class="px-4 py-3">Status Lama</th>
                            <th class="px-4 py-3">Status Baru</th>
                            <th class="px-4 py-3">Diubah Oleh</th>
                        </tr>
                    </thead>
                    <tbody id="log-modal-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="header-filter-popup" class="header-filter-popup hidden">
        <input type="text" id="filter-search" class="w-full p-2 border border-slate-300 rounded-md mb-2" placeholder="Cari opsi...">
        <div id="filter-options" class="filter-options"></div>
        <div class="flex justify-end gap-2 pt-2 border-t">
            <button id="apply-filter-btn" class="bg-indigo-600 text-white px-3 py-1 rounded-md text-sm font-semibold">Terapkan</button>
            <button id="clear-filter-btn" class="bg-slate-200 px-3 py-1 rounded-md text-sm">Hapus Filter</button>
        </div>
    </div>

    <div id="vendor-truck-modal" class="modal-overlay hidden" onclick="window.closeVendorTruckModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="modal-close" onclick="window.closeVendorTruckModal()">&times;</span>
            <h3 id="vendor-truck-modal-title" class="text-2xl font-bold text-slate-800 mb-4">Daftar Truk</h3>
            <div class="modal-body">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                        <tr>
                            <th class="px-4 py-3" data-sort="fo" onclick="window.sortVendorTruckModal('fo')">FO</th>
                            <th class="px-4 py-3" data-sort="no_mobil" onclick="window.sortVendorTruckModal('no_mobil')">Plat Nomor</th>
                            <th class="px-4 py-3" data-sort="nama_driver" onclick="window.sortVendorTruckModal('nama_driver')">Nama Driver</th>
                            <th class="px-4 py-3" data-sort="no_hp" onclick="window.sortVendorTruckModal('no_hp')">No HP</th>
                            <th class="px-4 py-3">Dimensi (cm)</th>
                            <th class="px-4 py-3" data-filter="keterangan" onclick="window.openVendorTruckFilterPopup(event, 'keterangan')">Status</th>
                        </tr>
                    </thead>
                    <tbody id="vendor-truck-modal-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="inap-status-modal" class="modal-overlay hidden" onclick="window.closeInapStatusModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="modal-close" onclick="window.closeInapStatusModal()">&times;</span>
        <h3 id="inap-modal-title" class="text-2xl font-bold text-slate-800 mb-4">Daftar Truk Inap</h3>
        <div class="modal-body">
            <table class="w-full text-sm text-left text-slate-600">
                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                    <tr>
                        <th class="px-4 py-3" data-sort="angkutan" onclick="window.sortInapModalTable('angkutan')">Angkutan</th>
                        <th class="px-4 py-3" data-sort="no_mobil" onclick="window.sortInapModalTable('no_mobil')">Plat Nomor</th>
                        <th class="px-4 py-3" data-sort="customer" onclick="window.sortInapModalTable('customer')">Nama Customer</th>
                        <th class="px-4 py-3" data-sort="tujuan" onclick="window.sortInapModalTable('tujuan')">Kota</th>
                        <th class="px-4 py-3" data-sort="leadTimeMinutes" onclick="window.sortInapModalTable('leadTimeMinutes')">Lama Inap</th>
                    </tr>
                </thead>
                <tbody id="inap-modal-truck-list">
                    </tbody>
            </table>
        </div>
    </div>
    </div>

    <div id="ritase-form-modal" class="modal-overlay hidden" onclick="window.closeRitaseModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="modal-close" onclick="window.closeRitaseModal()">&times;</span>
            <h3 id="ritase-modal-title" class="text-2xl font-bold text-slate-800 mb-4">Form Data Ritase</h3>
            
            <form id="ritaseForm" onsubmit="event.preventDefault(); window.saveRitaseData();">
                <input type="hidden" id="ritaseId"> <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-1 md:col-span-2">
                        <h4 class="font-bold text-slate-600 mb-2 border-b pb-1">Info Utama</h4>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-600">Angkutan (Vendor)</label>
                        <input type="text" id="ritaseAngkutan" class="w-full p-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600">Plat Nomor</label>
                        <input type="text" id="ritasePlat" class="w-full p-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600">Jenis Truck</label>
                        <select id="ritaseJenisTruck" class="w-full p-2 border rounded-lg">
                            <option value="">- Pilih -</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600">Nama Driver</label>
                        <input type="text" id="ritaseDriver" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600">Customer</label>
                        <input type="text" id="ritaseCustomer" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600">Kota Tujuan</label>
                        <input type="text" id="ritaseKota" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600">No. FO / DN</label>
                        <input type="text" id="ritaseFO" class="w-full p-2 border rounded-lg">
                    </div>

                    <div class="col-span-1 md:col-span-2 mt-2">
                        <h4 class="font-bold text-slate-600 mb-2 border-b pb-1">Waktu Perjalanan</h4>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-600">Tiba Muat</label>
                        <input type="datetime-local" id="ritaseTibaMuat" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600">Keluar Muat</label>
                        <input type="datetime-local" id="ritaseKeluarMuat" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600">Tiba Bongkar</label>
                        <input type="datetime-local" id="ritaseTibaBongkar" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600">Keluar Bongkar</label>
                        <input type="datetime-local" id="ritaseKeluarBongkar" class="w-full p-2 border rounded-lg">
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-sm font-medium text-slate-600">Waktu Selesai (System Timestamp)</label>
                        <input type="datetime-local" id="ritaseSelesai" class="w-full p-2 border rounded-lg" required>
                        <p class="text-xs text-gray-400">*Wajib diisi untuk pengurutan data</p>
                    </div>
                </div>

                <div class="mt-6 flex justify-end gap-2">
                    <button type="button" onclick="window.closeRitaseModal()" class="bg-slate-200 text-slate-800 px-4 py-2 rounded-lg">Batal</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Simpan Data</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, Timestamp, doc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, getDoc, query, orderBy, where, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth, currentUserData, unsubscribeFromTrucks, unsubscribeFromRitase, unsubscribeFromCustomers, unsubscribeFromJenisTruck;
        window.trucksData = []; 
        window.customersData = [];
        window.jenisTruckData = [];
        window.allRitaseData = [];


        // STEP 3: Setup Variable Cost Analysis (LocalStorage)
        // Ini akan mengambil data dari memori browser, aman dari limit Firebase
        window.masterFixCost = JSON.parse(localStorage.getItem('local_master_fix_cost')) || [];
        window.masterVarCost = JSON.parse(localStorage.getItem('local_master_var_cost')) || [];

        // Helper format Rupiah
        const formatRupiah = (number) => {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        };

    

        // --- TAMBAHKAN BARIS INI ---
        window.customerTypeMap = new Map();
        // --- BATAS TAMBAHAN ---

        // --- TAMBAHKAN FUNGSI BARU INI ---
        function getDynamicStatus(truck) {
            if (!truck) return 'N/A';
            const originalStatus = truck.keterangan;

            if (originalStatus !== 'INAP' && originalStatus !== 'ANTRI BONGKAR') {
                return originalStatus;
            }
            
            const customerName = truck.customer;
            if (!customerName) {
                return `${originalStatus} (Lainnya)`; 
            }

            const customerType = window.customerTypeMap.get(customerName);
            
            if (originalStatus === 'INAP') { // Handle INAP
                if (customerType === 'BU17') return 'INAP BU17';
                if (customerType === 'CMI') return 'INAP CMI';
                return 'INAP (Lainnya)';
            }
            
            // [PERBAIKAN] Handle ANTRI BONGKAR dengan nama baru
            if (originalStatus === 'ANTRI BONGKAR') { 
                if (customerType === 'BU17') return 'ANTRI BU17'; // <-- REVISI
                if (customerType === 'CMI') return 'ANTRI CMI';   // <-- REVISI
                return 'ANTRI BONGKAR (Lainnya)';
            }
        }
        // --- BATAS FUNGSI BARU ---
        
        let realtimeMap;
        let realtimeTruckMarkers = {};

        let currentModalTrucks = [];
        let modalSort = { column: 'angkutan', direction: 'asc' };
        let ritaseSort = { column: 'timestamp_selesai', direction: 'desc' };
        let activeFilters = {};
        let vendorTruckModalFilters = {};
        let currentVendorTruckFilterColumn = null;

        // --- TAMBAHKAN DUA BARIS DI BAWAH INI ---
        let currentInapModalTrucks = []; // Data untuk modal INAP baru
        let inapModalSort = { column: 'leadTimeMinutes', direction: 'desc' }; // Default sort (paling lama di atas)
        // --- BATAS TAMBAHAN ---


        const appId = 'truck-dashboard-app';
        // [PERBAIKAN] Hapus 'ANTRI BONGKAR' dan 'INAP', tambahkan versi split
        // [PERBAIKAN] Mengganti nama 'ANTRI BONGKAR BU17' menjadi 'ANTRI BU17', dst.
        const statusOptions = ['TERSEDIA', 'OTW MILL', 'ANTRI MUAT', 'OTW CUSTOMER', 'ANTRI BU17', 'ANTRI CMI', 'ANTRI BONGKAR (Lainnya)', 'INAP BU17', 'INAP CMI', 'INAP (Lainnya)', 'STORING', 'NO DRIVER'];
        
        const statusInfo = { 
            'TERSEDIA': { icon: 'fa-check-circle', color: 'slate' }, 
            'OTW MILL': { icon: 'fa-truck-loading', color: 'purple' }, 
            'ANTRI MUAT': { icon: 'fa-clock', color: 'cyan' }, 
            'OTW CUSTOMER': { icon: 'fa-road', color: 'green' }, 
            'ANTRI BONGKAR': { icon: 'fa-hourglass-half', color: 'yellow' }, // Kunci dasar
            'ANTRI BU17': { icon: 'fa-hourglass-half', color: 'yellow' }, // <-- BARU
            'ANTRI CMI': { icon: 'fa-hourglass-half', color: 'yellow' }, // <-- BARU
            'ANTRI BONGKAR (Lainnya)': { icon: 'fa-hourglass-half', color: 'yellow' }, 
            'INAP': { icon: 'fa-bed', color: 'orange' }, // Kunci dasar
            'INAP BU17': { icon: 'fa-bed', color: 'orange' },
            'INAP CMI': { icon: 'fa-bed', color: 'orange' },
            'INAP (Lainnya)': { icon: 'fa-bed', color: 'orange' },
            'STORING': { icon: 'fa-tools', color: 'red' }, 
            'NO DRIVER': { icon: 'fa-user-slash', color: 'rose' } 
        };

        // --- TAMBAHKAN VARIABEL BARU DI BAWAH INI ---
        const baseStatusOptions = ['TERSEDIA', 'OTW MILL', 'ANTRI MUAT', 'OTW CUSTOMER', 'ANTRI BONGKAR', 'INAP', 'STORING', 'NO DRIVER'];
        // --- BATAS TAMBAHAN ---
        
        const statusBadgeMap = { 
            'TERSEDIA': 'bg-slate-100 text-slate-800', 
            'OTW MILL': 'bg-purple-100 text-purple-800', 
            'ANTRI MUAT': 'bg-cyan-100 text-cyan-800', 
            'OTW CUSTOMER': 'bg-green-100 text-green-800', 
            'ANTRI BU17': 'bg-yellow-100 text-yellow-800', // <-- BARU
            'ANTRI CMI': 'bg-yellow-100 text-yellow-800', // <-- BARU
            'ANTRI BONGKAR (Lainnya)': 'bg-yellow-100 text-yellow-800', 
            'INAP BU17': 'bg-orange-100 text-orange-800',
            'INAP CMI': 'bg-orange-100 text-orange-800',
            'INAP (Lainnya)': 'bg-orange-100 text-orange-800',
            'STORING': 'bg-red-100 text-red-800', 
            'NO DRIVER': 'bg-rose-100 text-rose-800' 
        };

        // --- TAMBAHKAN BLOK INI ---
        const vendorNameMapping = {
            "PT. ALIEF SUKSES BERDIKARI": "ALIEF",
            "PT. SEMEN INDONESIA LOGISTIK": "SILOG",
            "PT. SINAR MAJU JAYA": "SMJ",
            "PT. TIARA FAJAR TRANSPORTINDO": "TFT",
            "PT. TRANSPORTASI NUSANTARA JAYA": "TNJ",
            "PT. YUSHAR PUTERA JAYA": "YUSHAR"
        };

        // PAGINATION STATE
        let paginationState = {
            listTruck: { currentPage: 1, filteredData: [] },
            masterCustomer: { currentPage: 1, filteredData: [] },
            masterJenisTruck: { currentPage: 1, filteredData: [] },
            ritaseTruck: { currentPage: 1, filteredData: [] }
        };
        const rowsPerPage = 15;

        function showSuccessAlert(title, text) {
            Swal.fire({
                icon: 'success',
                title: title,
                text: text,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        }

        function showErrorAlert(title, text) {
            Swal.fire({
                icon: 'error',
                title: title,
                text: text,
                confirmButtonColor: '#ef4444'
            });
        }

        function showConfirmAlert(title, text, confirmButtonText, callback) {
            Swal.fire({
                title: title,
                text: text,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#4f46e5',
                cancelButtonColor: '#6b7280',
                confirmButtonText: confirmButtonText || 'Ya, Lanjutkan!'
            }).then((result) => {
                if (result.isConfirmed) {
                    callback(true);
                } else {
                    callback(false);
                }
            });
        }
        
        function calculateLeadTime(startTimeString) {
            if (!startTimeString) return '-';
            const startTime = new Date(startTimeString);
            const now = new Date();
            let diff = now - startTime;
            if (isNaN(diff) || diff < 0) return 'Invalid Time';
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            diff -= days * (1000 * 60 * 60 * 24);
            const hours = Math.floor(diff / (1000 * 60 * 60));
            diff -= hours * (1000 * 60 * 60);
            const minutes = Math.floor(diff / (1000 * 60));
            let result = [];
            if (days > 0) result.push(`${days} Hari`);
            if (hours > 0) result.push(`${hours} Jam`);
            if (minutes > 0) result.push(`${minutes} Menit`);
            return result.length > 0 ? result.join(' ') : 'Kurang dari semenit';
        }
        
        function calculateLeadTimeInMinutes(startTimeString) {
            if (!startTimeString) return 0;
            const startTime = new Date(startTimeString);
            const now = new Date();
            const diff = now - startTime;
            if (isNaN(diff) || diff < 0) return 0;
            return Math.floor(diff / (1000 * 60));
        }

        function calculateLeadTimeInDays(startTimeString) {
            if (!startTimeString) return 0;
            const startTime = new Date(startTimeString);
            const now = new Date();
            const diff = now - startTime; // difference in milliseconds
            if (isNaN(diff) || diff < 0) return 0;
            return diff / (1000 * 60 * 60 * 24); // Convert ms to days
        }

        // FUNGSI FORMAT TANGGAL YANG LEBIH KUAT (ROBUST)
        function formatTanggalJam(input) {
            if (!input) return '-';

            // 1. Jika input adalah Firestore Timestamp (punya method toDate)
            if (typeof input.toDate === 'function') {
                input = input.toDate();
            }
            
            // 2. Jika input adalah Objek Date JavaScript
            if (input instanceof Date) {
                // Format: 24/11/2025, 11.36
                return input.toLocaleString('id-ID', { 
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit', hour12: false 
                }).replace(/\./g, ':'); // Opsional: ganti titik jadi titik dua jika perlu
            }

            // 3. Jika input adalah String (Data Lama)
            if (typeof input === 'string') {
                // Cek apakah format ISO (mengandung 'T')
                if (input.includes('T')) {
                    const [tanggalPart, jamPart] = input.split('T');
                    if (!tanggalPart || !jamPart) return '-';
                    const [tahun, bulan, tanggal] = tanggalPart.split('-');
                    return `${tanggal}/${bulan}/${tahun}, ${jamPart.substring(0, 5)}`;
                } else {
                    // Jika string biasa, kembalikan apa adanya
                    return input;
                }
            }

            return '-';
        }

        // --- FUNGSI HELPER HITUNG LAMA INAP ---
        function calculateDurationBetween(startStr, endStr) {
            if (!startStr || !endStr) return '-';
            
            // Konversi ke Date Object (Handle jika inputnya string atau Firestore Timestamp)
            const start = startStr.toDate ? startStr.toDate() : new Date(startStr);
            const end = endStr.toDate ? endStr.toDate() : new Date(endStr);

            let diff = end - start; // Selisih dalam milidetik

            if (isNaN(diff)) return '-';
            // if (diff < 0) return '-'; // Opsional: Matikan ini jika ingin lihat nilai negatif

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            diff -= days * (1000 * 60 * 60 * 24);
            const hours = Math.floor(diff / (1000 * 60 * 60));
            diff -= hours * (1000 * 60 * 60);
            const minutes = Math.floor(diff / (1000 * 60));

            let parts = [];
            if (days > 0) parts.push(`${days} Hari`);
            if (hours > 0) parts.push(`${hours} Jam`);
            if (minutes > 0) parts.push(`${minutes} Mnt`);

            return parts.length > 0 ? parts.join(' ') : '0 Mnt';
        }
        
        const firebaseConfig = {
          apiKey: "AIzaSyBQYgVCVzHwBk-Am3MB425FdRXkV4U8bBw", authDomain: "truck-kontrak.firebaseapp.com", projectId: "truck-kontrak",
          storageBucket: "truck-kontrak.firebasestorage.app", messagingSenderId: "198359286959", appId: "1:198359286959:web:5d672f88d73ed05ab9805a", measurementId: "G-V2G0NSDVVB"
        };
        try { const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); } catch(e) { console.error("Firebase Init Error:", e); }

        onAuthStateChanged(auth, async (user) => {
            // 1. Bersihkan listener lama jika ada (untuk mencegah memori bocor saat logout/login ulang)
            if (unsubscribeFromTrucks) unsubscribeFromTrucks();
            if (unsubscribeFromRitase) unsubscribeFromRitase();
            if (unsubscribeFromCustomers) unsubscribeFromCustomers();
            if (unsubscribeFromJenisTruck) unsubscribeFromJenisTruck();

            if (user) {
                try {
                    // 2. Ambil data user dari Firestore untuk cek Role
                    const userDocSnap = await getDoc(doc(db, "users", user.uid));
                    
                    if (userDocSnap.exists() && userDocSnap.data().role === 'admin') {
                        currentUserData = userDocSnap.data();
                        
                        // Update tampilan nama user
                        document.getElementById('currentUserDisplay').textContent = `Selamat datang, ${currentUserData.name || 'Admin'} (Admin)`;
                        
                        // 3. Jalankan Listener Realtime (Hanya untuk GPS Truk, Customer, Jenis Truk)
                        setupRealtimeListeners(); 
                        
                        // 4. [PENTING] Panggil Manual Load untuk Ritase (Hemat Kuota)
                        // Pastikan fungsi ini sudah dibuat di langkah sebelumnya
                        if (typeof window.loadRitaseData === 'function') {
                            window.loadRitaseData(); 
                        } else {
                            console.warn("Fungsi window.loadRitaseData belum didefinisikan.");
                        }

                        // 5. Buka Tampilan Dashboard
                        document.getElementById('loading-container').classList.add('hidden');
                        document.getElementById('login-container').classList.add('hidden');
                        document.getElementById('dashboard-container').classList.remove('hidden');
                        
                        // Buka halaman Home secara default
                        window.showContent('home'); 
                        
                    } else { 
                        // Jika user ada tapi bukan admin, paksa logout
                        await signOut(auth); 
                        Swal.fire("Akses Ditolak", "Akun Anda tidak memiliki izin Admin.", "error");
                    }
                } catch (error) { 
                    console.error("Auth Error:", error);
                    await signOut(auth); 
                }
            } else {
                // 6. Jika tidak ada user (Logout state)
                document.getElementById('loading-container').classList.add('hidden');
                document.getElementById('dashboard-container').classList.add('hidden');
                document.getElementById('login-container').classList.remove('hidden');
                
                // Kosongkan data di memori
                window.allRitaseData = [];
                window.trucksData = [];
            }
        });

        function renderPagination(containerId, pageStateKey, renderFunction) {
            const container = document.getElementById(containerId);
            const { currentPage, filteredData } = paginationState[pageStateKey];
            container.innerHTML = '';
            
            const totalItems = filteredData.length;
            if (totalItems <= rowsPerPage) return;

            const totalPages = Math.ceil(totalItems / rowsPerPage);

            const createButton = (text, page, disabled = false) => {
                const button = document.createElement('button');
                button.innerHTML = text;
                button.disabled = disabled;
                button.className = `pagination-btn px-3 py-1 border rounded-md text-sm font-medium transition ${disabled ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-white hover:bg-slate-50'}`;
                
                if (page === currentPage && text !== '...' && !String(text).includes('i')) {
                    button.classList.add('active');
                }
                
                button.onclick = () => {
                    paginationState[pageStateKey].currentPage = page;
                    renderFunction();
                };
                return button;
            };

            // Previous button
            container.appendChild(createButton('<i class="fas fa-chevron-left"></i>', currentPage - 1, currentPage === 1));

            // Page numbers
            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) {
                    container.appendChild(createButton(i, i));
                }
            } else {
                container.appendChild(createButton(1, 1));
                if (currentPage > 3) container.appendChild(createButton('...', currentPage - 2, true));
                
                let startPage = Math.max(2, currentPage - 1);
                let endPage = Math.min(totalPages - 1, currentPage + 1);

                if (currentPage <= 3) {
                    endPage = 4;
                }
                if (currentPage >= totalPages - 2) {
                    startPage = totalPages - 3;
                }

                for (let i = startPage; i <= endPage; i++) {
                    container.appendChild(createButton(i, i));
                }

                if (currentPage < totalPages - 2) container.appendChild(createButton('...', currentPage + 2, true));
                container.appendChild(createButton(totalPages, totalPages));
            }

            // Next button
            container.appendChild(createButton('<i class="fas fa-chevron-right"></i>', currentPage + 1, currentPage === totalPages));
        }
        
        function setupRealtimeListeners() {
            if (!currentUserData) return;
            
            const trucksCollectionRef = collection(db, `artifacts/${appId}/public/data/trucks`);
            unsubscribeFromTrucks = onSnapshot(trucksCollectionRef, (snapshot) => {
                window.trucksData = snapshot.docs.map(doc => ({ ...doc.data(), firestoreId: doc.id }));

                renderHomePage(window.trucksData);
                
                if (document.getElementById('listTruck').classList.contains('active')) {
                    filterTable();
                }
                if (document.getElementById('statusTruck').classList.contains('active')) {
                    displayStatusCards();
                }
                if (document.getElementById('summaryReport').classList.contains('active')) {
                    renderSummaryReport();
                }
                if (document.getElementById('laporanInap').classList.contains('active')) {
                    renderLaporanInap();
                }
                 
                populateSummaryFilters();
                populateStatusCardFilters();
                populateAddFormVendorSelect();

            }, (error) => console.error("Trucks Listener Error:", error));

            // const ritaseCollectionRef = collection(db, "completed_deliveries");
            // const q = query(ritaseCollectionRef, orderBy("timestamp_selesai", "desc"));
            // unsubscribeFromRitase = onSnapshot(q, (snapshot) => {
            //     window.allRitaseData = snapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
            //     if(document.getElementById('ritaseTruck').classList.contains('active')) {
            //         applyRitaseFiltersAndSort();
            //     }
            // }, (error) => console.error("Ritase Listener Error:", error));

            // FUNGSI BARU: Ambil Data Ritase Sekali Saja (Hemat Kuota)
            window.loadRitaseData = async () => {
                try {
                    // Tampilkan loading (opsional, agar user tahu proses berjalan)
                    const tableBody = document.getElementById('ritaseTableBody');
                    if (tableBody) {
                        tableBody.innerHTML = `<tr><td colspan="14" class="text-center p-8 text-slate-500"><i class="fas fa-spinner fa-spin mr-2"></i>Mengambil data ritase...</td></tr>`;
                    }

                    // Ambil data menggunakan getDocs (Bukan onSnapshot)
                    const q = query(collection(db, "completed_deliveries"), orderBy("timestamp_selesai", "desc"));
                    const snapshot = await getDocs(q);

                    // Simpan ke variabel global
                    window.allRitaseData = snapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));

                    // Refresh tampilan tabel jika sedang di halaman ritase
                    if(document.getElementById('ritaseTruck').classList.contains('active')) {
                        window.applyRitaseFiltersAndSort();
                    }
                    
                    console.log(`Berhasil memuat ${window.allRitaseData.length} data ritase.`);

                } catch (error) {
                    console.error("Gagal mengambil data ritase:", error);
                    Swal.fire("Gagal", "Gagal memuat data ritase. Cek koneksi internet.", "error");
                }
            };

            const customersCollectionRef = collection(db, "customers");
            unsubscribeFromCustomers = onSnapshot(query(customersCollectionRef, orderBy("name")), (snapshot) => {
                
                window.customerTypeMap.clear(); // Bersihkan map lama
                window.customersData = snapshot.docs.map(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    window.customerTypeMap.set(data.name, data.customer_type); // Isi map
                    return data;
                });

                if(document.getElementById('masterCustomer').classList.contains('active')) {
                    filterCustomerTable();
                }

                // --- TAMBAHAN PENTING ---
                // Panggil ulang renderHomePage SETELAH customer map siap.
                // Ini untuk memperbaiki race condition (masalah timing)
                // Kita cek dulu apakah data truk sudah ada
                if (window.trucksData && window.trucksData.length > 0) {
                    // Panggil ulang semua fungsi render yang bergantung pada customer map
                    
                    if (document.getElementById('home').classList.contains('active')) {
                         renderHomePage(window.trucksData);
                    }
                    if (document.getElementById('statusTruck').classList.contains('active')) {
                        displayStatusCards(window.trucksData);
                    }
                    if (document.getElementById('summaryReport').classList.contains('active')) {
                        renderSummaryReport();
                    }
                    if (document.getElementById('laporanInap').classList.contains('active')) {
                        renderLaporanInap();
                    }
                }
                // --- BATAS TAMBAHAN ---

            }, (error) => console.error("Customer Listener E rror:", error));

            const jenisTruckCollectionRef = collection(db, "jenis_truck");
            unsubscribeFromJenisTruck = onSnapshot(query(jenisTruckCollectionRef, orderBy("name")), (snapshot) => {
                window.jenisTruckData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(document.getElementById('masterJenisTruck').classList.contains('active')) {
                    filterJenisTruckTable();
                }
                populateJenisTruckDropdowns();
                populateSummaryFilters();
                populateStatusCardFilters();
            }, (error) => console.error("Jenis Truck Listener Error:", error));
        }

        async function fetchAllTrucksLastPosition() {
            // ===================================================================
            // PERUBAHAN PENTING: Ganti URL ini dengan URL Vercel Anda yang sebenarnya
            // ===================================================================
            const API_URL = 'https://proxy-gps-vercel.vercel.app/'; // <== GANTI DENGAN URL VERCEL ANDA
            // ===================================================================

            document.getElementById('gps-loading-indicator').classList.remove('hidden');
            document.getElementById('refresh-gps-btn').disabled = true;

            try {
                // Memanggil proxy Vercel Anda, bukan API EasyGo secara langsung
                const response = await fetch(API_URL, {
                    method: 'POST', //   Fungsi perantara Anda juga mengharapkan POST
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    // Jika proxy Vercel Anda mengembalikan error (misal 500 atau 405)
                    const errorData = await response.json();
                    throw new Error(`Proxy Error: ${errorData.error || response.statusText}`);
                }
        
                const result = await response.json();
                console.log("DATA LENGKAP DARI API:", result.Data);
        
                if (result && result.Data) {
                    return result.Data; // Sukses
                } else {
                    console.warn("API response format is not as expected:", result);
                    showErrorAlert("Format Data Salah", "Format data dari API GPS tidak sesuai harapan.");
                    return [];
                }

            } catch (error) {
                console.error("Error fetching GPS data:", error);
                // Ini akan menangkap error CORS (jika konfigurasi Vercel salah)
                // atau error 500 dari Vercel
                showErrorAlert("Gagal Mengambil Data", `Tidak dapat mengambil data dari API GPS. Pastikan konfigurasi CORS di Vercel sudah benar dan URL proxy sudah diganti. Error: ${error.message}`);
                return [];
            } finally {
                document.getElementById('gps-loading-indicator').classList.add('hidden');
                document.getElementById('refresh-gps-btn').disabled = false;
            }
        }

        function initializeRealtimeMap() {
            if (realtimeMap) return;

            realtimeMap = L.map('realtimemap').setView([-2.5489, 118.0149], 5); // Center of Indonesia

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(realtimeMap);
        }

        // ===================================================================
        // KODE BARU DITAMBAHKAN: Fungsi untuk menampilkan Modal Detail Truk
        // ===================================================================
        function showTruckDetailModal(truck) {
            const isEngineOn = truck.Acc === "1";
            const engineStatusText = isEngineOn ? 'ON (Nyala)' : 'OFF (Mati)';
            const engineStatusColor = isEngineOn ? '#16a34a' : '#dc2626'; // tailwind green-600 or red-600

            // Format Waktu sesuai gambar: "23 Oktober 2025 pukul 21.26.18"
            let gpsTime = 'N/A';
            if (truck.DeviceTime) {
                try {
                    // 'id-ID' locale biasanya menghasilkan format "23 Oktober 2025 21.26.18"
                    let dateStr = new Date(truck.DeviceTime).toLocaleString('id-ID', {
                        day: '2-digit',
                        month: 'long',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false,
                        timeZone: 'Asia/Jakarta' // Pastikan zona waktu konsisten
                    });
                    // Ganti spasi pertama antara tanggal dan jam dengan " pukul "
                    gpsTime = dateStr.replace(' ', ' pukul '); 
                } catch (e) {
                    console.error("Invalid date format:", truck.DeviceTime);
                    gpsTime = truck.DeviceTime; // fallback jika format tidak valid
                }
            }

            // Format Kecepatan (menangani 'undefined' seperti di gambar)
            let speed;
            if (typeof truck.Speed === 'undefined') {
                speed = 'undefined km/j'; // Persis seperti di gambar
            } else if (truck.Speed === null) {
                speed = 'N/A';
            } else {
                speed = `${truck.Speed} km/j`;
            }
                
            // Format Arah (Heading)
            // Asumsi field dari API adalah 'Direction'
            const heading = (typeof truck.Direction === 'undefined' || truck.Direction === null)
                ? 'N/A'
                : `${truck.Direction}`;
                
            // PENTING: Asumsi nama field dari API berdasarkan gambar Anda
            // Sesuaikan 'UnitID', 'PhoneNumber', 'Distance', 'Address' 
            // jika nama field di API Anda berbeda
            const unitId = truck.UnitID || 'N/A';
            const phone = truck.PhoneNumber || truck.SimNo || 'N/A'; // Coba 'SimNo' jika 'PhoneNumber' tidak ada
            const distance = truck.Distance || '0.00';
            const address = truck.Address || 'N/A'; // Asumsi field 'Address' ada di API

            // Buat HTML untuk SweetAlert
            const modalHtml = `
                <div class="text-left text-sm text-slate-700" style="font-family: 'Inter', sans-serif;">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">${truck.VechileNo || 'Detail Truk'}</h2>
                    <div class="space-y-2">
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold text-slate-500">Unit ID:</span>
                            <span class="font-bold">${unitId}</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold text-slate-500">Nomor Plat:</span>
                            <span class="font-bold">${truck.VechileNo || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold text-slate-500">Waktu Data GPS:</span>
                            <span class="font-bold">${gpsTime}</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold text-slate-500">Status Mesin (ACC):</span>
                            <span class="font-bold" style="color: ${engineStatusColor};">
                                ${engineStatusText} 
                                <span style="display: inline-block; width: 12px; height: 12px; background-color: ${engineStatusColor}; border-radius: 50%; vertical-align: middle;"></span>
                            </span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold text-slate-500">Nomor Telepon:</span>
                            <span class="font-bold">${phone}</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold text-slate-500">Posisi (Lat, Lon):</span>
                            <span class="font-bold">${truck.Lat}, ${truck.Lon}</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold text-slate-500">Kecepatan:</span>
                            <span class="font-bold">${speed}</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold text-slate-500">Arah (Heading):</span>
                            <span class="font-bold">${heading}</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold text-slate-500">Jarak dari Titik Acuan:</span>
                            <span class="font-bold">${distance} km</span>
                        </div>
                        <div class="flex flex-col text-left pt-2">
                            <span class="font-semibold text-slate-500 mb-1">Alamat (Perkiraan):</span>
                            <span class="font-bold">${address}</span>
                        </div>
                    </div>
                </div>
            `;

            Swal.fire({
                html: modalHtml,
                showCloseButton: true,
                showConfirmButton: false, // Tidak perlu tombol OK
                width: '600px', // Atur lebar modal
                customClass: {
                    popup: 'font-sans' // Pastikan font konsisten
                }
            });
        }
        // ===================================================================
        // AKHIR DARI KODE BARU
        // ===================================================================
        
        window.updateTrucksOnRealtimeMap = async function() {
            const gpsData = await fetchAllTrucksLastPosition();
            console.log("Data GPS yang diterima:", gpsData);
            const listContainer = document.getElementById('gps-truck-list');
            listContainer.innerHTML = ''; // Clear previous list
            
            // Clear existing markers from the map
            for (const key in realtimeTruckMarkers) {
                realtimeMap.removeLayer(realtimeTruckMarkers[key]);
            }
            realtimeTruckMarkers = {};

            if (gpsData.length === 0) {
                listContainer.innerHTML = `<p class="p-4 text-slate-500 text-center">Tidak ada data truk aktif yang ditemukan.</p>`;
                return;
            }
            
            const sortedGpsData = gpsData.sort((a, b) => (a.VechileNo || '').localeCompare(b.VechileNo || ''));

            sortedGpsData.forEach(truck => {
                const lat = parseFloat(truck.Lat);
                const lon = parseFloat(truck.Lon);

                if (!isNaN(lat) && !isNaN(lon) && lat !== 0 && lon !== 0) {
                     const isEngineOn = truck.Acc === "1";
                     const iconUrl = isEngineOn 
                        ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png'
                        : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png';
                    
                    const truckIcon = new L.Icon({
                        iconUrl: iconUrl,
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });

                    // ===================================================================
                    // KODE DIUBAH: Hapus popupContent dan bindPopup
                    // ===================================================================
                    // const popupContent = ... (INI DIHAPUS)

                    const marker = L.marker([lat, lon], {icon: truckIcon})
                        .addTo(realtimeMap);
                        // .bindPopup(popupContent); // <-- INI DIHAPUS
                    
                    // TAMBAHKAN INI: Event click pada marker
                    marker.on('click', () => {
                        // Panggil modal kustom baru, kirimkan seluruh data 'truck'
                        showTruckDetailModal(truck); 
                    });
                    // ===================================================================
                    // AKHIR PERUBAHAN
                    // ===================================================================
                    
                    realtimeTruckMarkers[truck.VechileNo] = marker;
                    
                    // Add to side panel
                    const truckItem = document.createElement('div');
                    truckItem.className = 'gps-truck-item p-4 border-l-4 border-transparent cursor-pointer flex justify-between items-center';
                    truckItem.setAttribute('data-plate', truck.VechileNo);
                    truckItem.onclick = () => {
                        realtimeMap.flyTo([lat, lon], 16);
                        
                        // ===================================================================
                        // KODE DIUBAH: Panggil modal, bukan popup
                        // ===================================================================
                        // marker.openPopup(); // <-- INI DIGANTI
                        showTruckDetailModal(truck); // <-- DENGAN INI
                        // ===================================================================

                        document.querySelectorAll('.gps-truck-item').forEach(el => el.classList.remove('active'));
                        truckItem.classList.add('active');
                    };
                    
                    truckItem.innerHTML = `
                        <div>
                            <p class="font-bold text-slate-800">${truck.VechileNo}</p>
                            <p class="text-sm text-slate-500">${truck.Status}</p>
                            <p class="text-xs text-slate-400">${new Date(truck.DeviceTime).toLocaleString('id-ID')}</p>
                        </div>
                        <div class="text-right">
                             <p class="font-semibold text-lg ${isEngineOn ? 'text-green-600' : 'text-red-600'}">${isEngineOn ? '<i class="fas fa-check-circle"></i> ON' : '<i class="fas fa-times-circle"></i> OFF'}</p>
                             <p class="text-sm text-slate-600">${truck.Speed} km/j</p>
                        </div>`;
                    listContainer.appendChild(truckItem);
                }
            });

            // Fit map to show all markers
            const group = new L.featureGroup(Object.values(realtimeTruckMarkers));
            if (Object.keys(realtimeTruckMarkers).length > 0) {
                 realtimeMap.fitBounds(group.getBounds().pad(0.2));
            }
        }
        
        let currentVendorTrucks = [];
        let vendorTruckModalSort = { column: 'no_mobil', direction: 'asc' };

        function renderVendorTruckTable() {
            const tableBody = document.getElementById('vendor-truck-modal-body');
            tableBody.innerHTML = '';

            let filteredData = [...currentVendorTrucks];
            if (vendorTruckModalFilters.keterangan && vendorTruckModalFilters.keterangan.length > 0) {
                filteredData = filteredData.filter(truck => vendorTruckModalFilters.keterangan.includes(truck.keterangan));
            }

            const sortedData = [...filteredData].sort((a, b) => {
                const col = vendorTruckModalSort.column;
                const dir = vendorTruckModalSort.direction === 'asc' ? 1 : -1;
                
                if (col === 'keterangan') {
                    const indexA = statusOptions.indexOf(a[col]);
                    const indexB = statusOptions.indexOf(b[col]);
                    return (indexA - indexB) * dir;
                }

                const valA = a[col] || '';
                const valB = b[col] || '';
                return valA.localeCompare(valB, undefined, { numeric: true }) * dir;
            });

            if (sortedData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-slate-500">Tidak ada data truk yang cocok dengan filter.</td></tr>`;
            } else {
                sortedData.forEach(truck => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-slate-50';
                    
                    const p = truck.panjang || 0, l = truck.lebar || 0, t = truck.tinggi || 0;
                    const dimensi = `${p}${l}${t}`;
                    const badgeClasses = statusBadgeMap[truck.keterangan] || 'bg-slate-100 text-slate-800';
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 font-medium">${truck.fo || '-'}</td>
                        <td class="px-4 py-3">${truck.no_mobil || '-'}</td>
                        <td class="px-4 py-3">${truck.nama_driver || '-'}</td>
                        <td class="px-4 py-3">${truck.no_hp || '-'}</td>
                        <td class="px-4 py-3">${dimensi}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 text-xs font-semibold rounded-full ${badgeClasses}">${truck.keterangan || 'N/A'}</span></td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }

        window.sortVendorTruckModal = (column) => {
            if (vendorTruckModalSort.column === column) {
                vendorTruckModalSort.direction = vendorTruckModalSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                vendorTruckModalSort.column = column;
                vendorTruckModalSort.direction = 'asc';
            }
            renderVendorTruckTable();
        };

        window.showTrucksByVendor = (vendorName) => {
            const modal = document.getElementById('vendor-truck-modal');
            const title = document.getElementById('vendor-truck-modal-title');
            
            title.textContent = `Daftar Truk - ${vendorName}`;
            
            currentVendorTrucks = window.trucksData.filter(truck => (truck.angkutan || 'Lainnya') === vendorName);
            vendorTruckModalSort = { column: 'no_mobil', direction: 'asc' };
            vendorTruckModalFilters = {};

            renderVendorTruckTable();
            modal.classList.remove('hidden');
        };

        window.closeVendorTruckModal = () => {
            document.getElementById('vendor-truck-modal').classList.add('hidden');
        };
        
        function applyVendorTruckFilter() {
            if (!currentVendorTruckFilterColumn) return;
            const selectedValues = [];
            document.querySelectorAll('#filter-options input[type="checkbox"]:checked').forEach(checkbox => {
                selectedValues.push(checkbox.value);
            });
            
            if (selectedValues.length > 0) {
                vendorTruckModalFilters[currentVendorTruckFilterColumn] = selectedValues;
            } else {
                delete vendorTruckModalFilters[currentVendorTruckFilterColumn];
            }
            renderVendorTruckTable();
            closeFilterPopup();
        }

        function clearVendorTruckFilter() {
            if (!currentVendorTruckFilterColumn) return;
            delete vendorTruckModalFilters[currentVendorTruckFilterColumn];
            renderVendorTruckTable();
            closeFilterPopup();
        }
        
        window.openVendorTruckFilterPopup = (event, column) => {
            event.stopPropagation();
            const popup = document.getElementById('header-filter-popup');
            const filterOptions = document.getElementById('filter-options');
            const searchInput = document.getElementById('filter-search');

            if (currentVendorTruckFilterColumn === column && !popup.classList.contains('hidden')) {
                closeFilterPopup();
                return;
            }
            
            currentVendorTruckFilterColumn = column;
            
            const uniqueValues = statusOptions;
            
            filterOptions.innerHTML = '';
            uniqueValues.forEach(value => {
                const isChecked = vendorTruckModalFilters[column] && vendorTruckModalFilters[column].includes(String(value));
                const itemHtml = `<label class="filter-item flex items-center"><input type="checkbox" value="${value}" ${isChecked ? 'checked' : ''} class="mr-2 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><span>${value}</span></label>`;
                filterOptions.innerHTML += itemHtml;
            });

            searchInput.value = '';
            searchInput.onkeyup = () => {
                const term = searchInput.value.toLowerCase();
                document.querySelectorAll('#filter-options .filter-item').forEach(item => {
                    const text = item.querySelector('span').textContent.toLowerCase();
                    item.style.display = text.includes(term) ? 'flex' : 'none';
                });
            };
            
            document.getElementById('apply-filter-btn').onclick = applyVendorTruckFilter;
            document.getElementById('clear-filter-btn').onclick = clearVendorTruckFilter;

            const headerRect = event.currentTarget.getBoundingClientRect();
            popup.style.left = `${headerRect.left}px`;
            popup.style.top = `${headerRect.bottom + window.scrollY}px`;
            popup.classList.remove('hidden');
        }
        
        function renderHomePage(data) {
            if (!data) return;

            document.getElementById('welcome-title').textContent = `Selamat Datang, Admin!`;
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            const totalTrucks = data.length;
            
            // [PERBAIKAN] Logika 'availableTrucks' (sekarang Belum Alokasi) diubah
            const belumAlokasi = data.filter(t => ['TERSEDIA', 'STORING', 'NO DRIVER'].includes(t.keterangan)).length;
            
            const totalAngkutan = [...new Set(data.map(t => t.angkutan).filter(Boolean))].length;
            
            // Logika 'activeTrucks' (sekarang Sudah Alokasi) sudah benar
            const activeTrucks = data.filter(t => ['OTW MILL', 'ANTRI MUAT', 'OTW CUSTOMER', 'ANTRI BONGKAR', 'INAP'].includes(t.keterangan)).length;

            document.getElementById('total-truck-count').textContent = totalTrucks;
            document.getElementById('active-truck-count').textContent = activeTrucks;
            document.getElementById('total-angkutan-count').textContent = totalAngkutan;
            
            // [PERBAIKAN] Mengirim hasil 'belumAlokasi' ke elemen card
            document.getElementById('available-truck-count').textContent = belumAlokasi;

            
            const createStatusCard = (status, count) => {
                let originalStatus = status;
                if (status.startsWith('INAP')) {
                    originalStatus = 'INAP';
                } else if (status.startsWith('ANTRI')) { 
                    originalStatus = 'ANTRI BONGKAR'; 
                    if (status === 'ANTRI MUAT') originalStatus = 'ANTRI MUAT'; 
                }
                
                const info = statusInfo[originalStatus] || { icon: 'fa-question-circle', color: 'gray' };
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-xl shadow-md flex items-center status-card';
                card.style.cursor = 'pointer';
                card.innerHTML = `
                    <div class="p-3 bg-${info.color}-100 rounded-full"><i class="fas ${info.icon} text-2xl text-${info.color}-600"></i></div>
                    <div class="ml-4">
                        <p class="text-slate-500 font-semibold">${status}</p>
                        <p class="text-2xl font-bold text-slate-800">${count}</p>
                    </div>`;
                card.onclick = () => window.showTrucksByStatus(status);
                container.appendChild(card);
            };

            const container = document.getElementById('status-details-grid');
            container.innerHTML = '';

            const orderedStatuses = [
                'TERSEDIA',
                'OTW MILL',
                'ANTRI MUAT',
                'OTW CUSTOMER',
                'ANTRI BU17', 
                'ANTRI CMI',  
                'INAP BU17',
                'INAP CMI',
                'STORING',
                'NO DRIVER'
            ];

            const counts = {};
            counts['TERSEDIA'] = data.filter(t => t.keterangan === 'TERSEDIA').length;
            counts['OTW MILL'] = data.filter(t => t.keterangan === 'OTW MILL').length;
            counts['ANTRI MUAT'] = data.filter(t => t.keterangan === 'ANTRI MUAT').length;
            counts['OTW CUSTOMER'] = data.filter(t => t.keterangan === 'OTW CUSTOMER').length;
            counts['ANTRI BU17'] = data.filter(t => t.keterangan === 'ANTRI BONGKAR' && getDynamicStatus(t) === 'ANTRI BU17').length;
            counts['ANTRI CMI'] = data.filter(t => t.keterangan === 'ANTRI BONGKAR' && getDynamicStatus(t) === 'ANTRI CMI').length;
            counts['INAP BU17'] = data.filter(t => t.keterangan === 'INAP' && getDynamicStatus(t) === 'INAP BU17').length;
            counts['INAP CMI'] = data.filter(t => t.keterangan === 'INAP' && getDynamicStatus(t) === 'INAP CMI').length;
            counts['STORING'] = data.filter(t => t.keterangan === 'STORING').length;
            counts['NO DRIVER'] = data.filter(t => t.keterangan === 'NO DRIVER').length;
            
            orderedStatuses.forEach(status => {
                createStatusCard(status, counts[status] || 0);
            });

            const inapLainnyaCount = data.filter(t => t.keterangan === 'INAP' && getDynamicStatus(t) === 'INAP (Lainnya)').length;
            if (inapLainnyaCount > 0) {
                 createStatusCard('INAP (Lainnya)', inapLainnyaCount);
            }
            const antriLainnyaCount = data.filter(t => t.keterangan === 'ANTRI BONGKAR' && getDynamicStatus(t) === 'ANTRI BONGKAR (Lainnya)').length;
            if (antriLainnyaCount > 0) {
                 createStatusCard('ANTRI BONGKAR (Lainnya)', antriLainnyaCount);
            }

            const knownStatuses = [...statusOptions, 'INAP', 'ANTRI BONGKAR']; 
            const unknownTrucks = data.filter(truck => {
                const status = truck.keterangan;
                if (!status) return true; 
                return !knownStatuses.includes(status);
            });
            const unknownCount = unknownTrucks.length;

            if (unknownCount > 0) {
                const info = { icon: 'fa-question-circle', color: 'gray' };
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-xl shadow-md flex items-center status-card';
                card.style.cursor = 'pointer';
                card.style.border = '2px solid #ef4444'; 
                
                card.innerHTML = `
                    <div class="p-3 bg-${info.color}-100 rounded-full"><i class="fas ${info.icon} text-2xl text-${info.color}-600"></i></div>
                    <div class="ml-4">
                        <p class="text-slate-500 font-semibold">STATUS TIDAK DIKENALI</p>
                        <p class="text-2xl font-bold text-red-600">${unknownCount}</p>
                    </div>`;
                
                card.onclick = () => {
                    const modal = document.getElementById('status-modal');
                    const modalTitle = document.getElementById('modal-title');
                    const filterDropdown = document.getElementById('modalFilterAngkutan');
                    const searchInput = document.getElementById('modalSearchInput');
                    
                    currentModalTrucks = unknownTrucks; 

                    modalTitle.textContent = `Daftar Truk: STATUS TIDAK DIKENALI`;
                    const uniqueAngkutan = [...new Set(currentModalTrucks.map(t => t.angkutan))].sort();
                    filterDropdown.innerHTML = '<option value="">Semua Angkutan</option>';
                    uniqueAngkutan.forEach(a => { if (a) filterDropdown.innerHTML += `<option value="${a}">${a}</option>`; });
                    searchInput.value = '';
                    filterDropdown.value = '';
                    modalSort = { column: 'angkutan', direction: 'asc' };
                    renderModalTable(currentModalTrucks);
                    modal.classList.remove('hidden');
                };
                
                container.appendChild(card);
            }

            // ... (Sisa fungsi 'renderHomePage' untuk vendor dan jenis truk tidak berubah) ...
            
            const vendorContainer = document.getElementById('vendor-details-grid');
            if (vendorContainer) {
                vendorContainer.innerHTML = '';
                
                const vendorCounts = data.reduce((acc, truck) => {
                    const vendorName = truck.angkutan || 'Lainnya';
                    acc[vendorName] = (acc[vendorName] || 0) + 1;
                    return acc;
                }, {});

                const sortedVendors = Object.keys(vendorCounts).sort();

                sortedVendors.forEach(vendorName => {
                    const count = vendorCounts[vendorName];
                    const isCollapsed = document.getElementById('sidebar').classList.contains('sidebar-collapsed');
                    
                    let displayName = vendorName;
                    if (isCollapsed && vendorNameMapping[vendorName]) {
                        displayName = vendorNameMapping[vendorName];
                    }
                    
                    const vendorCard = document.createElement('div');
                    vendorCard.className = 'bg-white p-6 rounded-xl shadow-md flex items-center status-card';
                    vendorCard.style.cursor = 'pointer';
                    vendorCard.onclick = () => window.showTrucksByVendor(vendorName); 
                    
                    vendorCard.innerHTML = `
                        <div class="p-3 bg-sky-100 rounded-full">
                            <i class="fas fa-building text-2xl text-sky-600"></i>
                        </div>
                        <div class="ml-4 overflow-hidden">
                            <p class="text-slate-500 font-semibold truncate" title="${vendorName}">${displayName}</p>
                            <p class="text-2xl font-bold text-slate-800">${count}<span class="text-suffix-truk"> Truk</span></p>
                        </div>`;
                    vendorContainer.appendChild(vendorCard);
                });
            }

            const jenisTruckContainer = document.getElementById('jenis-truck-details-grid');
            if (jenisTruckContainer) {
                jenisTruckContainer.innerHTML = ''; 

                const jenisTruckCounts = data.reduce((acc, truck) => {
                    const jenis = truck.jenis_mobil || 'Tanpa Jenis';
                    acc[jenis] = (acc[jenis] || 0) + 1;
                    return acc;
                }, {});

                const sortedJenisTruk = Object.keys(jenisTruckCounts).sort();

                sortedJenisTruk.forEach(jenis => {
                    const count = jenisTruckCounts[jenis];
                    const card = document.createElement('div');
                    card.className = 'bg-white p-6 rounded-xl shadow-md flex items-center';
                    
                    card.innerHTML = `
                        <div class="p-3 bg-teal-100 rounded-full">
                            <i class="fas fa-tags text-2xl text-teal-600"></i>
                        </div>
                        <div class="ml-4 overflow-hidden">
                            <p class="text-slate-500 font-semibold truncate" title="${jenis}">${jenis}</p>
                            <p class="text-2xl font-bold text-slate-800">${count}<span class="text-suffix-truk"> Truk</span></p>
                        </div>`;
                    jenisTruckContainer.appendChild(card);
                });
            }
        }
        
        function renderTruckList() {
            const tableBody = document.getElementById('truckTable').querySelector('tbody');
            tableBody.innerHTML = '';

            const { currentPage, filteredData } = paginationState.listTruck;
            
            if (!filteredData || filteredData.length === 0) { 
                tableBody.innerHTML = `<tr><td colspan="10" class="text-center p-8 text-slate-500">Tidak ada data.</td></tr>`; 
                renderPagination('truckTablePagination', 'listTruck', renderTruckList);
                return; 
            }
            
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedData = filteredData.slice(start, end);

            paginatedData.forEach(truck => tableBody.appendChild(createTableRow(truck)));
            
            renderPagination('truckTablePagination', 'listTruck', renderTruckList);
        }

        function createTableRow(truck) {
            const row = document.createElement('tr');
            row.className = 'bg-white border-b hover:bg-slate-50';
            row.setAttribute('data-id', truck.firestoreId);
            updateTableRow(truck, row);
            return row;
        }

        function updateTableRow(truck, rowElement) {
            const row = rowElement || document.querySelector(`#truckTable tr[data-id="${truck.firestoreId}"]`);
            if (!row) return;
            const badgeClasses = statusBadgeMap[truck.keterangan] || 'bg-slate-100 text-slate-800';
            
            row.innerHTML = `
                <td data-field="angkutan" class="px-6 py-4 font-medium">${truck.angkutan || '-'}</td><td data-field="no_mobil" class="px-6 py-4">${truck.no_mobil || '-'}</td>
                <td data-field="jenis_mobil" class="px-6 py-4">${truck.jenis_mobil || '-'}</td><td data-field="keterangan" class="px-6 py-4"><span class="px-3 py-1 text-xs font-semibold leading-tight rounded-full ${badgeClasses}">${truck.keterangan || '-'}</span></td>
                <td data-field="customer" class="px-6 py-4">${truck.customer || '-'}</td><td data-field="tujuan" class="px-6 py-4">${truck.tujuan || '-'}</td>
                <td data-field="nama_driver" class="px-6 py-4">${truck.nama_driver || '-'}</td>
                <td data-field="no_hp" class="px-6 py-4">${truck.no_hp || '-'}</td><td data-field="fo" class="px-6 py-4">${truck.fo || '-'}</td>
                <td class="px-6 py-4 action-buttons flex items-center gap-2">
                    <button class="log p-2 text-xs text-white bg-sky-500 rounded-lg hover:bg-sky-600" title="Lihat Log" onclick="window.showStatusLog('${truck.firestoreId}', '${truck.no_mobil}')"><i class="fas fa-history"></i></button>
                    <button class="edit p-2 text-xs text-white bg-amber-500 rounded-lg hover:bg-amber-600" title="Edit" onclick="window.editRow('${truck.firestoreId}')"><i class="fas fa-pencil-alt"></i></button>
                    <button class="delete p-2 text-xs text-white bg-red-600 rounded-lg hover:bg-red-700" title="Hapus" onclick="window.deleteTruck('${truck.firestoreId}', '${truck.no_mobil}')"><i class="fas fa-trash"></i></button>
                </td>`;
        }

        window.filterTable = function() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            const filtered = window.trucksData.filter(truck => 
                Object.values(truck).some(val => String(val).toLowerCase().includes(searchTerm))
            );

            paginationState.listTruck.filteredData = filtered.sort((a,b) => (a.angkutan || '').localeCompare(b.angkutan || ''));
            paginationState.listTruck.currentPage = 1;
            renderTruckList();
        }
        
        window.addTruck = async function() {
            const newTruck = {
                angkutan: document.getElementById('newAngkutan').value,
                no_mobil: document.getElementById('newNoMobil').value.trim(),
                jenis_mobil: document.getElementById('newJenisMobil').value,
                nama_driver: document.getElementById('newNamaDriver').value.trim(),
                no_hp: document.getElementById('newNoHp').value.trim(),
                keterangan: "TERSEDIA",
                fo: "",
                customer: "",
                tujuan: ""
            };
            if (!newTruck.angkutan || !newTruck.no_mobil || !newTruck.jenis_mobil) {
                showErrorAlert("Input Tidak Lengkap", "Kolom Angkutan, Plat Nomor, dan Jenis Mobil wajib diisi.");
                return;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/trucks`), newTruck);
                window.toggleAddForm(true);
                showSuccessAlert("Berhasil", `Truk ${newTruck.no_mobil} berhasil ditambahkan.`);
            } 
            catch (error) {
                showErrorAlert("Gagal Menambahkan", "Gagal menyimpan data baru.");
                console.error("Add truck error: ", error);
            }
        };

        window.editRow = (firestoreId) => {
            cancelEdit();
            const row = document.querySelector(`tr[data-id="${firestoreId}"]`); if (!row) return;
            const truck = window.trucksData.find(t => t.firestoreId === firestoreId); if (!truck) return;
            const createInput = (value, type = 'text') => `<input type="${type}" class="w-full p-2 border border-slate-300 rounded-lg" value="${value}">`;
            const createSelect = (options, selectedValue) => `<select class="w-full p-2 border border-slate-300 rounded-lg">${options.map(opt => `<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`).join('')}</select>`;
            
            const uniqueAngkutan = [...new Set(window.trucksData.map(t => t.angkutan).filter(Boolean))].sort();
            
            row.querySelectorAll('td[data-field]').forEach(cell => {
                const field = cell.dataset.field; const value = truck[field] || '';
                if(field === 'angkutan') cell.innerHTML = createSelect(uniqueAngkutan, value);
                else if(field === 'jenis_mobil') cell.innerHTML = createSelect(window.jenisTruckData.map(j => j.name), value);
                
                // [PERBAIKAN] Menggunakan 'baseStatusOptions' (daftar simpel)
                // bukan 'statusOptions' (daftar kompleks)
                else if(field === 'keterangan') cell.innerHTML = createSelect(baseStatusOptions, value); 
                
                else cell.innerHTML = createInput(value);
            });
            row.querySelector('.action-buttons').innerHTML = `<button class="save p-2 text-xs text-white bg-green-600 rounded-lg" onclick="window.saveRow('${firestoreId}')"><i class="fas fa-check"></i></button><button class="cancel p-2 text-xs text-white bg-gray-500 rounded-lg" onclick="window.cancelEdit()"><i class="fas fa-times"></i></button>`;
        };

        window.saveRow = async (firestoreId) => {
            const row = document.querySelector(`tr[data-id="${firestoreId}"]`); if (!row) return;
            const updatedData = {};
            row.querySelectorAll('td[data-field]').forEach(cell => {
                const field = cell.dataset.field;
                const input = cell.querySelector('input, select');
                if (input) updatedData[field] = input.value;
            });
            
            const truckDocRef = doc(db, `artifacts/${appId}/public/data/trucks`, firestoreId);

            try {
                const newStatus = updatedData.keterangan;
                if (newStatus) {
                    const docSnap = await getDoc(truckDocRef);
                    if (docSnap.exists()) {
                        const oldStatus = docSnap.data().keterangan;
                        if (oldStatus !== newStatus) {
                            await addDoc(collection(db, "truck_status_logs"), {
                                truckId: firestoreId,
                                plat_nomor: docSnap.data().no_mobil,
                                angkutanName: docSnap.data().angkutan,
                                oldStatus: oldStatus,
                                newStatus: newStatus,
                                changedBy: currentUserData.name || 'Admin',
                                timestamp: serverTimestamp()
                            });
                            showSuccessAlert("Status Diperbarui", `Status truk ${docSnap.data().no_mobil} diubah dari ${oldStatus} ke ${newStatus}.`);
                        }
                    }
                }
                
                await updateDoc(truckDocRef, updatedData); 
                showSuccessAlert("Berhasil", `Data truk ${updatedData.no_mobil} berhasil disimpan.`);

            } catch (error) { 
                console.error("Gagal menyimpan data atau membuat log:", error);
                showErrorAlert("Gagal Menyimpan", "Gagal menyimpan perubahan data truk.");
            }
        };

        window.deleteTruck = async (firestoreId, noMobil) => {
            showConfirmAlert(
                "Konfirmasi Hapus",
                `Yakin ingin menghapus truk ${noMobil}? Tindakan ini tidak dapat dibatalkan.`,
                "Ya, Hapus!",
                async (isConfirmed) => {
                    if (isConfirmed) {
                        try { 
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/trucks`, firestoreId));
                            showSuccessAlert("Dihapus!", `Truk ${noMobil} telah berhasil dihapus.`);
                        }
                        catch (error) { 
                            showErrorAlert("Gagal Menghapus", "Terjadi kesalahan saat menghapus data.");
                            console.error("Delete truck error: ", error);
                        }
                    }
                }
            );
        };
        
        window.cancelEdit = () => renderTruckList();

        window.toggleAddForm = (forceClose = false) => {
            const form = document.getElementById('addForm');
            const isHidden = form.classList.contains('hidden');
            if (forceClose || !isHidden) {
                form.classList.add('hidden');
            } else {
                form.reset();
                document.getElementById('newAngkutan').value = "";
                form.classList.remove('hidden');
            }
        };
        
        function populateAddFormVendorSelect() {
            const angkutanSelect = document.getElementById('newAngkutan');
            if (!angkutanSelect || angkutanSelect.tagName !== 'SELECT') return;

            const uniqueAngkutan = [...new Set(window.trucksData.map(t => t.angkutan).filter(Boolean))].sort();
            
            const previouslySelected = angkutanSelect.value;

            angkutanSelect.innerHTML = '<option value="" disabled selected>Pilih Angkutan...</option>';
            uniqueAngkutan.forEach(angkutan => {
                angkutanSelect.innerHTML += `<option value="${angkutan}">${angkutan}</option>`;
            });

            if (previouslySelected && uniqueAngkutan.includes(previouslySelected)) {
                angkutanSelect.value = previouslySelected;
            }
        }

        function populateJenisTruckDropdowns() {
            const newJenisMobilSelect = document.getElementById('newJenisMobil');
            if (newJenisMobilSelect) {
                let optionsHtml = '';
                window.jenisTruckData.forEach(jenis => {
                    optionsHtml += `<option value="${jenis.name}">${jenis.name}</option>`;
                });
                newJenisMobilSelect.innerHTML = optionsHtml;
            }

            const editingSelect = document.querySelector('td[data-field="jenis_mobil"] select');
            if (editingSelect) {
                const selectedValue = editingSelect.value;
                let optionsHtml = '';
                window.jenisTruckData.forEach(jenis => {
                    const isSelected = jenis.name === selectedValue ? 'selected' : '';
                    optionsHtml += `<option value="${jenis.name}" ${isSelected}>${jenis.name}</option>`;
                });
                editingSelect.innerHTML = optionsHtml;
            }
        }
        
        function populateStatusCardFilters() {
            const angkutanSelect = document.getElementById('statusCardFilterAngkutan'), jenisMobilSelect = document.getElementById('statusCardFilterJenisMobil'), statusSelect = document.getElementById('statusCardFilterStatus');
            const uniqueAngkutan = [...new Set(window.trucksData.map(t => t.angkutan).filter(Boolean))].sort();
            angkutanSelect.innerHTML = '<option value="all">Semua Angkutan</option>'; uniqueAngkutan.forEach(a => angkutanSelect.innerHTML += `<option value="${a}">${a}</option>`);
            
            const uniqueJenis = [...new Set(window.jenisTruckData.map(j => j.name))].sort();
            jenisMobilSelect.innerHTML = '<option value="all">Semua Jenis</option>'; uniqueJenis.forEach(j => jenisMobilSelect.innerHTML += `<option value="${j}">${j}</option>`);
            
            statusSelect.innerHTML = '<option value="all">Semua Status</option>'; statusOptions.forEach(s => statusSelect.innerHTML += `<option value="${s}">${s}</option>`);
        }
        
        function populateSummaryFilters() {
            const angkutanSelect = document.getElementById('summaryFilterAngkutan'), jenisMobilSelect = document.getElementById('summaryFilterJenisMobil'), statusSelect = document.getElementById('summaryFilterStatus');
            const uniqueAngkutan = [...new Set(window.trucksData.map(t => t.angkutan).filter(Boolean))].sort();
            angkutanSelect.innerHTML = '<option value="all">Semua Angkutan</option>'; uniqueAngkutan.forEach(a => angkutanSelect.innerHTML += `<option value="${a}">${a}</option>`);
            
            const uniqueJenis = [...new Set(window.jenisTruckData.map(j => j.name))].sort();
            jenisMobilSelect.innerHTML = '<option value="all">Semua Jenis</option>'; uniqueJenis.forEach(j => jenisMobilSelect.innerHTML += `<option value="${j}">${j}</option>`);
            
            statusSelect.innerHTML = '<option value="all">Semua Status</option>'; 
            // [PERBAIKAN] Menggunakan daftar status baru
            statusSelect.innerHTML += `<option value="TERSEDIA">TERSEDIA</option>`;
            statusSelect.innerHTML += `<option value="OTW MILL">OTW MILL</option>`;
            statusSelect.innerHTML += `<option value="ANTRI MUAT">ANTRI MUAT</option>`;
            statusSelect.innerHTML += `<option value="OTW CUSTOMER">OTW CUSTOMER</option>`;
            statusSelect.innerHTML += `<option value="ANTRI BU17">ANTRI BU17</option>`;
            statusSelect.innerHTML += `<option value="ANTRI CMI">ANTRI CMI</option>`;
            statusSelect.innerHTML += `<option value="ANTRI BONGKAR (Lainnya)">ANTRI BONGKAR (Lainnya)</option>`;
            statusSelect.innerHTML += `<option value="INAP BU17">INAP BU17</option>`;
            statusSelect.innerHTML += `<option value="INAP CMI">INAP CMI</option>`;
            statusSelect.innerHTML += `<option value="INAP (Lainnya)">INAP (Lainnya)</option>`;
            statusSelect.innerHTML += `<option value="STORING">STORING</option>`;
            statusSelect.innerHTML += `<option value="NO DRIVER">NO DRIVER</option>`;
            
            statusSelect.innerHTML += `<option value="ANTRI BONGKAR + INAP">ANTRI BONGKAR + INAP</option>`;
        }
        
        window.displayStatusCards = () => {
            const container = document.getElementById('readOnlyTruckList'); 
            const selectedAngkutan = document.getElementById('statusCardFilterAngkutan').value, selectedJenisMobil = document.getElementById('statusCardFilterJenisMobil').value, selectedStatus = document.getElementById('statusCardFilterStatus').value;
            let filteredTrucks = window.trucksData;
            if (selectedAngkutan !== 'all') filteredTrucks = filteredTrucks.filter(t => t.angkutan === selectedAngkutan);
            if (selectedJenisMobil !== 'all') filteredTrucks = filteredTrucks.filter(t => t.jenis_mobil === selectedJenisMobil);
            if (selectedStatus !== 'all') filteredTrucks = filteredTrucks.filter(t => t.keterangan === selectedStatus);
            container.innerHTML = '';
            if (!filteredTrucks || filteredTrucks.length === 0) { container.innerHTML = `<p class="text-slate-500 col-span-full text-center">Tidak ada data.</p>`; return; }
            const sortedTrucks = [...filteredTrucks].sort((a, b) => statusOptions.indexOf(a.keterangan) - statusOptions.indexOf(b.keterangan));
            sortedTrucks.forEach((truck) => container.appendChild(createStatusCard(truck)));
        }

        function createStatusCard(truck) {
            const card = document.createElement('div'); card.className = 'bg-white p-6 rounded-xl shadow-md';
            card.setAttribute('data-id', truck.firestoreId);
            updateStatusCard(truck, card);
            return card;
        }

        function updateStatusCard(truck, cardElement) {
            const card = cardElement || document.querySelector(`#readOnlyTruckList div[data-id="${truck.firestoreId}"]`);
            if (!card) return;
            const badgeClasses = statusBadgeMap[truck.keterangan] || 'bg-slate-100 text-slate-800';
            const p = truck.panjang || 0, l = truck.lebar || 0, t = truck.tinggi || 0;
            const kubikasi = (p * l * t / 1000000).toFixed(2);
            const [tanggal, jam] = (truck.waktu || 'T').split('T');
            const waktuDisplay = tanggal && jam ? `${tanggal}, ${jam}` : '-';

            const formatWaktu = (waktu) => {
                if (!waktu) return '-';
                const [d, t] = waktu.split('T');
                return `${d}, ${t || ''}`;
            };
            const timestampHTML = `
            <div class="border-t border-slate-100 pt-2 mt-2 space-y-2 text-xs">
                <div class="flex justify-between"><span class="text-slate-500">Tiba Muat:</span><span class="text-slate-700 font-semibold">${formatWaktu(truck.tiba_lokasi_muat)}</span></div>
                <div class="flex justify-between"><span class="text-slate-500">Keluar Muat:</span><span class="text-slate-700 font-semibold">${formatWaktu(truck.keluar_lokasi_muat)}</span></div>
                <div class="flex justify-between"><span class="text-slate-500">Tiba Bongkar:</span><span class="text-slate-700 font-semibold">${formatWaktu(truck.tiba_lokasi_bongkar)}</span></div>
                <div class="flex justify-between"><span class="text-slate-500">Keluar Bongkar:</span><span class="text-slate-700 font-semibold">${formatWaktu(truck.keluar_lokasi_bongkar)}</span></div>
            </div>`;
            
            card.innerHTML = `<div class="flex justify-between items-start"><h3 class="text-lg font-bold text-slate-800">${truck.no_mobil}</h3><span class="px-3 py-1 text-xs font-semibold leading-tight rounded-full ${badgeClasses}">${getDynamicStatus(truck) || 'N/A'}</span></div><p class="text-sm text-slate-500 mb-4">${truck.jenis_mobil || ''}</p><div class="border-t border-slate-200 pt-4 mt-4 space-y-2 text-sm"><div class="flex justify-between"><span class="text-slate-500 font-medium">Customer:</span><span class="text-slate-700 font-semibold">${truck.customer || '-'}</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">Kota:</span><span class="text-slate-700 font-semibold">${truck.tujuan || '-'}</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">Angkutan:</span><span class="text-slate-700 font-semibold">${truck.angkutan || '-'}</span></div>${timestampHTML}<div class="flex justify-between"><span class="text-slate-500 font-medium">Terakhir Update Status:</span><span class="text-slate-700 font-semibold">${waktuDisplay}</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">Driver:</span><span class="text-slate-700 font-semibold">${truck.nama_driver || '-'}</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">No HP:</span><span class="text-slate-700 font-semibold">${truck.no_hp || '-'}</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">No. FO:</span><span class="text-slate-700 font-semibold">${truck.fo || '-'}</span></div></div><div class="border-t border-slate-200 pt-2 mt-2 space-y-2 text-sm"><div class="flex justify-between"><span class="text-slate-500 font-medium">Dimensi:</span><span class="text-slate-700 font-semibold">${p}${l}${t} cm</span></div><div class="flex justify-between"><span class="text-slate-500 font-medium">Kubikasi:</span><span class="text-slate-700 font-bold text-indigo-600">${kubikasi} m</span></div></div>`;
        }
        
        window.renderSummaryReport = function() {
            const selectedAngkutan = document.getElementById('summaryFilterAngkutan').value;
            const selectedJenisMobil = document.getElementById('summaryFilterJenisMobil').value;
            const selectedStatus = document.getElementById('summaryFilterStatus').value;

            // --- LOGIKA BARU UNTUK CEK STATUS INAP ---
            const isCombinedMode = selectedStatus === 'ANTRI BONGKAR + INAP';
            const showLeadTimeColumn = isCombinedMode || selectedStatus.startsWith('INAP');
            // --- BATAS LOGIKA BARU ---

            let filteredData = [...window.trucksData];
            if (selectedAngkutan !== 'all') filteredData = filteredData.filter(t => t.angkutan === selectedAngkutan);
            if (selectedJenisMobil !== 'all') filteredData = filteredData.filter(t => t.jenis_mobil === selectedJenisMobil);
            
            if (selectedStatus === 'INAP BU17') {
                filteredData = filteredData.filter(t => t.keterangan === 'INAP' && getDynamicStatus(t) === 'INAP BU17');
            } else if (selectedStatus === 'INAP CMI') {
                filteredData = filteredData.filter(t => t.keterangan === 'INAP' && getDynamicStatus(t) === 'INAP CMI');
            } else if (selectedStatus === 'INAP (Lainnya)') {
                filteredData = filteredData.filter(t => t.keterangan === 'INAP' && getDynamicStatus(t) === 'INAP (Lainnya)');
            } else if (selectedStatus === 'ANTRI BONGKAR + INAP') {
                filteredData = filteredData.filter(t => t.keterangan === 'ANTRI BONGKAR' || t.keterangan === 'INAP');
            } else if (selectedStatus !== 'all') {
                filteredData = filteredData.filter(t => t.keterangan === selectedStatus);
            }

            // --- LOGIKA BARU UNTUK SORTIR ---
            if (showLeadTimeColumn) {
                filteredData.sort((a, b) => {
                    // Sortir INAP dulu, baru ANTRI BONGKAR
                    const statusPriority = { 'INAP BU17': 1, 'INAP CMI': 1, 'INAP (Lainnya)': 1, 'ANTRI BONGKAR': 2 };
                    const statusA = statusPriority[getDynamicStatus(a)] || 3;
                    const statusB = statusPriority[getDynamicStatus(b)] || 3;
                    const statusComp = statusA - statusB;
                    if (statusComp !== 0) return statusComp;
                    
                    // Lalu sortir berdasarkan lead time terlama
                    const leadTimeA = calculateLeadTimeInMinutes(a.tiba_lokasi_bongkar);
                    const leadTimeB = calculateLeadTimeInMinutes(b.tiba_lokasi_bongkar);
                    return leadTimeB - leadTimeA;
                });
            }
            // --- BATAS LOGIKA SORTIR ---

            const tableHeaderRow = document.getElementById('summaryTable').querySelector('thead tr');
            const tableBody = document.getElementById('summaryTableBody');
            tableBody.innerHTML = '';

            // --- LOGIKA BARU UNTUK ATUR HEADER TABEL ---
            const leadTimeTh = tableHeaderRow.querySelector('th.lead-time-col');
            if (leadTimeTh) {
                leadTimeTh.remove(); // Hapus header lama jika ada
            }
            if (showLeadTimeColumn) {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 lead-time-col'; // Tambah kelas agar mudah ditemukan
                th.textContent = 'LEAD TIME';
                tableHeaderRow.appendChild(th);
            }
            // --- BATAS LOGIKA HEADER ---

            if (filteredData.length === 0) {
                const colspan = showLeadTimeColumn ? 14 : 13; // Sesuaikan colspan
                tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center p-8 text-slate-500">Tidak ada data.</td></tr>`;
                return;
            }
            
            const formatWaktuTabel = (waktu) => waktu ? waktu.replace('T', ' ') : '-';
            filteredData.forEach(truck => {
                const badgeClasses = statusBadgeMap[truck.keterangan] || 'bg-slate-100 text-slate-800';
                
                // --- KODE ROW DIBUAT DENGAN 'let' AGAR BISA DITAMBAH ---
                let rowHtml = `
                <tr class="bg-white border-b">
                    <td class="px-6 py-4 font-medium">${truck.angkutan || '-'}</td>
                    <td class="px-6 py-4">${truck.fo || '-'}</td>
                    <td class="px-6 py-4">${formatWaktuTabel(truck.tiba_lokasi_muat)}</td>
                    <td class="px-6 py-4">${formatWaktuTabel(truck.keluar_lokasi_muat)}</td>
                    <td class="px-6 py-4">${formatWaktuTabel(truck.tiba_lokasi_bongkar)}</td>
                    <td class="px-6 py-4">${formatWaktuTabel(truck.keluar_lokasi_bongkar)}</td>
                    <td class="px-6 py-4">${truck.customer || '-'}</td>
                    <td class="px-6 py-4">${truck.tujuan || '-'}</td>
                    <td class="px-6 py-4"><span class="px-3 py-1 text-xs font-semibold leading-tight rounded-full ${badgeClasses}">${getDynamicStatus(truck) || '-'}</span></td>
                    <td class="px-6 py-4">${truck.nama_driver || '-'}</td>
                    <td class="px-6 py-4">${truck.no_hp || '-'}</td>
                    <td class="px-6 py-4">${truck.no_mobil || '-'}</td>
                    <td class="px-6 py-4">${truck.jenis_mobil || '-'}</td>
                `;

                // --- LOGIKA BARU UNTUK TAMBAH SEL LEAD TIME ---
                if (showLeadTimeColumn) {
                    rowHtml += `<td class="px-6 py-4 font-semibold">${calculateLeadTime(truck.tiba_lokasi_bongkar)}</td>`;
                }
                // --- BATAS LOGIKA SEL ---

                rowHtml += `</tr>`;
                tableBody.innerHTML += rowHtml;
            });
        }
        
        function renderGroupedInapTable(tableBodyId, tfootId, data) {
            const tableBody = document.getElementById(tableBodyId);
            const tfoot = document.getElementById(tfootId);
            tableBody.innerHTML = '';
            tfoot.innerHTML = ''; 

            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-slate-500">Tidak ada truk di kategori ini.</td></tr>`;
                return;
            }

            // 1. Definisikan warna soft (Tailwind classes)
            const bgBU17 = 'bg-orange-50'; // Soft Oranye
            const bgCMI = 'bg-green-50';   // Soft Hijau
            const bgOther = 'bg-white';    // Default

            // 2. Pisahkan data menjadi tiga grup
            const bu17Trucks = data.filter(t => t.dynamicStatus === 'INAP BU17');
            const cmiTrucks = data.filter(t => t.dynamicStatus === 'INAP CMI');
            const otherTrucks = data.filter(t => t.dynamicStatus !== 'INAP BU17' && t.dynamicStatus !== 'INAP CMI');

            let grandTotal = 0;

            // 3. Buat fungsi helper untuk me-render grup (agar tidak duplikat kode)
            //    Fungsi ini berisi logika lama Anda (group by customer, lalu city)
            const renderTruckGroup = (truckList, groupName, headerBgClass, rowBgClass) => {
                if (truckList.length === 0) return; // Lewati jika grup ini kosong

                // Tambahkan baris header untuk grup (misal "BU17")
                const groupHeaderRow = document.createElement('tr');
                groupHeaderRow.className = `${headerBgClass} font-bold text-slate-700`; // Latar belakang lebih tebal
                
                // [PERBAIKAN] Poin 1: Tambahkan 'text-center' dan 'py-3' untuk centering
                groupHeaderRow.innerHTML = `<td class="px-6 py-3 text-center" colspan="6">${groupName} (${truckList.length} Truk)</td>`;
                tableBody.appendChild(groupHeaderRow);

                const groupedByCustomer = truckList.reduce((acc, truck) => {
                    const customer = truck.customer || 'Customer Tidak Diketahui';
                    if (!acc[customer]) { acc[customer] = []; }
                    acc[customer].push(truck);
                    return acc;
                }, {});

                const sortedCustomers = Object.keys(groupedByCustomer).sort();

                sortedCustomers.forEach(customerName => {
                    const trucksForCustomer = groupedByCustomer[customerName];
                    let customerTotal = 0;

                    const groupedByCity = trucksForCustomer.reduce((acc, truck) => {
                        const city = truck.tujuan || 'Kota Tidak Diketahui';
                        if (!acc[city]) { acc[city] = []; }
                        acc[city].push(truck);
                        return acc;
                    }, {});

                    const sortedCities = Object.keys(groupedByCity).sort();
                    
                    let isFirstRowOfCustomer = true;
                    sortedCities.forEach(cityName => {
                        const trucksInCity = groupedByCity[cityName];
                        const cityTotal = trucksInCity.length;
                        customerTotal += cityTotal;

                        trucksInCity.forEach((truck, index) => {
                            const row = document.createElement('tr');
                            // Terapkan warna background di sini
                            row.className = `${rowBgClass} border-b`;
                            
                            row.innerHTML = `
                                <td class="px-6 py-2 font-semibold">${isFirstRowOfCustomer && index === 0 ? customerName : ''}</td>
                                <td class="px-6 py-2">${index === 0 ? cityName : ''}</td>
                                <td class="px-6 py-2">${truck.angkutan || '-'}</td>
                                <td class="px-6 py-2">${truck.no_mobil || '-'}</td>
                                <td class="px-6 py-2">${truck.leadTimeFormatted}</td>
                                <td class="px-6 py-2 text-center">1</td>
                            `;
                            tableBody.appendChild(row);
                            isFirstRowOfCustomer = false;
                        });

                        // City Total Row
                        const cityTotalRow = document.createElement('tr');
                        // Terapkan warna background di sini juga
                        cityTotalRow.className = `${rowBgClass} font-bold border-b`;
                        cityTotalRow.innerHTML = `
                            <td></td>
                            <td class="px-6 py-2 text-left">${cityName} TOTAL</td>
                            <td colspan="3"></td>
                            <td class="px-6 py-2 text-center text-red-600">${cityTotal}</td>
                        `;
                        tableBody.appendChild(cityTotalRow);
                    });

                    // Customer Total Row (biarkan warna ini agar menonjol)
                    const customerTotalRow = document.createElement('tr');
                    customerTotalRow.className = 'bg-slate-200 font-extrabold text-slate-800';
                    customerTotalRow.innerHTML = `
                        <td class="px-6 py-2 text-left" colspan="5">${customerName} TOTAL</td>
                        <td class="px-6 py-2 text-center">${customerTotal}</td>
                    `;
                    tableBody.appendChild(customerTotalRow);
                });
            };

            // 4. Render setiap grup berdasarkan urutan yang diminta
            renderTruckGroup(bu17Trucks, 'BU17', 'bg-orange-200', bgBU17);
            renderTruckGroup(cmiTrucks, 'CMI', 'bg-green-200', bgCMI);
            renderTruckGroup(otherTrucks, 'INAP (LAINNYA)', 'bg-slate-100', bgOther);
            
            // 5. Hitung dan render Grand Total
            grandTotal = data.length;
            tfoot.innerHTML = `
                <tr class="bg-slate-800 font-bold text-white">
                    <td class="px-6 py-3 text-left" colspan="5">GRAND TOTAL</td>
                    <td class="px-6 py-3 text-center text-lg">${grandTotal}</td>
                </tr>
            `;
        }


        // --- TAMBAHKAN FUNGSI HELPER BARU DI SINI ---
        function renderInapSummaryTable(tableBodyId, grandTotalId, inapTrucks) {
            const customerTableBody = document.getElementById(tableBodyId);
            const grandTotalCell = document.getElementById(grandTotalId);
            customerTableBody.innerHTML = '';

            const customerCityCounts = inapTrucks.reduce((acc, truck) => {
                const customer = truck.customer || 'Customer Tidak Diketahui';
                const city = truck.tujuan || 'Kota Tidak Diketahui';
                const key = `${customer}|${city.toUpperCase()}`;
                
                if (!acc[key]) {
                    acc[key] = { count: 0, displayCity: city, customerName: customer };
                }
                
                acc[key].count += 1;
                return acc;
            }, {});

            const sortedCustomers = Object.values(customerCityCounts).sort((a, b) => {
                const countComparison = b.count - a.count;
                if (countComparison !== 0) {
                    return countComparison;
                }
                return a.customerName.localeCompare(b.customerName);
            });
            
            let grandTotal = 0;

            if (sortedCustomers.length === 0) {
                customerTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-4 text-slate-500">Tidak ada truk yang berstatus INAP di kategori ini.</td></tr>`;
            } else {
                sortedCustomers.forEach(item => {
                    grandTotal += item.count;
                    customerTableBody.innerHTML += `
                        <tr class="bg-white border-b hover:bg-slate-50">
                            <td class="px-4 py-3 font-medium">${item.customerName}</td>
                            <td class="px-4 py-3">${item.displayCity}</td>
                            <td class="px-4 py-3 text-center font-bold text-xl text-red-600">${item.count}</td>
                        </tr>
                    `;
                });
            }
            grandTotalCell.textContent = grandTotal;
        }
        // --- BATAS FUNGSI HELPER BARU ---


        function renderLaporanInap() {
            const inapTrucks = window.trucksData.filter(truck => 
                truck.keterangan === 'INAP' && truck.tiba_lokasi_bongkar
            ).map(truck => {
                const leadTimeMinutes = calculateLeadTimeInMinutes(truck.tiba_lokasi_bongkar);
                return { 
                    ...truck, 
                    leadTimeMinutes: leadTimeMinutes,
                    leadTimeFormatted: calculateLeadTime(truck.tiba_lokasi_bongkar),
                    leadTimeDays: calculateLeadTimeInDays(truck.tiba_lokasi_bongkar),
                    dynamicStatus: getDynamicStatus(truck) 
                };
            }).sort((a, b) => b.leadTimeMinutes - a.leadTimeMinutes);

            // 1. Bagi data INAP menjadi 3 kategori
            const inapBU17 = inapTrucks.filter(t => t.dynamicStatus === 'INAP BU17');
            const inapCMI = inapTrucks.filter(t => t.dynamicStatus === 'INAP CMI');
            const inapLainnya = inapTrucks.filter(t => t.dynamicStatus === 'INAP (Lainnya)');

            // 2. Panggil helper baru kita untuk setiap tabel
            renderInapSummaryTable('inap-by-customer-table-body-bu17', 'inap-grand-total-bu17', inapBU17);
            renderInapSummaryTable('inap-by-customer-table-body-cmi', 'inap-grand-total-cmi', inapCMI);

            const LIMIT_3_DAYS = 3;
            const LIMIT_6_DAYS = 6;
            const LIMIT_9_DAYS = 9;

            const categories = [
                { id: 'less-3days', data: inapTrucks.filter(t => t.leadTimeDays < LIMIT_3_DAYS), tableBodyId: 'inap-table-less-3days', tfootId: 'inap-tfoot-less-3days' },
                { id: '3-6days', data: inapTrucks.filter(t => t.leadTimeDays >= LIMIT_3_DAYS && t.leadTimeDays < LIMIT_6_DAYS), tableBodyId: 'inap-table-3-6days', tfootId: 'inap-tfoot-3-6days' },
                { id: '6-9days', data: inapTrucks.filter(t => t.leadTimeDays >= LIMIT_6_DAYS && t.leadTimeDays < LIMIT_9_DAYS), tableBodyId: 'inap-table-6-9days', tfootId: 'inap-tfoot-6-9days' },
                { id: 'more-9days', data: inapTrucks.filter(t => t.leadTimeDays >= LIMIT_9_DAYS), tableBodyId: 'inap-table-more-9days', tfootId: 'inap-tfoot-more-9days' }
            ];

            const titleMap = {
                'less-3days': 'INAP : < 3 HARI',
                '3-6days': 'INAP : 3 - 6 HARI',
                '6-9days': 'INAP : 6 - 9 HARI',
                'more-9days': 'INAP : > 9 HARI'
            };

            categories.forEach(cat => {
                const totalSpan = document.getElementById(`total-${cat.id}`);
                // [PERBAIKAN] Cek jika totalSpan ada sebelum mengakses parentElement
                if (totalSpan) {
                    const h4 = totalSpan.parentElement; // Dapatkan elemen <h4>
                    const baseTitle = titleMap[cat.id];

                    const bu17Count = cat.data.filter(t => t.dynamicStatus === 'INAP BU17').length;
                    const cmiCount = cat.data.filter(t => t.dynamicStatus === 'INAP CMI').length;
                    const totalCount = cat.data.length;

                    // [PERBAIKAN] Tambahkan style="color:..." agar bisa dibaca oleh html2canvas
                    const newTitle = `
                        ${baseTitle} | 
                        <span class="text-orange-600" style="color: #ea580c;">BU17 : ${bu17Count} TRUK</span> | 
                        <span class="text-green-600" style="color: #16a34a;">CMI : ${cmiCount} TRUK</span> | 
                        TOTAL : ${totalCount} TRUK
                    `;
                    
                    h4.innerHTML = newTitle;
                }
                
                renderGroupedInapTable(cat.tableBodyId, cat.tfootId, cat.data);
            });
            
            const detailTableBody = document.getElementById('inap-detail-table-body');
            detailTableBody.innerHTML = '';
            if (inapTrucks.length === 0) {
                detailTableBody.innerHTML = `<tr><td colspan="15" class="text-center p-4 text-slate-500">Tidak ada truk inap untuk ditampilkan.</td></tr>`;
            } else {
                inapTrucks.forEach((truck, index) => {
                    const row = document.createElement('tr');
                    const leadTimeDays = truck.leadTimeDays;
                    let bgColorClass = '';

                    if (leadTimeDays > 9) {
                        bgColorClass = 'bg-red-100 text-red-900';
                    } else if (leadTimeDays >= 6) {
                        bgColorClass = 'bg-orange-100 text-orange-900';
                    } else if (leadTimeDays >= 3) {
                        bgColorClass = 'bg-yellow-100 text-yellow-900';
                    } else { 
                        bgColorClass = 'bg-green-100 text-green-900';
                    }

                    row.className = `border-b ${bgColorClass}`;
                    
                    row.innerHTML = `
                        <td class="px-4 py-2">${index + 1}</td>
                        <td class="px-4 py-2">${truck.angkutan || '-'}</td>
                        <td class="px-4 py-2">${truck.fo || '-'}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${formatTanggalJam(truck.tiba_lokasi_muat)}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${formatTanggalJam(truck.keluar_lokasi_muat)}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${formatTanggalJam(truck.tiba_lokasi_bongkar)}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${formatTanggalJam(truck.keluar_lokasi_bongkar)}</td>
                        <td class="px-4 py-2">${truck.customer || '-'}</td>
                        <td class="px-4 py-2">${truck.tujuan || '-'}</td>
                        <td class="px-4 py-2"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusBadgeMap[truck.keterangan] || ''}">${getDynamicStatus(truck)}</span></td>
                        <td class="px-4 py-2">${truck.nama_driver || '-'}</td>
                        <td class="px-4 py-2">${truck.no_hp || '-'}</td>
                        <td class_name="px-4 py-2">${truck.no_mobil || '-'}</td>
                        <td class="px-4 py-2">${truck.jenis_mobil || '-'}</td>
                        <td class="px-4 py-2 font-semibold">${truck.leadTimeFormatted}</td>
                    `;

                    detailTableBody.appendChild(row);
                });
            }
        }

        function renderModalTable(trucksToRender) {
            const modalList = document.getElementById('modal-truck-list');
            modalList.innerHTML = '';
            if (!trucksToRender || trucksToRender.length === 0) {
                // Update colspan menjadi 9 karena kolom bertambah
                modalList.innerHTML = '<tr><td colspan="9" class="text-center p-6 text-slate-500">Tidak ada truk yang cocok.</td></tr>';
                return;
            }
            trucksToRender.forEach(truck => {
                const p = truck.panjang || 0, l = truck.lebar || 0, t = truck.tinggi || 0;
                const dimensi = `${p}${l}${t}`;
                const kubikasi = (p * l * t / 1000000).toFixed(2);
                const row = document.createElement('tr');
                row.className = 'border-b';
                
                // PERHATIKAN BAGIAN INI: Tambahkan truck.customer dan truck.fo setelah truck.nama_driver
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium">${truck.angkutan || '-'}</td>
                    <td class="px-4 py-3">${truck.no_mobil || '-'}</td>
                    <td class="px-4 py-3">${truck.nama_driver || '-'}</td>
                    
                    <td class="px-4 py-3">${truck.customer || '-'}</td>
                    <td class="px-4 py-3">${truck.fo || '-'}</td>
                    <td class="px-4 py-3">${truck.no_hp || '-'}</td>
                    <td class="px-4 py-3">${truck.jenis_mobil || '-'}</td>
                    <td class="px-4 py-3">${dimensi}</td>
                    <td class="px-4 py-3 font-semibold">${kubikasi} m</td>
                `;
                modalList.appendChild(row);
            });
        }

        function applyModalFiltersAndSort() {
            const searchTerm = document.getElementById('modalSearchInput').value.toLowerCase();
            const selectedAngkutan = document.getElementById('modalFilterAngkutan').value;
            let filtered = [...currentModalTrucks];
            if (selectedAngkutan) {
                filtered = filtered.filter(truck => truck.angkutan === selectedAngkutan);
            }
            if (searchTerm) {
                filtered = filtered.filter(truck => Object.values(truck).some(val => String(val).toLowerCase().includes(searchTerm)));
            }
            filtered.sort((a, b) => {
                const valA = a[modalSort.column] || '';
                const valB = b[modalSort.column] || '';
                const comparison = valA.localeCompare(valB, undefined, { numeric: true });
                return modalSort.direction === 'asc' ? comparison : -comparison;
            });
            renderModalTable(filtered);
        }

        window.sortModalTable = (column) => {
            if (modalSort.column === column) {
                modalSort.direction = modalSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                modalSort.column = column;
                modalSort.direction = 'asc';
            }
            applyModalFiltersAndSort();
        };

        window.showTrucksByStatus = (status) => {
            // [PERBAIKAN] Logika 'if' diubah untuk mendeteksi nama status baru
            if (status.startsWith('INAP') || status === 'ANTRI BU17' || status === 'ANTRI CMI' || status === 'ANTRI BONGKAR (Lainnya)') {
                // Jika ya, panggil fungsi modal INAP/Lama Inap
                showInapStatusModal(status);
                return; // Hentikan eksekusi di sini
            }

            // --- Kode di bawah ini adalah kode LAMA Anda, untuk status NON-INAP ---
            // Ini hanya akan berjalan untuk status seperti TERSEDIA, OTW MILL, ANTRI MUAT, dll.
            const modal = document.getElementById('status-modal');
            const modalTitle = document.getElementById('modal-title');
            const filterDropdown = document.getElementById('modalFilterAngkutan');
            const searchInput = document.getElementById('modalSearchInput');
            
            currentModalTrucks = window.trucksData.filter(truck => truck.keterangan === status);

            modalTitle.textContent = `Daftar Truk: ${status}`;
            const uniqueAngkutan = [...new Set(currentModalTrucks.map(t => t.angkutan))].sort();
            filterDropdown.innerHTML = '<option value="">Semua Angkutan</option>';
            uniqueAngkutan.forEach(a => { if (a) filterDropdown.innerHTML += `<option value="${a}">${a}</option>`; });
            searchInput.value = '';
            filterDropdown.value = '';
            modalSort = { column: 'angkutan', direction: 'asc' };
            renderModalTable(currentModalTrucks);
            modal.classList.remove('hidden');
        }

        window.closeModal = () => {
            document.getElementById('status-modal').classList.add('hidden');
        }

        // Fungsi untuk menutup modal INAP yang baru
        window.closeInapStatusModal = () => {
            document.getElementById('inap-status-modal').classList.add('hidden');
        }

        // Fungsi untuk menampilkan modal INAP (dipanggil oleh showTrucksByStatus)
        function showInapStatusModal(status) {
            const modal = document.getElementById('inap-status-modal');
            const modalTitle = document.getElementById('inap-modal-title');
            
            modalTitle.textContent = `Daftar Truk: ${status}`;

            let filteredTrucks;
            // [PERBAIKAN] Menggunakan nama status baru
            if (status === 'INAP BU17') {
                filteredTrucks = window.trucksData.filter(truck => 
                    truck.keterangan === 'INAP' && getDynamicStatus(truck) === 'INAP BU17'
                );
            } else if (status === 'INAP CMI') {
                filteredTrucks = window.trucksData.filter(truck => 
                    truck.keterangan === 'INAP' && getDynamicStatus(truck) === 'INAP CMI'
                );
            } else if (status === 'INAP (Lainnya)') {
                 filteredTrucks = window.trucksData.filter(truck => 
                    truck.keterangan === 'INAP' && getDynamicStatus(truck) === 'INAP (Lainnya)'
                );
            } else if (status === 'ANTRI BU17') { // <-- REVISI
                filteredTrucks = window.trucksData.filter(truck => 
                    truck.keterangan === 'ANTRI BONGKAR' && getDynamicStatus(truck) === 'ANTRI BU17'
                );
            } else if (status === 'ANTRI CMI') { // <-- REVISI
                filteredTrucks = window.trucksData.filter(truck => 
                    truck.keterangan === 'ANTRI BONGKAR' && getDynamicStatus(truck) === 'ANTRI CMI'
                );
            } else { // Asumsi sisanya adalah 'ANTRI BONGKAR (Lainnya)'
                 filteredTrucks = window.trucksData.filter(truck => 
                    truck.keterangan === 'ANTRI BONGKAR' && getDynamicStatus(truck) === 'ANTRI BONGKAR (Lainnya)'
                );
            }

            // 2. Hitung lead time untuk setiap truk yang difilter
            currentInapModalTrucks = filteredTrucks.map(truck => {
                return {
                    ...truck,
                    leadTimeFormatted: calculateLeadTime(truck.tiba_lokasi_bongkar),
                    leadTimeMinutes: calculateLeadTimeInMinutes(truck.tiba_lokasi_bongkar)
                };
            });

            // 3. Atur sorting default (sesuai permintaan: lama > baru)
            inapModalSort = { column: 'leadTimeMinutes', direction: 'desc' };
            
            // 4. Render tabel
            renderInapModalTable();
            
            // 5. Tampilkan modal
            modal.classList.remove('hidden');
        }

        // Fungsi untuk me-render isi tabel modal INAP
        function renderInapModalTable() {
            const modalList = document.getElementById('inap-modal-truck-list');
            modalList.innerHTML = '';

            // Terapkan sorting
            const sortedData = [...currentInapModalTrucks].sort((a, b) => {
                const col = inapModalSort.column;
                const dir = inapModalSort.direction === 'asc' ? 1 : -1;
                
                const valA = a[col] || (col === 'leadTimeMinutes' ? 0 : '');
                const valB = b[col] || (col === 'leadTimeMinutes' ? 0 : '');

                if (typeof valA === 'number' && typeof valB === 'number') {
                    return (valA - valB) * dir;
                }
                
                return String(valA).localeCompare(String(valB), undefined, { numeric: true }) * dir;
            });

            if (sortedData.length === 0) {
                modalList.innerHTML = '<tr><td colspan="5" class="text-center p-6 text-slate-500">Tidak ada truk yang cocok.</td></tr>';
                return;
            }

            // [REVISI] Urutan kolom di 'row.innerHTML' diubah
            sortedData.forEach(truck => {
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                    <td class="px-4 py-3">${truck.angkutan || '-'}</td>
                    <td class="px-4 py-3">${truck.no_mobil || '-'}</td>
                    <td class="px-4 py-3">${truck.customer || '-'}</td>
                    <td class="px-4 py-3">${truck.tujuan || '-'}</td>
                    <td class="px-4 py-3 font-semibold">${truck.leadTimeFormatted || '-'}</td>
                `;
                modalList.appendChild(row);
            });
        }

        // Fungsi untuk sorting saat header tabel modal INAP diklik
        window.sortInapModalTable = (column) => {
            if (inapModalSort.column === column) {
                inapModalSort.direction = inapModalSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                inapModalSort.column = column;
                inapModalSort.direction = 'asc';
            }
            renderInapModalTable();
        };

        // --- BATAS FUNGSI BARU ---

        window.showStatusLog = async (truckId, platNomor) => {
            const modal = document.getElementById('log-modal');
            const title = document.getElementById('log-modal-title');
            const tableBody = document.getElementById('log-modal-table-body');
            
            title.textContent = `Log Perubahan Status - ${platNomor}`;
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-slate-500"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat log...</td></tr>`;
            modal.classList.remove('hidden');

            try {
                const logsRef = collection(db, "truck_status_logs");
                const q = query(logsRef, where("truckId", "==", truckId), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-slate-500">Tidak ada riwayat perubahan status untuk truk ini.</td></tr>`;
                    return;
                }

                tableBody.innerHTML = '';
                querySnapshot.forEach(doc => {
                    const log = doc.data();
                    const timestamp = log.timestamp?.toDate() ? log.timestamp.toDate().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' }) : 'N/A';
                    const row = `
                        <tr class="border-b hover:bg-slate-50">
                            <td class="px-4 py-3">${timestamp}</td>
                            <td class="px-4 py-3"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusBadgeMap[log.oldStatus] || ''}">${log.oldStatus}</span></td>
                            <td class="px-4 py-3"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusBadgeMap[log.newStatus] || ''}">${log.newStatus}</span></td>
                            <td class="px-4 py-3 font-medium">${log.changedBy}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            } catch (error) {
                console.error("Gagal memuat log:", error);
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-red-500">Gagal memuat riwayat.</td></tr>`;
            }
        };

        window.closeLogModal = () => {
            document.getElementById('log-modal').classList.add('hidden');
        };
        
        function renderCustomerTable() {
            const tableBody = document.getElementById('customerTable').querySelector('tbody');
            tableBody.innerHTML = '';
            
            const { currentPage, filteredData } = paginationState.masterCustomer;

            if (filteredData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="2" class="text-center p-8 text-slate-500">Belum ada data customer.</td></tr>`;
                renderPagination('customerTablePagination', 'masterCustomer', renderCustomerTable);
                return;
            }

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedData = filteredData.slice(start, end);

            paginatedData.forEach(customer => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-slate-50';
                row.setAttribute('data-id', customer.id);
                row.innerHTML = `
                <td data-field="name" class="px-6 py-4 font-medium">${customer.name}</td>
                <td data-field="customer_type" class="px-6 py-4">${customer.customer_type || 'N/A'}</td>
                <td class="px-6 py-4 action-buttons flex items-center gap-2">
                    <button class="edit p-2 text-xs text-white bg-amber-500 rounded-lg hover:bg-amber-600" title="Edit" onclick="window.editCustomer('${customer.id}')"><i class="fas fa-pencil-alt"></i></button>
                    <button class="delete p-2 text-xs text-white bg-red-600 rounded-lg hover:bg-red-700" title="Hapus" onclick="window.deleteCustomer('${customer.id}', '${customer.name}')"><i class="fas fa-trash"></i></button>
                </td>
            `;
                tableBody.appendChild(row);
            });

            renderPagination('customerTablePagination', 'masterCustomer', renderCustomerTable);
        }

        window.toggleAddCustomerForm = (forceClose = false) => {
            const form = document.getElementById('addCustomerForm');
            const isHidden = form.classList.contains('hidden');
            if (forceClose || !isHidden) {
                form.classList.add('hidden');
            } else {
                form.reset();
                form.classList.remove('hidden');
            }
        };

        window.addCustomer = async () => {
            const customerNameInput = document.getElementById('newCustomerName');
            const customerTypeSelect = document.getElementById('newCustomerType');
            const customerName = customerNameInput.value.trim();
            const customerType = customerTypeSelect.value; // Ambil nilai tipe

            if (!customerName) {
                showErrorAlert("Input Tidak Lengkap", "Nama customer tidak boleh kosong.");
                return;
            }
            try {
                // Simpan tipe customer ke database
                await addDoc(collection(db, "customers"), { name: customerName, customer_type: customerType });
                toggleAddCustomerForm(true);
                showSuccessAlert("Berhasil", `Customer ${customerName} (Tipe: ${customerType}) berhasil ditambahkan.`);
            } catch (error) {
                console.error("Error adding customer: ", error);
                showErrorAlert("Gagal Menambahkan", "Gagal menambahkan customer baru.");
            }
        };

        window.deleteCustomer = async (id, name) => {
            showConfirmAlert(
                "Konfirmasi Hapus",
                `Yakin ingin menghapus customer "${name}"?`,
                "Ya, Hapus!",
                async (isConfirmed) => {
                    if (isConfirmed) {
                        try {
                            await deleteDoc(doc(db, "customers", id));
                            showSuccessAlert("Dihapus!", `Customer ${name} telah berhasil dihapus.`);
                        } catch (error) {
                            console.error("Error deleting customer: ", error);
                            showErrorAlert("Gagal Menghapus", "Gagal menghapus customer.");
                        }
                    }
                }
            );
        };

        window.editCustomer = (id) => {
            cancelCustomerEdit();
            const row = document.querySelector(`#customerTable tr[data-id="${id}"]`);
            if (!row) return;

            const nameCell = row.querySelector('td[data-field="name"]');
            const currentName = nameCell.textContent;
            nameCell.innerHTML = `<input type="text" class="w-full p-2 border border-slate-300 rounded-lg" value="${currentName}">`;

            const typeCell = row.querySelector('td[data-field="customer_type"]');
            const currentType = typeCell.textContent.trim();
            typeCell.innerHTML = `<select class="w-full p-2 border border-slate-300 rounded-lg">
                                    <option value="BU17" ${currentType === 'BU17' ? 'selected' : ''}>BU17</option>
                                    <option value="CMI" ${currentType === 'CMI' ? 'selected' : ''}>CMI</option>
                                  </select>`;

            const actionCell = row.querySelector('.action-buttons');
            actionCell.innerHTML = `
                <button class="save p-2 text-xs text-white bg-green-600 rounded-lg" onclick="window.saveCustomer('${id}')"><i class="fas fa-check"></i></button>
                <button class="cancel p-2 text-xs text-white bg-gray-500 rounded-lg" onclick="window.cancelCustomerEdit()"><i class="fas fa-times"></i></button>
            `;
        };
        
        window.saveCustomer = async (id) => {
        const row = document.querySelector(`#customerTable tr[data-id="${id}"]`);
        if (!row) return;

        const input = row.querySelector('td[data-field="name"] input');
        const newName = input.value.trim();
        const typeSelect = row.querySelector('td[data-field="customer_type"] select');
        const newType = typeSelect.value;

        if (!newName) {
            showErrorAlert("Input Tidak Lengkap", "Nama customer tidak boleh kosong.");
            return;
        }
        try {
            await updateDoc(doc(db, "customers", id), { name: newName, customer_type: newType });
            showSuccessAlert("Berhasil", `Nama customer berhasil diubah.`);
        } catch (error) {
            console.error("Error updating customer: ", error);
            showErrorAlert("Gagal Menyimpan", "Gagal menyimpan perubahan.");
        }
    };

        window.cancelCustomerEdit = () => {
            renderCustomerTable();
        };
        
        window.filterCustomerTable = function() {
            const searchTerm = document.getElementById('customerSearchInput').value.toLowerCase();
            paginationState.masterCustomer.filteredData = window.customersData.filter(c => c.name.toLowerCase().includes(searchTerm));
            paginationState.masterCustomer.currentPage = 1;
            renderCustomerTable();
        }

        function renderJenisTruckTable() {
            const tableBody = document.getElementById('jenisTruckTable').querySelector('tbody');
            tableBody.innerHTML = '';

            const { currentPage, filteredData } = paginationState.masterJenisTruck;

            if (filteredData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="2" class="text-center p-8 text-slate-500">Belum ada data jenis truck.</td></tr>`;
                renderPagination('jenisTruckTablePagination', 'masterJenisTruck', renderJenisTruckTable);
                return;
            }

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedData = filteredData.slice(start, end);

            paginatedData.forEach(jenis => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-slate-50';
                row.setAttribute('data-id', jenis.id);
                row.innerHTML = `
                    <td data-field="name" class="px-6 py-4 font-medium">${jenis.name}</td>
                    <td class="px-6 py-4 action-buttons flex items-center gap-2">
                        <button class="edit p-2 text-xs text-white bg-amber-500 rounded-lg hover:bg-amber-600" title="Edit" onclick="window.editJenisTruck('${jenis.id}')"><i class="fas fa-pencil-alt"></i></button>
                        <button class="delete p-2 text-xs text-white bg-red-600 rounded-lg hover:bg-red-700" title="Hapus" onclick="window.deleteJenisTruck('${jenis.id}', '${jenis.name}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            renderPagination('jenisTruckTablePagination', 'masterJenisTruck', renderJenisTruckTable);
        }

        window.toggleAddJenisTruckForm = (forceClose = false) => {
            const form = document.getElementById('addJenisTruckForm');
            const isHidden = form.classList.contains('hidden');
            if (forceClose || !isHidden) {
                form.classList.add('hidden');
            } else {
                form.reset();
                form.classList.remove('hidden');
            }
        };

        window.addJenisTruck = async () => {
            const jenisTruckNameInput = document.getElementById('newJenisTruckName');
            const jenisTruckName = jenisTruckNameInput.value.trim().toUpperCase();
            if (!jenisTruckName) {
                showErrorAlert("Input Tidak Lengkap", "Nama jenis truck tidak boleh kosong.");
                return;
            }
            try {
                await addDoc(collection(db, "jenis_truck"), { name: jenisTruckName });
                toggleAddJenisTruckForm(true);
                showSuccessAlert("Berhasil", `Jenis truck ${jenisTruckName} berhasil ditambahkan.`);
            } catch (error) {
                console.error("Error adding jenis truck: ", error);
                showErrorAlert("Gagal Menambahkan", "Gagal menambahkan jenis truck baru.");
            }
        };

        window.deleteJenisTruck = async (id, name) => {
            showConfirmAlert(
                "Konfirmasi Hapus",
                `Yakin ingin menghapus jenis truck "${name}"?`,
                "Ya, Hapus!",
                async (isConfirmed) => {
                    if (isConfirmed) {
                        try {
                            await deleteDoc(doc(db, "jenis_truck", id));
                            showSuccessAlert("Dihapus!", `Jenis truck ${name} telah berhasil dihapus.`);
                        } catch (error) {
                            console.error("Error deleting jenis truck: ", error);
                            showErrorAlert("Gagal Menghapus", "Gagal menghapus jenis truck.");
                        }
                    }
                }
            );
        };

        window.editJenisTruck = (id) => {
            cancelJenisTruckEdit();
            const row = document.querySelector(`#jenisTruckTable tr[data-id="${id}"]`);
            if (!row) return;
            const nameCell = row.querySelector('td[data-field="name"]');
            const currentName = nameCell.textContent;
            nameCell.innerHTML = `<input type="text" class="w-full p-2 border border-slate-300 rounded-lg" value="${currentName}">`;
            const actionCell = row.querySelector('.action-buttons');
            actionCell.innerHTML = `
                <button class="save p-2 text-xs text-white bg-green-600 rounded-lg" onclick="window.saveJenisTruck('${id}')"><i class="fas fa-check"></i></button>
                <button class="cancel p-2 text-xs text-white bg-gray-500 rounded-lg" onclick="window.cancelJenisTruckEdit()"><i class="fas fa-times"></i></button>
            `;
        };
        
        window.saveJenisTruck = async (id) => {
            const row = document.querySelector(`#jenisTruckTable tr[data-id="${id}"]`);
            if (!row) return;
            const input = row.querySelector('td[data-field="name"] input');
            const newName = input.value.trim().toUpperCase();
            if (!newName) {
                showErrorAlert("Input Tidak Lengkap", "Nama jenis truck tidak boleh kosong.");
                return;
            }
            try {
                await updateDoc(doc(db, "jenis_truck", id), { name: newName });
                showSuccessAlert("Berhasil", `Nama jenis truck berhasil diubah.`);
            } catch (error) {
                console.error("Error updating jenis truck: ", error);
                showErrorAlert("Gagal Menyimpan", "Gagal menyimpan perubahan.");
            }
        };

        window.cancelJenisTruckEdit = () => {
            renderJenisTruckTable();
        };
        
        window.filterJenisTruckTable = function() {
            const searchTerm = document.getElementById('jenisTruckSearchInput').value.toLowerCase();
            paginationState.masterJenisTruck.filteredData = window.jenisTruckData.filter(j => j.name.toLowerCase().includes(searchTerm));
            paginationState.masterJenisTruck.currentPage = 1;
            renderJenisTruckTable();
        }

        let currentFilterColumn = null;

        function closeFilterPopup() {
            const popup = document.getElementById('header-filter-popup');
            if (popup) popup.classList.add('hidden');
        }

        window.openFilterPopup = (event, column) => {
            event.stopPropagation();
            const popup = document.getElementById('header-filter-popup');
            const filterOptions = document.getElementById('filter-options');
            const searchInput = document.getElementById('filter-search');

            if (currentFilterColumn === column && !popup.classList.contains('hidden')) {
                closeFilterPopup();
                return;
            }
            
            currentFilterColumn = column;
            const uniqueValues = [...new Set(window.allRitaseData.map(item => item[column]))].filter(Boolean).sort();
            
            filterOptions.innerHTML = '';
            uniqueValues.forEach(value => {
                const isChecked = activeFilters[column] && activeFilters[column].includes(String(value));
                const itemHtml = `<label class="filter-item flex items-center"><input type="checkbox" value="${value}" ${isChecked ? 'checked' : ''} class="mr-2 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><span>${value}</span></label>`;
                filterOptions.innerHTML += itemHtml;
            });

            searchInput.value = '';
            searchInput.onkeyup = () => {
                const term = searchInput.value.toLowerCase();
                document.querySelectorAll('#filter-options .filter-item').forEach(item => {
                    const text = item.querySelector('span').textContent.toLowerCase();
                    item.style.display = text.includes(term) ? 'flex' : 'none';
                });
            };
            
            document.getElementById('apply-filter-btn').onclick = applyHeaderFilters;
            document.getElementById('clear-filter-btn').onclick = clearHeaderFilters;

            const headerRect = event.currentTarget.getBoundingClientRect();
            popup.style.left = `${headerRect.left}px`;
            popup.style.top = `${headerRect.bottom + window.scrollY}px`;
            popup.classList.remove('hidden');
        }

        function applyHeaderFilters() {
            if (!currentFilterColumn) return;
            const selectedValues = [];
            document.querySelectorAll('#filter-options input[type="checkbox"]:checked').forEach(checkbox => {
                selectedValues.push(checkbox.value);
            });
            
            if (selectedValues.length > 0) {
                activeFilters[currentFilterColumn] = selectedValues;
            } else {
                delete activeFilters[currentFilterColumn];
            }
            applyRitaseFiltersAndSort();
            closeFilterPopup();
        }

        function clearHeaderFilters() {
            if (!currentFilterColumn) return;
            delete activeFilters[currentFilterColumn];
            applyRitaseFiltersAndSort();
            closeFilterPopup();
        }

        // --- GANTI FUNGSI INI SEPENUHNYA ---
        function displayRitaseTable() {
            const tableBody = document.getElementById('ritaseTableBody');
            tableBody.innerHTML = '';

            const { currentPage, filteredData } = paginationState.ritaseTruck;
            
            if (!filteredData || filteredData.length === 0) {
                // Colspan 14 sesuai jumlah kolom
                tableBody.innerHTML = `<tr><td colspan="14" class="text-center p-8 text-slate-500">Tidak ada data ritase yang cocok.</td></tr>`;
                renderPagination('ritaseTablePagination', 'ritaseTruck', displayRitaseTable);
                return;
            }

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedData = filteredData.slice(start, end);

            // Helper format tanggal jam tabel
            const fmt = (isoStr) => {
                if (!isoStr) return '-';
                return formatTanggalJam(isoStr);
            };

            paginatedData.forEach(data => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-slate-50';
                
                // Format tanggal selesai
                const formattedDate = data.timestamp_selesai?.toDate 
                    ? data.timestamp_selesai.toDate().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta', dateStyle: 'long', timeStyle: 'short'}) + ' WIB' 
                    : '-';

                // --- INI PERBAIKAN UTAMANYA: HITUNG ULANG LAMA INAP ---
                // Menggunakan helper calculateDurationBetween yang baru dibuat di atas
                const lamaInap = calculateDurationBetween(data.keluar_lokasi_muat, data.keluar_lokasi_bongkar);

                // Fallback Jenis Truck
                let jenisTruckDisplay = data.jenis_mobil;
                if (!jenisTruckDisplay) {
                    const relatedTruck = window.trucksData.find(t => t.no_mobil === data.plat_nomor);
                    jenisTruckDisplay = relatedTruck ? relatedTruck.jenis_mobil : '-';
                }

                row.innerHTML = `
                    <td class="px-6 py-4">${data.angkutanName || '-'}</td>
                    <td class="px-6 py-4 font-medium">${data.plat_nomor || '-'}</td>
                    <td class="px-6 py-4">${jenisTruckDisplay}</td>
                    <td class="px-6 py-4">${data.nama_driver || '-'}</td>
                    <td class="px-6 py-4">${data.customer || '-'}</td>
                    <td class="px-6 py-4">${data.tujuan || '-'}</td>
                    
                    <td class="px-6 py-4 whitespace-nowrap text-xs">${fmt(data.tiba_lokasi_muat)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs">${fmt(data.keluar_lokasi_muat)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs">${fmt(data.tiba_lokasi_bongkar)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs">${fmt(data.keluar_lokasi_bongkar)}</td>

                    <td class="px-6 py-4">${formattedDate}</td>
                    
                    <td class="px-6 py-4 font-semibold text-indigo-600 whitespace-nowrap">${lamaInap}</td>
                    
                    <td class="px-6 py-4">${data.fo || '-'}</td>
                    
                    <td class="px-6 py-4 whitespace-nowrap flex gap-2">
                        <button onclick="window.openRitaseModal('edit', '${data.docId}')" class="bg-amber-500 text-white p-2 rounded hover:bg-amber-600" title="Edit">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button onclick="window.deleteRitaseData('${data.docId}')" class="bg-red-600 text-white p-2 rounded hover:bg-red-700" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            renderPagination('ritaseTablePagination', 'ritaseTruck', displayRitaseTable);
        }

    // --- GANTI FUNGSI exportRitaseToExcel YANG LAMA DENGAN INI ---
    window.exportRitaseToExcel = () => {
        // 1. AMBIL DATA DARI STATE
        const dataToExport = paginationState.ritaseTruck.filteredData;

        if (!dataToExport || dataToExport.length === 0) {
            Swal.fire('Info', 'Tidak ada data untuk diexport', 'info');
            return;
        }

        // --- DEFINISI HEADER KOLOM (Update: Tambah "Jenis Truck") ---
        const headers = [
            "Angkutan", 
            "Plat Nomor", 
            "Jenis Truck", // <--- KOLOM BARU
            "Nama Driver", 
            "Customer", 
            "Kota", 
            "Tiba Muat", 
            "Keluar Muat", 
            "Tiba Bongkar", 
            "Keluar Bongkar", 
            "Tanggal Selesai", 
            "Lama Inap",   
            "FO"
        ];

        // Helper: Format Tanggal
        const fmt = (isoStr) => isoStr ? formatTanggalJam(isoStr) : '-';

        // Helper: Hitung Durasi
        const hitungDurasi = (startStr, endStr) => {
            if (!startStr || !endStr) return '-';
            const start = new Date(startStr);
            const end = new Date(endStr);
            let diff = end - start; 
            if (isNaN(diff) || diff < 0) return '-';

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            diff -= days * (1000 * 60 * 60 * 24);
            const hours = Math.floor(diff / (1000 * 60 * 60));
            diff -= hours * (1000 * 60 * 60);
            const minutes = Math.floor(diff / (1000 * 60));

            let parts = [];
            if (days > 0) parts.push(`${days} Hari`);
            if (hours > 0) parts.push(`${hours} Jam`);
            if (minutes > 0) parts.push(`${minutes} Mnt`);
            return parts.length > 0 ? parts.join(' ') : '0 Mnt';
        };
        
        // 2. MAPPING DATA KE BARIS EXCEL
        const body = dataToExport.map(item => {
            const tglSelesai = item.timestamp_selesai?.toDate 
                ? item.timestamp_selesai.toDate().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' }) 
                : '-';
            
            const duration = hitungDurasi(item.keluar_lokasi_muat, item.keluar_lokasi_bongkar);

            // LOGIKA BARU: Ambil Jenis Truck (Fallback ke master jika di history kosong)
            let jenisTruck = item.jenis_mobil;
            if (!jenisTruck) {
                const truckRef = window.trucksData.find(t => t.no_mobil === item.plat_nomor);
                jenisTruck = truckRef ? truckRef.jenis_mobil : '-';
            }
                
            return [
                item.angkutanName || '-',
                item.plat_nomor || '-',
                jenisTruck, // <--- ISI DATA JENIS TRUCK
                item.nama_driver || '-',
                item.customer || '-',
                item.tujuan || '-',
                fmt(item.tiba_lokasi_muat),
                fmt(item.keluar_lokasi_muat),
                fmt(item.tiba_lokasi_bongkar),
                fmt(item.keluar_lokasi_bongkar),
                tglSelesai,
                duration,
                item.fo || '-'
            ];
        });

        // 3. GABUNGKAN HEADER DAN BODY
        const wsData = [headers, ...body];
        const worksheet = XLSX.utils.aoa_to_sheet(wsData);
        
        // 4. STYLING HEADER
        if (worksheet['!ref']) {
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const address = XLSX.utils.encode_col(C) + "1";
                if (!worksheet[address]) continue;
                worksheet[address].s = { 
                    font: { bold: true }, 
                    fill: { fgColor: { rgb: "CCCCCC" } },
                    alignment: { horizontal: "center" }
                };
            }
        }

        // 5. ATUR LEBAR KOLOM
        const colWidths = headers.map(h => ({ wch: h.length + 5 }));
        colWidths[11] = { wch: 25 }; // Lebar khusus untuk Lama Inap (Index geser jadi 11)
        worksheet['!cols'] = colWidths;

        // 6. GENERATE FILE
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Laporan Ritase");
        
        const startDate = document.getElementById('ritaseStartDate').value || 'All';
        const endDate = document.getElementById('ritaseEndDate').value || 'All';
        const filename = `Laporan_Ritase_${startDate}_sd_${endDate}.xlsx`;
        
        XLSX.writeFile(workbook, filename);
    };

    // --- GANTI FUNGSI exportRitaseToPdf YANG LAMA DENGAN INI ---
    window.exportRitaseToPdf = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape' });
        
        // 1. Ambil Data
        const dataToExport = paginationState.ritaseTruck.filteredData;

        if (!dataToExport || dataToExport.length === 0) {
            Swal.fire('Info', 'Tidak ada data untuk diexport', 'info');
            return;
        }

        // Setup Judul & Tanggal
        const timestamp = new Date().toLocaleString('id-ID');
        const startDate = document.getElementById('ritaseStartDate').value;
        const endDate = document.getElementById('ritaseEndDate').value;
        let subtitle = `Diekspor pada: ${timestamp}`;
        if(startDate && endDate) {
            subtitle += ` | Filter Tanggal: ${startDate} s/d ${endDate}`;
        }

        doc.setFontSize(14);
        doc.text("Laporan Ritase Truck", 14, 15);
        doc.setFontSize(10);
        doc.setTextColor(100);
        doc.text(subtitle, 14, 22);

        // 2. Definisi Header (Update: Tambah "Jenis")
        const head = [[
            "Angkutan", "Plat", "Jenis", "Driver", "Customer", "Kota", 
            "Tiba Muat", "Keluar Muat", "Tiba Bongkar", "Keluar Bongkar", 
            "Tgl Selesai", "Lama Inap", "FO"
        ]];

        // Helper Format
        const fmt = (isoStr) => {
            if(!isoStr) return '-';
            const d = new Date(isoStr);
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const hh = String(d.getHours()).padStart(2, '0');
            const min = String(d.getMinutes()).padStart(2, '0');
            return `${dd}/${mm} ${hh}:${min}`;
        };

        const hitungDurasi = (startStr, endStr) => {
            if (!startStr || !endStr) return '-';
            const start = new Date(startStr);
            const end = new Date(endStr);
            let diff = end - start;
            if (isNaN(diff) || diff < 0) return '-';

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            diff -= days * (1000 * 60 * 60 * 24);
            const hours = Math.floor(diff / (1000 * 60 * 60));
            diff -= hours * (1000 * 60 * 60);
            const minutes = Math.floor(diff / (1000 * 60));

            let parts = [];
            if (days > 0) parts.push(`${days}h`);
            if (hours > 0) parts.push(`${hours}j`);
            if (minutes > 0) parts.push(`${minutes}m`);
            return parts.length > 0 ? parts.join(' ') : '0m';
        };

        // 3. Mapping Data Body
        const body = dataToExport.map(item => {
            const tglSelesai = item.timestamp_selesai?.toDate 
                ? item.timestamp_selesai.toDate().toLocaleString('id-ID', { 
                    day: '2-digit', month: '2-digit', year: '2-digit', 
                    hour: '2-digit', minute: '2-digit' 
                }) 
                : '-';

            const duration = hitungDurasi(item.keluar_lokasi_muat, item.keluar_lokasi_bongkar);

            // Logic Fallback Jenis Truck
            let jenisTruck = item.jenis_mobil;
            if (!jenisTruck) {
                const truckRef = window.trucksData.find(t => t.no_mobil === item.plat_nomor);
                jenisTruck = truckRef ? truckRef.jenis_mobil : '-';
            }

            return [
                item.angkutanName || '-',
                item.plat_nomor || '-',
                jenisTruck, // <--- KOLOM BARU
                item.nama_driver || '-',
                item.customer || '-',
                item.tujuan || '-',
                fmt(item.tiba_lokasi_muat),
                fmt(item.keluar_lokasi_muat),
                fmt(item.tiba_lokasi_bongkar),
                fmt(item.keluar_lokasi_bongkar),
                tglSelesai,
                duration,
                item.fo || '-'
            ];
        });

        // 4. Generate Tabel PDF
        doc.autoTable({
            head: head,
            body: body,
            startY: 28,
            theme: 'grid',
            headStyles: { 
                fillColor: [79, 70, 229], 
                textColor: 255,
                fontSize: 7,
                halign: 'center',
                valign: 'middle'
            },
            styles: { 
                fontSize: 5.5, // Sedikit diperkecil agar muat kolom tambahan
                cellPadding: 1,
                overflow: 'linebreak',
                halign: 'center',
                valign: 'middle'
            },
            columnStyles: {
                0: { cellWidth: 20, halign: 'left' }, // Angkutan
                1: { cellWidth: 15 }, // Plat
                2: { cellWidth: 15 }, // Jenis (BARU)
                3: { cellWidth: 15, halign: 'left' }, // Driver
                4: { cellWidth: 20, halign: 'left' }, // Customer
                
                // Indeks bergeser +1 karena ada kolom Jenis
                11: { cellWidth: 18, fontStyle: 'bold', textColor: [20, 20, 20] }, // Lama Inap (sebelumnya 10)
                12: { cellWidth: 18 } // FO (sebelumnya 11)
            }
        });

        const filename = `Laporan_Ritase_${startDate || 'All'}_${endDate || 'All'}.pdf`;
        doc.save(filename);
    };
        
    window.applyRitaseFiltersAndSort = function() {
        // 1. Ambil semua data awal
        let filtered = [...window.allRitaseData];

        // --- FILTER 1: TANGGAL ---
        const startDateString = document.getElementById('ritaseStartDate').value;
        const endDateString = document.getElementById('ritaseEndDate').value;

        if (startDateString || endDateString) {
            const startDate = startDateString ? new Date(startDateString) : null;
            const endDate = endDateString ? new Date(endDateString) : null;

            if(startDate) startDate.setHours(0, 0, 0, 0);
            if(endDate) endDate.setHours(23, 59, 59, 999);

            filtered = filtered.filter(item => {
                if (!item.timestamp_selesai || !item.timestamp_selesai.toDate) return false;
                const itemDate = item.timestamp_selesai.toDate();
                
                if (startDate && itemDate < startDate) return false;
                if (endDate && itemDate > endDate) return false;
                return true;
            });
        }

        // --- FILTER 2: SEARCH INPUT (BARU) ---
        const searchInput = document.getElementById('ritaseSearchInput');
        if (searchInput) {
            const searchTerm = searchInput.value.toLowerCase().trim();
            if (searchTerm) {
                filtered = filtered.filter(item => {
                    // Siapkan data untuk dicari (termasuk fallback jenis truck)
                    let jenisTruck = item.jenis_mobil || '';
                    if (!jenisTruck && item.plat_nomor) {
                        const truckRef = window.trucksData.find(t => t.no_mobil === item.plat_nomor);
                        if (truckRef) jenisTruck = truckRef.jenis_mobil;
                    }

                    // Gabungkan semua field yang relevan menjadi satu string panjang untuk dicek
                    const searchString = `
                        ${item.angkutanName || ''} 
                        ${item.plat_nomor || ''} 
                        ${jenisTruck || ''}
                        ${item.nama_driver || ''} 
                        ${item.customer || ''} 
                        ${item.tujuan || ''} 
                        ${item.fo || ''}
                    `.toLowerCase();

                    return searchString.includes(searchTerm);
                });
            }
        }

        // --- FILTER 3: HEADER CHECKBOXES (Yg di klik di judul kolom) ---
        for (const column in activeFilters) {
            if (activeFilters[column] && activeFilters[column].length > 0) {
                filtered = filtered.filter(item => {
                    // Khusus untuk filter jenis_mobil, kita perlu cek fallback-nya juga
                    let val = String(item[column] || '');
                    
                    if (column === 'jenis_mobil' && val === '') {
                        const truckRef = window.trucksData.find(t => t.no_mobil === item.plat_nomor);
                        if (truckRef) val = truckRef.jenis_mobil;
                    }
                    
                    return activeFilters[column].includes(val);
                });
            }
        }
        
        // --- SORTING ---
        filtered.sort((a, b) => {
            const valA = a[ritaseSort.column];
            const valB = b[ritaseSort.column];
            if (ritaseSort.column === 'timestamp_selesai') {
                const timeA = valA?.toMillis() || 0;
                const timeB = valB?.toMillis() || 0;
                return ritaseSort.direction === 'asc' ? timeA - timeB : timeB - timeA;
            }
            const comparison = String(valA || '').localeCompare(String(valB || ''), undefined, { numeric: true });
            return ritaseSort.direction === 'asc' ? comparison : -comparison;
        });

        // Update state dan render ulang
        paginationState.ritaseTruck.filteredData = filtered;
        paginationState.ritaseTruck.currentPage = 1;
        displayRitaseTable();
    };
        
        window.sortRitaseTable = (column) => {
            if (ritaseSort.column === column) {
                ritaseSort.direction = ritaseSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                ritaseSort.column = column;
                ritaseSort.direction = 'asc';
            }
            applyRitaseFiltersAndSort();
        };
        
        window.handleHeaderClick = (event, column) => {
            if (event.shiftKey) {
                sortRitaseTable(column);
            } else {
                openFilterPopup(event, column);
            }
        };

        function updateRealTimeClock() {
            const clockElement = document.getElementById('export-timestamp');
            const summaryInapTitle = document.getElementById('summary-inap-title');

            const now = new Date();
            
            if (clockElement) {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
                clockElement.textContent = now.toLocaleString('id-ID', options);
            }

            if (summaryInapTitle && document.getElementById('laporanInap').classList.contains('active')) {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const dateString = now.toLocaleDateString('id-ID', options).toUpperCase();
                const timeString = now.toLocaleTimeString('id-ID', { hour12: false }).replace(/\./g, ':');
                summaryInapTitle.textContent = `SUMMARY INAP PER CUSTOMER & KOTA - ${dateString} pkl ${timeString}`;
            }
        }

        function getFormattedTimestamp() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short' };
            return now.toLocaleString('id-ID', options);
        }

        function getFilenameTimestamp() {
            const now = new Date();
            const YYYY = now.getFullYear();
            const MM = String(now.getMonth() + 1).padStart(2, '0');
            const DD = String(now.getDate()).padStart(2, '0');
            const HH = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            return `${YYYY}-${MM}-${DD}_${HH}-${mm}`;
        }
        
        window.exportToExcel = () => {
            const selectedAngkutanSelect = document.getElementById('summaryFilterAngkutan');
            const angkutanName = selectedAngkutanSelect.value === 'all' ? 'Semua_Angkutan' : selectedAngkutanSelect.value.replace(/ /g, '_');
            const selectedStatus = document.getElementById('summaryFilterStatus').value;
            
            const isCombinedMode = selectedStatus === 'ANTRI BONGKAR + INAP';
            const showLeadTimeColumn = isCombinedMode || selectedStatus.startsWith('INAP');

            let filteredData = [...window.trucksData];
            if (selectedAngkutanSelect.value !== 'all') { filteredData = filteredData.filter(t => t.angkutan === selectedAngkutanSelect.value); }
            const selectedJenisMobil = document.getElementById('summaryFilterJenisMobil').value;
            if (selectedJenisMobil !== 'all') { filteredData = filteredData.filter(t => t.jenis_mobil === selectedJenisMobil); }
            
            if (selectedStatus === 'INAP BU17') {
                filteredData = filteredData.filter(t => t.keterangan === 'INAP' && getDynamicStatus(t) === 'INAP BU17');
            } else if (selectedStatus === 'INAP CMI') {
                filteredData = filteredData.filter(t => t.keterangan === 'INAP' && getDynamicStatus(t) === 'INAP CMI');
            } else if (selectedStatus === 'INAP (Lainnya)') {
                filteredData = filteredData.filter(t => t.keterangan === 'INAP' && getDynamicStatus(t) === 'INAP (Lainnya)');
            } else if (isCombinedMode) { // 'ANTRI BONGKAR + INAP'
                filteredData = filteredData.filter(t => t.keterangan === 'ANTRI BONGKAR' || t.keterangan === 'INAP');
            } else if (selectedStatus !== 'all') {
                filteredData = filteredData.filter(t => t.keterangan === selectedStatus);
            }

            if (showLeadTimeColumn) {
                filteredData.sort((a, b) => {
                    const statusPriority = { 'INAP BU17': 1, 'INAP CMI': 1, 'INAP (Lainnya)': 1, 'ANTRI BONGKAR': 2 };
                    const statusA = statusPriority[getDynamicStatus(a)] || 3;
                    const statusB = statusPriority[getDynamicStatus(b)] || 3;
                    const statusComp = statusA - statusB;
                    if (statusComp !== 0) return statusComp;

                    const leadTimeA = calculateLeadTimeInMinutes(a.tiba_lokasi_bongkar);
                    const leadTimeB = calculateLeadTimeInMinutes(b.tiba_lokasi_bongkar);
                    return leadTimeB - leadTimeA;
                });
            }

            const header1 = ["No", "ANGKUTAN", "FO/DN", "LOKASI MUAT", null, "LOKASI BONGKAR", null, "NAMA CUSTOMER", "KOTA", "STATUS", "NAMA DRIVER", "NO HP", "PLAT NOMOR", "JENIS TRUCK"];
            if (showLeadTimeColumn) header1.push("LEAD TIME");
            const header2 = [null, null, null, "TIBA", "KELUAR", "TIBA", "KELUAR", null, null, null, null, null, null, null];
            if (showLeadTimeColumn) header2.push(null);
            
            const body = filteredData.map((truck, index) => {
                const row = [
                index + 1, truck.angkutan || '-', truck.fo || '-',
                formatTanggalJam(truck.tiba_lokasi_muat), formatTanggalJam(truck.keluar_lokasi_muat),
                formatTanggalJam(truck.tiba_lokasi_bongkar), formatTanggalJam(truck.keluar_lokasi_bongkar),
                truck.customer || '-', truck.tujuan || '-', getDynamicStatus(truck) || '-',
                truck.nama_driver || '-', truck.no_hp || '-', truck.no_mobil || '-', truck.jenis_mobil || '-'
                ];
                if (showLeadTimeColumn) {
                    row.push(calculateLeadTime(truck.tiba_lokasi_bongkar));
                }
                return row;
            });

            const dataToExport = [header1, header2, ...body];
            const worksheet = XLSX.utils.aoa_to_sheet(dataToExport);
            
            const merges = [
                { s: { r: 0, c: 3 }, e: { r: 0, c: 4 } }, { s: { r: 0, c: 5 }, e: { r: 0, c: 6 } },
                { s: { r: 0, c: 0 }, e: { r: 1, c: 0 } }, { s: { r: 0, c: 1 }, e: { r: 1, c: 1 } }, 
                { s: { r: 0, c: 2 }, e: { r: 1, c: 2 } }, { s: { r: 0, c: 7 }, e: { r: 1, c: 7 } }, 
                { s: { r: 0, c: 8 }, e: { r: 1, c: 8 } }, { s: { r: 0, c: 9 }, e: { r: 1, c: 9 } }, 
                { s: { r: 0, c: 10 }, e: { r: 1, c: 10 } }, { s: { r: 0, c: 11 }, e: { r: 1, c: 11 } }, 
                { s: { r: 0, c: 12 }, e: { r: 1, c: 12 } }, { s: { r: 0, c: 13 }, e: { r: 1, c: 13 } }
            ];
            if (showLeadTimeColumn) merges.push({ s: { r: 0, c: 14 }, e: { r: 1, c: 14 } });
            worksheet['!merges'] = merges;
            
            // [PERBAIKAN] Ganti warna "D9D9D9" menjadi "4F46E5" (biru) dan tambahkan warna font putih
            const headerStyle = { 
                font: { bold: true, color: { rgb: "FFFFFF" } }, 
                fill: { fgColor: { rgb: "4F46E5" } }, 
                alignment: { horizontal: "center", vertical: "center" } 
            };

            if (showLeadTimeColumn) {
                // Style header
                header1.forEach((_, colIndex) => {
                    const address1 = XLSX.utils.encode_cell({ r: 0, c: colIndex });
                    const address2 = XLSX.utils.encode_cell({ r: 1, c: colIndex });
                    if(worksheet[address1]) worksheet[address1].s = headerStyle;
                    if(worksheet[address2]) worksheet[address2].s = headerStyle;
                });

                filteredData.forEach((truck, index) => {
                    // ... (sisa kode pewarnaan baris tetap sama)
                    const leadTimeDays = calculateLeadTimeInDays(truck.tiba_lokasi_bongkar);
                    let rowColor = "";

                    if (leadTimeDays < 3) rowColor = "C6EFCE"; // Green
                    else if (leadTimeDays <= 6) rowColor = "BDD7EE"; // Blue
                    else if (leadTimeDays <= 9) rowColor = "FFEB9C"; // Yellow
                    else rowColor = "FFC7CE"; // Red

                    if (rowColor) {
                        const style = { fill: { fgColor: { rgb: rowColor } } };
                        const rowIndex = index + 2;
                        for (let C = 0; C < header1.length; C++) {
                            const address = XLSX.utils.encode_cell({ r: rowIndex, c: C });
                            if (!worksheet[address]) worksheet[address] = {};
                            worksheet[address].s = style;
                        }
                    }
                });
            } else {
                 // [PERBAIKAN] Terapkan style biru HANYA jika tidak dalam mode INAP
                header1.forEach((_, colIndex) => {
                    const address1 = XLSX.utils.encode_cell({ r: 0, c: colIndex });
                    const address2 = XLSX.utils.encode_cell({ r: 1, c: colIndex });
                    if(worksheet[address1]) worksheet[address1].s = headerStyle;
                    if(worksheet[address2]) worksheet[address2].s = headerStyle;
                });
            }

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Summary Status Truck");
            const filename = `Summary_Status_Truck_${angkutanName}_${getFilenameTimestamp()}.xlsx`;
            XLSX.writeFile(workbook, filename);
        };

        window.exportToPdf = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });
            const timestamp = getFormattedTimestamp();
            const selectedAngkutanSelect = document.getElementById('summaryFilterAngkutan');
            const angkutanName = selectedAngkutanSelect.options[selectedAngkutanSelect.selectedIndex].text;
            const title = `Summary Status Truck - ${angkutanName}`;
            
            const selectedStatus = document.getElementById('summaryFilterStatus').value;
            const isCombinedMode = selectedStatus === 'ANTRI BONGKAR + INAP';
            const showLeadTimeColumn = isCombinedMode || selectedStatus.startsWith('INAP');

            let filteredData = [...window.trucksData];
            if (selectedAngkutanSelect.value !== 'all') { filteredData = filteredData.filter(t => t.angkutan === selectedAngkutanSelect.value); }
            const selectedJenisMobil = document.getElementById('summaryFilterJenisMobil').value;
            if (selectedJenisMobil !== 'all') { filteredData = filteredData.filter(t => t.jenis_mobil === selectedJenisMobil); }

            if (selectedStatus === 'INAP BU17') {
            filteredData = filteredData.filter(t => t.keterangan === 'INAP' && getDynamicStatus(t) === 'INAP BU17');
            } else if (selectedStatus === 'INAP CMI') {
                filteredData = filteredData.filter(t => t.keterangan === 'INAP' && getDynamicStatus(t) === 'INAP CMI');
            } else if (selectedStatus === 'INAP (Lainnya)') {
                filteredData = filteredData.filter(t => t.keterangan === 'INAP' && getDynamicStatus(t) === 'INAP (Lainnya)');
            } else if (isCombinedMode) { // 'ANTRI BONGKAR + INAP'
                filteredData = filteredData.filter(t => t.keterangan === 'ANTRI BONGKAR' || t.keterangan === 'INAP');
            } else if (selectedStatus !== 'all') {
                filteredData = filteredData.filter(t => t.keterangan === selectedStatus);
            }

            if (showLeadTimeColumn) {
                 filteredData.sort((a, b) => {
                    const statusPriority = { 'INAP BU17': 1, 'INAP CMI': 1, 'INAP (Lainnya)': 1, 'ANTRI BONGKAR': 2 };
                    const statusA = statusPriority[getDynamicStatus(a)] || 3;
                    const statusB = statusPriority[getDynamicStatus(b)] || 3;
                    const statusComp = statusA - statusB;
                    if (statusComp !== 0) return statusComp;

                    const customerComp = (a.customer || '').localeCompare(b.customer || '');
                    if (customerComp !== 0) return customerComp;

                    const cityComp = (a.tujuan || '').localeCompare(b.tujuan || '');
                    if (cityComp !== 0) return cityComp;
                    
                    const leadTimeA = calculateLeadTimeInMinutes(a.tiba_lokasi_bongkar);
                    const leadTimeB = calculateLeadTimeInMinutes(b.tiba_lokasi_bongkar);
                    return leadTimeB - leadTimeA;
                });
            }

            const head = [[
                { content: 'No', rowSpan: 2 }, { content: 'ANGKUTAN', rowSpan: 2 }, { content: 'FO', rowSpan: 2 },
                { content: 'LOKASI MUAT', colSpan: 2 }, { content: 'LOKASI BONGKAR', colSpan: 2 },
                { content: 'NAMA CUSTOMER', rowSpan: 2 }, { content: 'KOTA', rowSpan: 2 }, { content: 'STATUS', rowSpan: 2 },
                { content: 'NAMA DRIVER', rowSpan: 2 }, { content: 'NO HP', rowSpan: 2 }, { content: 'PLAT NOMOR', rowSpan: 2 }, { content: 'JENIS TRUCK', rowSpan: 2 },
            ], [ 'TIBA', 'KELUAR', 'TIBA', 'KELUAR' ]];
            if (showLeadTimeColumn) head[0].push({ content: 'LEAD TIME', rowSpan: 2 });

            const body = filteredData.map((truck, index) => {
            const row = [
                index + 1,
                truck.angkutan || '-', truck.fo || '-',
                formatTanggalJam(truck.tiba_lokasi_muat), formatTanggalJam(truck.keluar_lokasi_muat),
                formatTanggalJam(truck.tiba_lokasi_bongkar), formatTanggalJam(truck.keluar_lokasi_bongkar),
                truck.customer || '-', truck.tujuan || '-', getDynamicStatus(truck) || '-',
                truck.nama_driver || '-', truck.no_hp || '-', truck.no_mobil || '-', truck.jenis_mobil || '-'
            ];
                if (showLeadTimeColumn) {
                    row.push(calculateLeadTime(truck.tiba_lokasi_bongkar));
                }
                return row;
            });
            
            // [PERBAIKAN] Ganti `fillColor` abu-abu [217, 217, 217] menjadi biru [79, 70, 229] dan hapus `textColor: [0, 0, 0]`
            const blueHeaderStyle = { fillColor: [79, 70, 229], textColor: [255, 255, 255], halign: 'center', valign: 'middle' };
            
            const headStyles = showLeadTimeColumn ? blueHeaderStyle : blueHeaderStyle;
            const styles = showLeadTimeColumn ? { fontSize: 6, cellPadding: 1.5, halign: 'center', valign: 'middle' } : { fontSize: 6, cellPadding: 1.5 };

            doc.autoTable({
                head: head, body: body, startY: 28, theme: 'grid',
                headStyles: headStyles,
                styles: styles,
                didDrawPage: (data) => {
                    doc.setFontSize(10);
                    doc.setTextColor(150);
                    doc.text('Page ' + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });
            const filename = `Summary_Status_Truck_${angkutanName.replace(/ /g, '_')}_${getFilenameTimestamp()}.pdf`;
            doc.save(filename);
        };
        
        window.exportAsImage = async () => {
            const selectedAngkutanSelect = document.getElementById('summaryFilterAngkutan');
            const angkutanName = selectedAngkutanSelect.options[selectedAngkutanSelect.selectedIndex].text;
            const cleanAngkutanName = angkutanName.replace(/ /g, '_');
            const selectedStatus = document.getElementById('summaryFilterStatus').value;
            
            const isCombinedMode = selectedStatus === 'ANTRI BONGKAR + INAP';
            const showLeadTimeColumn = isCombinedMode || selectedStatus.startsWith('INAP');

            let filteredData = [...window.trucksData];
            if (selectedAngkutanSelect.value !== 'all') { filteredData = filteredData.filter(t => t.angkutan === selectedAngkutanSelect.value); }
            const selectedJenisMobil = document.getElementById('summaryFilterJenisMobil').value;
            if (selectedJenisMobil !== 'all') { filteredData = filteredData.filter(t => t.jenis_mobil === selectedJenisMobil); }
            
            if (selectedStatus === 'INAP BU17') {
                filteredData = filteredData.filter(t => t.keterangan === 'INAP' && getDynamicStatus(t) === 'INAP BU17');
            } else if (selectedStatus === 'INAP CMI') {
                filteredData = filteredData.filter(t => t.keterangan === 'INAP' && getDynamicStatus(t) === 'INAP CMI');
            } else if (selectedStatus === 'INAP (Lainnya)') {
                filteredData = filteredData.filter(t => t.keterangan === 'INAP' && getDynamicStatus(t) === 'INAP (Lainnya)');
            } else if (isCombinedMode) { // 'ANTRI BONGKAR + INAP'
                filteredData = filteredData.filter(t => t.keterangan === 'ANTRI BONGKAR' || t.keterangan === 'INAP');
            } else if (selectedStatus !== 'all') {
                filteredData = filteredData.filter(t => t.keterangan === selectedStatus);
            }

            if (showLeadTimeColumn) {
                 filteredData.sort((a, b) => {
                    const statusPriority = { 'INAP BU17': 1, 'INAP CMI': 1, 'INAP (Lainnya)': 1, 'ANTRI BONGKAR': 2 };
                    const statusA = statusPriority[getDynamicStatus(a)] || 3;
                    const statusB = statusPriority[getDynamicStatus(b)] || 3;
                    const statusComp = statusA - statusB;
                    if (statusComp !== 0) return statusComp;

                    const customerComp = (a.customer || '').localeCompare(b.customer || '');
                    if (customerComp !== 0) return customerComp;

                    const cityComp = (a.tujuan || '').localeCompare(b.tujuan || '');
                    if (cityComp !== 0) return cityComp;
                    
                    const leadTimeA = calculateLeadTimeInMinutes(a.tiba_lokasi_bongkar);
                    const leadTimeB = calculateLeadTimeInMinutes(b.tiba_lokasi_bongkar);
                    return leadTimeB - leadTimeA;
                });
            }

            const screenshotContainer = document.createElement('div');
            screenshotContainer.style.position = 'absolute';
            screenshotContainer.style.left = '-9999px';
            screenshotContainer.style.top = '0';
            screenshotContainer.style.padding = '1.5rem';
            screenshotContainer.style.backgroundColor = 'white';
            screenshotContainer.style.width = 'fit-content';
            
            screenshotContainer.innerHTML = `
                <div style="margin-bottom: 1rem; text-align: center;">
                    <h4 style="font-size: 1.25rem; font-weight: 700; color: #334155;">Summary Report - ${angkutanName}</h4>
                    <p style="font-size: 0.875rem; color: #64748b;">${document.getElementById('export-timestamp').textContent}</p>
                </div>
            `;

            const table = document.createElement('table');
            table.style.borderCollapse = 'collapse';
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');

            let headers = ["No", "Angkutan", "FO", "Tiba Lokasi Muat", "Keluar Lokasi Muat", "Tiba Lokasi Bongkar", "Keluar Lokasi Bongkar", "Nama Customer", "Kota", "Status", "Nama Driver", "No HP", "Plat Nomor", "Jenis Truck"];
            if (showLeadTimeColumn) headers.push("Lead Time");
            
            const headerRow = document.createElement('tr');
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                th.style.border = '1px solid #ddd';
                th.style.padding = '8px';
                th.style.textAlign = 'center';
                th.style.verticalAlign = 'middle';
                
                // [PERBAIKAN] Ganti warna '#d9d9d9' menjadi '#4F46E5' dan tambahkan warna font
                th.style.backgroundColor = '#4F46E5';
                th.style.color = '#ffffff';

                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            
            filteredData.forEach((truck, index) => {
                const tr = document.createElement('tr');
                const rowData = [
                index + 1,
                truck.angkutan || '-', truck.fo || '-',
                formatTanggalJam(truck.tiba_lokasi_muat), formatTanggalJam(truck.keluar_lokasi_muat),
                formatTanggalJam(truck.tiba_lokasi_bongkar), formatTanggalJam(truck.keluar_lokasi_bongkar),
                truck.customer || '-', truck.tujuan || '-', getDynamicStatus(truck) || '-',
                truck.nama_driver || '-', truck.no_hp || '-', truck.no_mobil || '-', truck.jenis_mobil || '-'
                ];
                if (showLeadTimeColumn) {
                    rowData.push(calculateLeadTime(truck.tiba_lokasi_bongkar));
                }

                rowData.forEach(cellData => {
                    const td = document.createElement('td');
                    td.textContent = cellData;
                    td.style.border = '1px solid #ddd';
                    td.style.padding = '8px';
                    if (showLeadTimeColumn) {
                       td.style.textAlign = 'center';
                       td.style.verticalAlign = 'middle';
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            table.appendChild(thead);
            table.appendChild(tbody);
            screenshotContainer.appendChild(table);
            document.body.appendChild(screenshotContainer);

            try {
                const canvas = await html2canvas(screenshotContainer, { scale: 2, useCORS: true });
                const link = document.createElement('a');
                link.download = `Summary_Report_${cleanAngkutanName}_${getFilenameTimestamp()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            } catch (error) {
                console.error("Gagal membuat gambar:", error);
                showErrorAlert("Gagal Membuat Gambar", "Terjadi kesalahan saat membuat gambar laporan.");
            } finally {
                document.body.removeChild(screenshotContainer);
            }
        };

        // ==========================================
    // FUNGSI EXPORT BARU (DATA LENGKAP)
    // ==========================================

        window.exportRitaseToExcel = () => {
        // 1. AMBIL DATA DARI STATE (Bukan dari tabel HTML)
        const dataToExport = paginationState.ritaseTruck.filteredData;

        if (!dataToExport || dataToExport.length === 0) {
            Swal.fire('Info', 'Tidak ada data untuk diexport', 'info');
            return;
        }

        // --- DEFINISI HEADER KOLOM (Pastikan "Lama Inap" ada di sini) ---
        const headers = [
            "Angkutan", 
            "Plat Nomor", 
            "Nama Driver", 
            "Customer", 
            "Kota", 
            "Tiba Muat", 
            "Keluar Muat", 
            "Tiba Bongkar", 
            "Keluar Bongkar", 
            "Tanggal Selesai", 
            "Lama Inap",   // <--- INI KOLOM YANG SEBELUMNYA HILANG
            "FO"
        ];

        // Helper: Format Tanggal
        const fmt = (isoStr) => isoStr ? formatTanggalJam(isoStr) : '-';

        // Helper Internal: Hitung Durasi (Langsung di sini agar aman)
        const hitungDurasi = (startStr, endStr) => {
            if (!startStr || !endStr) return '-';
            const start = new Date(startStr);
            const end = new Date(endStr);
            let diff = end - start; 
            if (isNaN(diff) || diff < 0) return '-';

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            diff -= days * (1000 * 60 * 60 * 24);
            const hours = Math.floor(diff / (1000 * 60 * 60));
            diff -= hours * (1000 * 60 * 60);
            const minutes = Math.floor(diff / (1000 * 60));

            let parts = [];
            if (days > 0) parts.push(`${days} Hari`);
            if (hours > 0) parts.push(`${hours} Jam`);
            if (minutes > 0) parts.push(`${minutes} Mnt`);
            return parts.length > 0 ? parts.join(' ') : '0 Mnt';
        };
        
        // 2. MAPPING DATA KE BARIS EXCEL
        const body = dataToExport.map(item => {
            const tglSelesai = item.timestamp_selesai?.toDate 
                ? item.timestamp_selesai.toDate().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' }) 
                : '-';
            
            // HITUNG LAMA INAP (Keluar Bongkar - Keluar Muat)
            const duration = hitungDurasi(item.keluar_lokasi_muat, item.keluar_lokasi_bongkar);
                
            return [
                item.angkutanName || '-',
                item.plat_nomor || '-',
                item.nama_driver || '-',
                item.customer || '-',
                item.tujuan || '-',
                fmt(item.tiba_lokasi_muat),
                fmt(item.keluar_lokasi_muat),
                fmt(item.tiba_lokasi_bongkar),
                fmt(item.keluar_lokasi_bongkar),
                tglSelesai,
                duration, // <--- DATA DURASI DIMASUKKAN KE SINI (Kolom ke-11)
                item.fo || '-'
            ];
        });

        // 3. GABUNGKAN HEADER DAN BODY
        const wsData = [headers, ...body];
        const worksheet = XLSX.utils.aoa_to_sheet(wsData);
        
        // 4. STYLING HEADER (BOLD & WARNA)
        if (worksheet['!ref']) {
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const address = XLSX.utils.encode_col(C) + "1";
                if (!worksheet[address]) continue;
                worksheet[address].s = { 
                    font: { bold: true }, 
                    fill: { fgColor: { rgb: "CCCCCC" } },
                    alignment: { horizontal: "center" }
                };
            }
        }

        // 5. ATUR LEBAR KOLOM (Agar "Lama Inap" terbaca jelas)
        const colWidths = headers.map(h => ({ wch: h.length + 5 }));
        colWidths[10] = { wch: 25 }; // Lebar khusus untuk kolom Lama Inap
        worksheet['!cols'] = colWidths;

        // 6. GENERATE FILE
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Laporan Ritase");
        
        const startDate = document.getElementById('ritaseStartDate').value || 'All';
        const endDate = document.getElementById('ritaseEndDate').value || 'All';
        const filename = `Laporan_Ritase_${startDate}_sd_${endDate}.xlsx`;
        
        XLSX.writeFile(workbook, filename);
    };

    window.exportRitaseToPdf = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'landscape' });
    
    // 1. Ambil Data dari State
    const dataToExport = paginationState.ritaseTruck.filteredData;

    if (!dataToExport || dataToExport.length === 0) {
        Swal.fire('Info', 'Tidak ada data untuk diexport', 'info');
        return;
    }

    // Setup Judul & Tanggal
    const timestamp = new Date().toLocaleString('id-ID');
    const startDate = document.getElementById('ritaseStartDate').value;
    const endDate = document.getElementById('ritaseEndDate').value;
    let subtitle = `Diekspor pada: ${timestamp}`;
    if(startDate && endDate) {
        subtitle += ` | Filter Tanggal: ${startDate} s/d ${endDate}`;
    }

    doc.setFontSize(14);
    doc.text("Laporan Ritase Truck", 14, 15);
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text(subtitle, 14, 22);

    // 2. Definisi Header (Termasuk Lama Inap)
    const head = [[
        "Angkutan", "Plat", "Driver", "Customer", "Kota", 
        "Tiba Muat", "Keluar Muat", "Tiba Bongkar", "Keluar Bongkar", 
        "Tgl Selesai", "Lama Inap", "FO"
    ]];

    // Helper: Format Tanggal Singkat (DD/MM HH:mm) agar hemat tempat
    const fmt = (isoStr) => {
        if(!isoStr) return '-';
        const d = new Date(isoStr);
        // Format manual agar pendek
        const dd = String(d.getDate()).padStart(2, '0');
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const hh = String(d.getHours()).padStart(2, '0');
        const min = String(d.getMinutes()).padStart(2, '0');
        return `${dd}/${mm} ${hh}:${min}`;
    };

    // Helper: Hitung Durasi (Singkat)
    const hitungDurasi = (startStr, endStr) => {
        if (!startStr || !endStr) return '-';
        const start = new Date(startStr);
        const end = new Date(endStr);
        let diff = end - start;
        if (isNaN(diff) || diff < 0) return '-';

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        diff -= days * (1000 * 60 * 60 * 24);
        const hours = Math.floor(diff / (1000 * 60 * 60));
        diff -= hours * (1000 * 60 * 60);
        const minutes = Math.floor(diff / (1000 * 60));

        let parts = [];
        if (days > 0) parts.push(`${days}h`); // h = Hari
        if (hours > 0) parts.push(`${hours}j`); // j = Jam
        if (minutes > 0) parts.push(`${minutes}m`); // m = Menit
        return parts.length > 0 ? parts.join(' ') : '0m';
    };

    // 3. Mapping Data Body
    const body = dataToExport.map(item => {
         const tglSelesai = item.timestamp_selesai?.toDate 
            ? item.timestamp_selesai.toDate().toLocaleString('id-ID', { 
                day: '2-digit', month: '2-digit', year: '2-digit', 
                hour: '2-digit', minute: '2-digit' 
              }) 
            : '-';

        // Hitung durasi
        const duration = hitungDurasi(item.keluar_lokasi_muat, item.keluar_lokasi_bongkar);

        return [
            item.angkutanName || '-',
            item.plat_nomor || '-',
            item.nama_driver || '-',
            item.customer || '-',
            item.tujuan || '-',
            fmt(item.tiba_lokasi_muat),
            fmt(item.keluar_lokasi_muat),
            fmt(item.tiba_lokasi_bongkar),
            fmt(item.keluar_lokasi_bongkar),
            tglSelesai,
            duration, // <--- Masukkan Data Lama Inap
            item.fo || '-'
        ];
    });

    // 4. Generate Tabel PDF
    doc.autoTable({
        head: head,
        body: body,
        startY: 28,
        theme: 'grid',
        headStyles: { 
            fillColor: [79, 70, 229], 
            textColor: 255,
            fontSize: 7,
            halign: 'center',
            valign: 'middle'
        },
        styles: { 
            fontSize: 6, // Font kecil agar semua kolom muat
            cellPadding: 1,
            overflow: 'linebreak',
            halign: 'center',
            valign: 'middle'
        },
        columnStyles: {
            0: { cellWidth: 20, halign: 'left' }, // Angkutan
            1: { cellWidth: 15 }, // Plat
            2: { cellWidth: 15, halign: 'left' }, // Driver
            3: { cellWidth: 20, halign: 'left' }, // Customer
            // Kolom Lama Inap diberi style khusus agar terlihat
            10: { cellWidth: 18, fontStyle: 'bold', textColor: [20, 20, 20] }, 
            11: { cellWidth: 18 } // FO
        }
    });

    const filename = `Laporan_Ritase_${startDate || 'All'}_${endDate || 'All'}.pdf`;
    doc.save(filename);
};
        
        window.exportInapTableAsImage = async (tableId, defaultTitle) => {
            const tableToExport = document.getElementById(tableId);

            if (!tableToExport || tableToExport.tagName !== 'TABLE') {
                showErrorAlert("Gagal", `Elemen tabel dengan ID '${tableId}' tidak ditemukan.`);
                return;
            }

            // [PERBAIKAN] Ubah nama variabel agar lebih jelas
            let titleHtml = defaultTitle;

            const headerContainer = tableToExport.closest('.bg-white.p-6')?.querySelector('.flex.justify-between');
            if (headerContainer) {
                const h4Element = headerContainer.querySelector('h4');
                if (h4Element) {
                    // [PERBAIKAN] Ambil .innerHTML (yang berisi style) BUKAN .innerText
                    titleHtml = h4Element.innerHTML;
                }
            }
            
            const filenamePrefix = defaultTitle.replace(/[\s:<>|/]/g, '_').replace(/_+/g, '_');

            const screenshotContainer = document.createElement('div');
            screenshotContainer.style.position = 'absolute';
            screenshotContainer.style.left = '-9999px';
            screenshotContainer.style.top = '0';
            screenshotContainer.style.padding = '1.5rem';
            screenshotContainer.style.backgroundColor = 'white';
            screenshotContainer.style.width = 'fit-content';
            screenshotContainer.style.border = '1px solid #e2e8f0';
            screenshotContainer.style.fontFamily = "'Inter', sans-serif";
            
            // [PERBAIKAN] Masukkan titleHtml (yang berisi HTML) ke dalam H4
            screenshotContainer.innerHTML = `<div style="margin-bottom: 1rem; display: flex; justify-content: center;"><h4 style="font-size: 1.125rem; font-weight: 700; color: #1e293b;">${titleHtml}</h4></div>`;

            const tableClone = tableToExport.cloneNode(true);
            screenshotContainer.appendChild(tableClone);
            document.body.appendChild(screenshotContainer);

            try {
                const canvas = await html2canvas(screenshotContainer, { scale: 2, useCORS: true });
                const link = document.createElement('a');
                link.download = `${filenamePrefix}_${getFilenameTimestamp()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            } catch (error) {
                console.error("Gagal membuat gambar:", error);
                showErrorAlert("Gagal Membuat Gambar", "Terjadi kesalahan saat membuat gambar laporan.");
            } finally {
                document.body.removeChild(screenshotContainer);
            }
        };

        // STEP 5: Tambahkan Judul Halaman
        const pageTitles = { 
            home: 'Home', 
            realtimeMonitoring: 'Realtime Monitoring', 
            statusTruck: 'Status Truck', 
            listTruck: 'List Truck', 
            masterCustomer: 'Master Customer', 
            masterJenisTruck: 'Master Jenis Truck', 
            ritaseTruck: 'Laporan Ritase Truck', 
            summaryReport: 'Summary Report', 
            laporanInap: 'Summary Inap',
            // TAMBAHKAN BARIS INI:
            costAnalysis: 'Analisa Biaya & Keuangan' 
        };
        window.showContent = (contentId) => {
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(contentId).classList.add('active');
            document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
            document.getElementById(`nav-${contentId}`).classList.add('active');
            document.getElementById('page-title').textContent = pageTitles[contentId];
            
            if (contentId === 'listTruck') filterTable();
            if (contentId === 'masterCustomer') filterCustomerTable();
            if (contentId === 'masterJenisTruck') filterJenisTruckTable();
            if (contentId === 'ritaseTruck') applyRitaseFiltersAndSort();
            if (contentId === 'summaryReport') renderSummaryReport();
            if (contentId === 'statusTruck') displayStatusCards();
            if (contentId === 'laporanInap') renderLaporanInap();
            if (contentId === 'realtimeMonitoring') {
                initializeRealtimeMap();
                setTimeout(() => {
                    realtimeMap.invalidateSize();
                    window.updateTrucksOnRealtimeMap();
                }, 200);
            }
        }

/* =========================================
   STEP 4: LOGIKA COST ANALYSIS (LENGKAP)
   ========================================= */

// --- 1. TAB SWITCHING ---
window.switchCostTab = (tabId) => {
    document.querySelectorAll('.cost-tab-content').forEach(el => el.classList.add('hidden'));
    document.getElementById(tabId).classList.remove('hidden');
    
    document.querySelectorAll('.cost-tab-btn').forEach(el => {
        el.classList.remove('border-indigo-600', 'text-indigo-600', 'font-bold');
        el.classList.add('border-transparent', 'text-slate-500', 'font-medium');
    });
    
    const activeBtn = document.getElementById(`btn-${tabId}`);
    activeBtn.classList.remove('border-transparent', 'text-slate-500', 'font-medium');
    activeBtn.classList.add('border-indigo-600', 'text-indigo-600', 'font-bold');

    if(tabId === 'tab-master-fix') {
        populateFixCostDropdowns();
        renderFixCostTable();
    } else if(tabId === 'tab-master-var') {
        populateVarCostDropdowns();
        renderVarCostTable();
    }
};

// --- 2. LOGIKA FIX COST (SEWA BULANAN) ---
window.populateFixCostDropdowns = () => {
    const vendorSelect = document.getElementById('fixCostVendor');
    // Ambil vendor unik dari data truk yg sudah ada
    const uniqueVendors = [...new Set(window.trucksData.map(t => t.angkutan).filter(Boolean))].sort();
    
    vendorSelect.innerHTML = '<option value="">Pilih Vendor...</option>';
    uniqueVendors.forEach(v => vendorSelect.innerHTML += `<option value="${v}">${v}</option>`);
};

window.populatePlateForFixCost = () => {
    const vendor = document.getElementById('fixCostVendor').value;
    const plateSelect = document.getElementById('fixCostPlate');
    plateSelect.innerHTML = '<option value="">Pilih Plat...</option>';
    if(!vendor) return;
    
    const trucks = window.trucksData.filter(t => t.angkutan === vendor).sort((a,b) => a.no_mobil.localeCompare(b.no_mobil));
    trucks.forEach(t => plateSelect.innerHTML += `<option value="${t.no_mobil}">${t.no_mobil}</option>`);
};

window.saveFixCost = () => {
    const vendor = document.getElementById('fixCostVendor').value;
    const plate = document.getElementById('fixCostPlate').value;
    const cost = parseFloat(document.getElementById('fixCostValue').value);

    if(!vendor || !plate || !cost) {
        showErrorAlert("Data Kurang", "Mohon lengkapi semua field.");
        return;
    }

    const index = window.masterFixCost.findIndex(f => f.no_mobil === plate);
    
    // ID unik sederhana
    const newData = { 
        id: Date.now().toString(), 
        vendor, 
        no_mobil: plate, 
        cost 
    };

    if(index >= 0) {
        window.masterFixCost[index] = newData;
    } else {
        window.masterFixCost.push(newData);
    }

    localStorage.setItem('local_master_fix_cost', JSON.stringify(window.masterFixCost));
    
    showSuccessAlert("Berhasil", "Data Fix Cost tersimpan (Local).");
    renderFixCostTable();
};

/* ===========================================================
   TAMBAHKAN KODE BARU INI DI SINI (ANTARA SAVE DAN DELETE)
   =========================================================== */
window.autoGenerateFixCost = () => {
    // 1. Konfirmasi User
    if(!confirm("Fitur ini akan mengisi otomatis Fix Cost untuk SEMUA truk yang terdaftar berdasarkan harga kontrak vendor. Data lama yang cocok akan ditimpa. Lanjutkan?")) {
        return;
    }

    const allTrucks = window.trucksData;
    if(allTrucks.length === 0) {
        showErrorAlert("Data Kosong", "Belum ada data truk yang dimuat dari database. Pastikan internet lancar.");
        return;
    }

    // 2. Daftar Harga (Sesuai Request Anda)
    // Saya tambahkan variasi nama (singkatan) untuk jaga-jaga
    const priceList = {
        // SILOG: 25.8 Juta
        "PT. SEMEN INDONESIA LOGISTIK": 25800000,
        "SILOG": 25800000,

        // ALIEF: 26 Juta
        "PT. ALIEF SUKSES BERDIKARI": 26000000,
        "ALIEF": 26000000,

        // TNJ: 32 Juta
        "PT. TRANSPORTASI NUSANTARA JAYA": 32000000,
        "TNJ": 32000000,

        // SMJ: 26 Juta
        "CV. SINAR MAJU JAYA": 26000000,
        "PT. SINAR MAJU JAYA": 26000000,
        "SMJ": 26000000,

        // TFT: 26 Juta
        "PT. TIARA FAJAR TRANSPORTINDO": 26000000,
        "TFT": 26000000,

        // YUSHAR: 26 Juta
        "PT. YUSHAR PUTERA JAYA": 26000000,
        "YUSHAR": 26000000
    };

    let updatedCount = 0;

    // 3. Proses Loop
    allTrucks.forEach(truck => {
        const vendorName = truck.angkutan; 
        const platNomor = truck.no_mobil;
        
        // Cari harga berdasarkan nama vendor (case insensitive)
        const matchedKey = Object.keys(priceList).find(key => key.toUpperCase() === (vendorName || '').toUpperCase());

        if (matchedKey) {
            const harga = priceList[matchedKey];

            // Cek apakah data sudah ada di Master Fix Cost
            const index = window.masterFixCost.findIndex(f => f.no_mobil === platNomor);
            
            const newData = { 
                id: Date.now().toString() + Math.random().toString(36).substr(2, 5), 
                vendor: vendorName, 
                no_mobil: platNomor, 
                cost: harga 
            };

            if(index >= 0) {
                // Update data lama
                window.masterFixCost[index].cost = harga;
                window.masterFixCost[index].vendor = vendorName;
            } else {
                // Tambah data baru
                window.masterFixCost.push(newData);
            }
            updatedCount++;
        }
    });

    // 4. Simpan ke LocalStorage
    localStorage.setItem('local_master_fix_cost', JSON.stringify(window.masterFixCost));

    // 5. Tampilkan Hasil
    renderFixCostTable();
    showSuccessAlert("Selesai!", `Berhasil mengupdate biaya sewa untuk ${updatedCount} unit truk.`);
};
/* AKHIR KODE BARU */


window.deleteFixCost = (id) => {
    if(confirm("Hapus data fix cost ini?")) {
        window.masterFixCost = window.masterFixCost.filter(item => item.id !== id);
        localStorage.setItem('local_master_fix_cost', JSON.stringify(window.masterFixCost));
        renderFixCostTable();
    }
};

function renderFixCostTable() {
    const tbody = document.getElementById('fixCostTableBody');
    tbody.innerHTML = '';
    
    // Sortir data agar rapi (Vendor A-Z)
    const sortedData = [...window.masterFixCost].sort((a, b) => a.vendor.localeCompare(b.vendor));

    sortedData.forEach(item => {
        // LOGIKA BARU: Cari data truck di database utama berdasarkan Plat Nomor
        const truckData = window.trucksData.find(t => t.no_mobil === item.no_mobil);
        
        // Ambil jenis mobil, jika tidak ketemu (truk sudah dihapus/edit) beri tanda '-'
        const jenisTruck = truckData ? truckData.jenis_mobil : '-';

        tbody.innerHTML += `
            <tr class="border-b hover:bg-slate-50">
                <td class="px-6 py-3">${item.vendor}</td>
                <td class="px-6 py-3 font-bold">${item.no_mobil}</td>
                
                <td class="px-6 py-3 font-medium text-slate-600">${jenisTruck}</td>
                
                <td class="px-6 py-3">${formatRupiah(item.cost)} / bulan</td>
                <td class="px-6 py-3">
                    <button onclick="window.deleteFixCost('${item.id}')" class="text-red-600 hover:text-red-800" title="Hapus">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>`;
    });
}

// --- 3. LOGIKA VARIABLE COST (UANG JALAN) ---
window.populateVarCostDropdowns = () => {
    // Populate Vendor
    const vendorSelect = document.getElementById('varCostVendor');
    const uniqueVendors = [...new Set(window.trucksData.map(t => t.angkutan).filter(Boolean))].sort();
    vendorSelect.innerHTML = '<option value="">Pilih Vendor...</option>';
    uniqueVendors.forEach(v => vendorSelect.innerHTML += `<option value="${v}">${v}</option>`);

    // BARU: Populate Jenis Truck
    const jenisSelect = document.getElementById('varCostJenisTruck');
    if (jenisSelect) {
        jenisSelect.innerHTML = '<option value="">Pilih Jenis...</option>';
        // Menggunakan window.jenisTruckData yang sudah ada
        window.jenisTruckData.forEach(jenis => {
            jenisSelect.innerHTML += `<option value="${jenis.name}">${jenis.name}</option>`;
        });
    }
};

window.saveVarCost = () => {
    const vendor = document.getElementById('varCostVendor').value;
    const jenisTruck = document.getElementById('varCostJenisTruck').value; // BARU
    const origin = document.getElementById('varCostOrigin').value.toUpperCase().trim();
    const dest = document.getElementById('varCostDest').value.toUpperCase().trim();
    const cost = parseFloat(document.getElementById('varCostValue').value);

    // BARU: Validasi Jenis Truck
    if(!vendor || !jenisTruck || !origin || !dest || !cost) {
        showErrorAlert("Data Kurang", "Mohon lengkapi semua field, termasuk Jenis Truck.");
        return;
    }

    // Cek duplikat rute + jenis truck
    const index = window.masterVarCost.findIndex(v => 
        v.vendor === vendor && 
        v.jenis_truck === jenisTruck && // BARU
        v.origin === origin && 
        v.destination === dest
    );

    const newData = { 
        id: Date.now().toString(), 
        vendor, 
        jenis_truck: jenisTruck, // BARU
        origin, 
        destination: dest, 
        cost 
    };

    if(index >= 0) {
        window.masterVarCost[index] = newData;
    } else {
        window.masterVarCost.push(newData);
    }

    // Simpan ke Browser LocalStorage
    localStorage.setItem('local_master_var_cost', JSON.stringify(window.masterVarCost));

    showSuccessAlert("Berhasil", "Data Variable Cost tersimpan (Local).");
    renderVarCostTable();
};

window.deleteVarCost = (id) => {
    if(confirm("Hapus rute ini?")) {
        window.masterVarCost = window.masterVarCost.filter(item => item.id !== id);
        localStorage.setItem('local_master_var_cost', JSON.stringify(window.masterVarCost));
        renderVarCostTable();
    }
};

function renderVarCostTable() {
    const tbody = document.getElementById('varCostTableBody');
    tbody.innerHTML = '';
    // Sortir: Vendor -> Jenis Truck -> Origin
    const sorted = [...window.masterVarCost].sort((a,b) => 
        a.vendor.localeCompare(b.vendor) || 
        (a.jenis_truck || '').localeCompare(b.jenis_truck || '') || 
        a.origin.localeCompare(b.origin)
    );
    
    sorted.forEach(item => {
        tbody.innerHTML += `
            <tr class="border-b hover:bg-slate-50">
                <td class="px-6 py-3">${item.vendor}</td>
                <td class="px-6 py-3 font-medium text-slate-700">${item.jenis_truck || '-'}</td> <td class="px-6 py-3"><i class="fas fa-map-marker-alt text-green-500 mr-2"></i>${item.origin} &rarr; <i class="fas fa-flag-checkered text-red-500 mx-2"></i>${item.destination}</td>
                <td class="px-6 py-3 font-bold text-indigo-600">${formatRupiah(item.cost)}</td>
                <td class="px-6 py-3"><button onclick="window.deleteVarCost('${item.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button></td>
            </tr>`;
    });
}

    // Letakkan ini di bagian atas script, sebelum fungsi apapun
    window.vendorRates = {
        "PT. SEMEN INDONESIA LOGISTIK": 25800000,
        "SILOG": 25800000,
        "PT. ALIEF SUKSES BERDIKARI": 26000000,
        "ALIEF": 26000000,
        "PT. TRANSPORTASI NUSANTARA JAYA": 32000000,
        "TNJ": 32000000,
        "CV. SINAR MAJU JAYA": 26000000,
        "PT. SINAR MAJU JAYA": 26000000,
        "SMJ": 26000000,
        "PT. TIARA FAJAR TRANSPORTINDO": 26000000,
        "TFT": 26000000,
        "PT. YUSHAR PUTERA JAYA": 26000000,
        "YUSHAR": 26000000
    };

    // --- 4. LOGIKA LAPORAN KEUANGAN & EXPORT ---
    // Fungsi Utama: Generate Report
    // --- 1. FUNGSI UTAMA: GENERATE REPORT ---
    window.generateFinancialReport = async () => {
        const monthInput = document.getElementById('reportMonth').value; 
        if(!monthInput) {
            showErrorAlert("Pilih Periode", "Silakan pilih bulan laporan terlebih dahulu.");
            return;
        }

        // A. Reset Tampilan Tombol (Sembunyikan semua dulu)
        document.getElementById('btnCloseBook').classList.add('hidden');
        document.getElementById('btnReopenBook').classList.add('hidden');
        document.getElementById('lockStatus').classList.add('hidden');
        
        // B. Cek Firebase: Apakah bulan ini ada di koleksi 'financial_closings'?
        const closingRef = doc(db, "financial_closings", monthInput);
        const docSnap = await getDoc(closingRef);

        if (docSnap.exists()) {
            // --- SKENARIO SUDAH CLOSING (READ ONLY) ---
            const savedData = docSnap.data();
            
            // Render tabel dalam mode terkunci (true)
            renderFinancialTable(savedData.reportData, true); 
            
            // Tampilkan Status Terkunci
            const closedDate = savedData.closedAt ? savedData.closedAt.toDate().toLocaleDateString('id-ID') : '-';
            document.getElementById('lockStatus').classList.remove('hidden');
            document.getElementById('lockStatus').innerHTML = `<i class="fas fa-lock mr-2"></i> SUDAH CLOSING (${closedDate})`;
            
            // Tampilkan Tombol BUKA KEMBALI (RE-OPEN)
            document.getElementById('btnReopenBook').classList.remove('hidden');
            
            showSuccessAlert("Data Terkunci", "Menampilkan data hasil CLOSING.");
        } else {
            // --- SKENARIO BELUM CLOSING (REALTIME / EDITABLE) ---
            calculateRealtimeReport(monthInput);
            
            // Tampilkan Tombol CLOSING
            document.getElementById('btnCloseBook').classList.remove('hidden');
        }
    };

    // --- 2. FUNGSI HITUNG REALTIME (JIKA BELUM CLOSING) ---
    window.calculateRealtimeReport = (monthInput) => {
        const [year, month] = monthInput.split('-');

        // Filter Data Ritase (Variable Cost) berdasarkan bulan dipilih
        const filteredRitase = window.allRitaseData.filter(trip => {
            if(!trip.timestamp_selesai) return false;
            const tripDate = trip.timestamp_selesai.toDate();
            return tripDate.getFullYear() === parseInt(year) && (tripDate.getMonth() + 1) === parseInt(month);
        });

        let reportData = {};

        // A. Hitung Variable Cost (Uang Jalan) dari Ritase
        filteredRitase.forEach(trip => {
            const vendor = trip.angkutanName || 'Unknown';
            const plat = trip.plat_nomor || 'Unknown';
            const destCity = (trip.tujuan || '').toUpperCase();
            const originCity = 'KARAWANG'; 
            
            // Fallback jenis truck
            let truckType = trip.jenis_mobil;
            if (!truckType) {
                const truckInfo = window.trucksData.find(t => t.no_mobil === plat);
                truckType = truckInfo ? truckInfo.jenis_mobil : '';
            }

            if(!reportData[vendor]) reportData[vendor] = { totalTrucks: 0, trucksList: {}, totalFixCost: 0, totalVarCost: 0 };
            if(!reportData[vendor].trucksList[plat]) reportData[vendor].trucksList[plat] = { tripCount: 0, varCost: 0, fixCost: 0, active: false };

            // Cari harga uang jalan di master
            const routeCost = window.masterVarCost.find(vc => 
                vc.vendor === vendor && vc.origin === originCity && vc.destination === destCity && vc.jenis_truck === truckType 
            );

            const uangJalan = routeCost ? parseFloat(routeCost.cost) : 0;
            reportData[vendor].trucksList[plat].tripCount += 1;
            reportData[vendor].trucksList[plat].varCost += uangJalan;
            reportData[vendor].totalVarCost += uangJalan;
        });

        // B. Hitung Fix Cost (Snapshot Truk Saat Ini)
        const currentTrucksByVendor = window.trucksData.reduce((acc, truck) => {
            const v = truck.angkutan || 'Lainnya';
            if (!acc[v]) acc[v] = [];
            acc[v].push(truck);
            return acc;
        }, {});

        Object.keys(currentTrucksByVendor).forEach(vendorName => {
            const trucks = currentTrucksByVendor[vendorName];
            
            // Cari Rate Harga Sewa
            const matchedRateKey = Object.keys(window.vendorRates).find(k => k.toUpperCase() === vendorName.toUpperCase());
            const rate = matchedRateKey ? window.vendorRates[matchedRateKey] : 0;

            if(!reportData[vendorName]) reportData[vendorName] = { totalTrucks: 0, trucksList: {}, totalFixCost: 0, totalVarCost: 0 };

            // Default jumlah truk = jumlah saat ini
            reportData[vendorName].totalTrucks = trucks.length;
            reportData[vendorName].ratePerTruck = rate; // Simpan rate untuk perhitungan ulang nanti
            reportData[vendorName].totalFixCost = trucks.length * rate;

            trucks.forEach(t => {
                const plat = t.no_mobil;
                if(!reportData[vendorName].trucksList[plat]) reportData[vendorName].trucksList[plat] = { tripCount: 0, varCost: 0, fixCost: 0, active: true };
                else reportData[vendorName].trucksList[plat].active = true;
                reportData[vendorName].trucksList[plat].fixCost = rate;
            });
        });

        // Simpan data sementara di global variable (untuk proses save closing nanti)
        window.currentReportData = reportData;

        // Render tabel dalam mode edit (false)
        renderFinancialTable(reportData, false);
    };

// Fungsi kalkulasi dengan LOGGING EXTRA
window.calculateRealtimeReport = (monthInput) => {
    const [year, month] = monthInput.split('-');

    // Filter Data Ritase
    const filteredRitase = window.allRitaseData.filter(trip => {
        if(!trip.timestamp_selesai) return false;
        // Handle jika timestamp_selesai berupa string atau object Firestore
        const tripDate = trip.timestamp_selesai.toDate ? trip.timestamp_selesai.toDate() : new Date(trip.timestamp_selesai);
        return tripDate.getFullYear() === parseInt(year) && (tripDate.getMonth() + 1) === parseInt(month);
    });

    console.log(`4. Data Ritase bulan ${month}-${year}:`, filteredRitase.length, "transaksi found.");

    let reportData = {};

    // --- HITUNG VARIABLE COST ---
    filteredRitase.forEach(trip => {
        const vendor = trip.angkutanName || 'Unknown';
        const plat = trip.plat_nomor || 'Unknown';
        const destCity = (trip.tujuan || '').toUpperCase().trim();
        const originCity = 'KARAWANG'; 
        
        let truckType = trip.jenis_mobil;
        if (!truckType) {
            const truckInfo = window.trucksData.find(t => t.no_mobil === plat);
            truckType = truckInfo ? truckInfo.jenis_mobil : '';
        }

        if(!reportData[vendor]) reportData[vendor] = { totalTrucks: 0, trucksList: {}, totalFixCost: 0, totalVarCost: 0 };
        if(!reportData[vendor].trucksList[plat]) reportData[vendor].trucksList[plat] = { tripCount: 0, varCost: 0, fixCost: 0, active: false };

        // Cek Master Variable Cost
        if (!window.masterVarCost) window.masterVarCost = []; // Safety check
        const routeCost = window.masterVarCost.find(vc => 
            vc.vendor === vendor && 
            vc.origin === originCity && 
            vc.destination === destCity && 
            vc.jenis_truck === truckType 
        );

        if (!routeCost) {
            console.warn(`WARN: Master Variable Cost tidak ditemukan untuk: ${vendor} | ${originCity} -> ${destCity} (${truckType})`);
        }

        const uangJalan = routeCost ? parseFloat(routeCost.cost) : 0;
        reportData[vendor].trucksList[plat].tripCount += 1;
        reportData[vendor].trucksList[plat].varCost += uangJalan;
        reportData[vendor].totalVarCost += uangJalan;
    });

    // --- HITUNG FIX COST (SNAPSHOT) ---
    console.log("5. Menghitung Fix Cost (Snapshot Data Truk Saat Ini)...");
    
    const currentTrucksByVendor = window.trucksData.reduce((acc, truck) => {
        const v = truck.angkutan || 'Lainnya';
        if (!acc[v]) acc[v] = [];
        acc[v].push(truck);
        return acc;
    }, {});

    Object.keys(currentTrucksByVendor).forEach(vendorName => {
        const trucks = currentTrucksByVendor[vendorName];
        
        // DEBUGGING VENDOR RATE MATCHING
        const matchedRateKey = Object.keys(window.vendorRates).find(k => k.toUpperCase() === vendorName.toUpperCase());
        
        if (!matchedRateKey) {
            console.warn(`WARN: Harga Sewa (Rate) tidak ditemukan untuk vendor: "${vendorName}". Pastikan nama di Master Truck sama dengan di window.vendorRates.`);
        } else {
            console.log(`OK: Rate ditemukan untuk ${vendorName}: Rp ${window.vendorRates[matchedRateKey]}`);
        }

        const rate = matchedRateKey ? window.vendorRates[matchedRateKey] : 0;

        if(!reportData[vendorName]) reportData[vendorName] = { totalTrucks: 0, trucksList: {}, totalFixCost: 0, totalVarCost: 0 };

        reportData[vendorName].totalTrucks = trucks.length;
        reportData[vendorName].ratePerTruck = rate;
        reportData[vendorName].totalFixCost = trucks.length * rate;

        trucks.forEach(t => {
            const plat = t.no_mobil;
            if(!reportData[vendorName].trucksList[plat]) reportData[vendorName].trucksList[plat] = { tripCount: 0, varCost: 0, fixCost: 0, active: true };
            else reportData[vendorName].trucksList[plat].active = true;
            reportData[vendorName].trucksList[plat].fixCost = rate;
        });
    });

    console.log("6. Selesai kalkulasi. Rendering tabel...");
    window.currentReportData = reportData;
    renderFinancialTable(reportData, false);
};

// --- 3. FUNGSI RENDER TABEL ---
window.renderFinancialTable = (reportData, isLocked) => {
    const tbody = document.getElementById('financialReportBody');
    tbody.innerHTML = '';
    
    Object.keys(reportData).sort().forEach(vendor => {
        const dataVendor = reportData[vendor];
        const vendorEncoded = encodeURIComponent(vendor).replace(/'/g, "%27");
        
        // LOGIKA TAMPILAN INPUT VS TEKS BIASA
        const qtyDisplay = isLocked 
            ? `<span class="font-bold text-lg text-slate-800">${dataVendor.totalTrucks} Unit</span>`
            : `<div class="flex items-center gap-2">
                 <span class="text-xs font-normal text-slate-500">Jml Unit:</span>
                 <input type="number" id="qty-${vendorEncoded}" 
                    class="vendor-qty-input w-20 p-1 border border-indigo-300 rounded text-center font-bold text-indigo-800 focus:ring-2 focus:ring-indigo-500" 
                    value="${dataVendor.totalTrucks}" 
                    data-vendor="${vendorEncoded}"
                    onchange="window.recalculateVendorTotal('${vendorEncoded}')">
               </div>`;

        const noteDisplay = isLocked ? '' : `<td colspan="3" class="text-xs text-slate-500 italic text-right align-middle">*Edit unit sebelum CLOSING</td>`;

        // Render Baris Header Vendor
        tbody.innerHTML += `
            <tr class="bg-indigo-100 font-bold border-b border-indigo-200">
                <td class="px-6 py-2 text-indigo-900 flex items-center gap-2">
                    ${vendor}
                    <input type="hidden" id="rate-${vendorEncoded}" value="${dataVendor.ratePerTruck || 0}">
                    <input type="hidden" id="var-val-${vendorEncoded}" value="${dataVendor.totalVarCost}">
                </td>
                <td class="px-6 py-2">${qtyDisplay}</td>
                <td class="px-6 py-2 text-right text-indigo-900" id="subtotal-${vendorEncoded}">
                    ${formatRupiah(dataVendor.totalFixCost)}
                </td>
                ${noteDisplay}
            </tr>
        `;

        // Render Detail Truk
        Object.keys(dataVendor.trucksList).sort().forEach(plat => {
            const tData = dataVendor.trucksList[plat];
            // Jika locked, tampilkan fix cost yang tersimpan. Jika tidak, ambil dari master rate.
            const displayFixCost = tData.active ? (isLocked ? tData.fixCost : dataVendor.ratePerTruck) : 0; 
            
            tbody.innerHTML += `
                <tr class="border-b bg-white hover:bg-slate-50">
                    <td class="px-6 py-2 font-medium text-slate-400 pl-8">  ${vendor}</td>
                    <td class="px-6 py-2 font-bold text-slate-700 text-sm">${plat}</td>
                    <td class="px-6 py-2 text-right text-slate-400 text-xs italic">Included</td>
                    <td class="px-6 py-2 text-center text-sm">${tData.tripCount}</td>
                    <td class="px-6 py-2 text-right text-indigo-600 text-sm">${formatRupiah(tData.varCost)}</td>
                    <td class="px-6 py-2 text-right text-slate-400 text-xs">-</td>
                </tr>
            `;
        });

        // Render Subtotal Vendor
        tbody.innerHTML += `
            <tr class="bg-slate-50 font-bold border-b-2 border-slate-300">
                <td colspan="5" class="px-6 py-2 text-right text-slate-600">TOTAL TAGIHAN ${vendor}</td>
                <td class="px-6 py-2 text-right text-slate-800 text-lg" id="grand-total-cell-${vendorEncoded}">
                    ${formatRupiah(dataVendor.totalFixCost + dataVendor.totalVarCost)}
                </td>
            </tr>
        `;
    });

    calculateGrandTotalAll(); // Update kotak total di atas
    // --- TAMBAHKAN INI ---
    window.updateRitaseDashboard();
};

// --- 4. FUNGSI HITUNG ULANG SAAT EDIT MANUAL ---
// --- 4. HITUNG ULANG PER VENDOR (SAAT EDIT ANGKA) ---
window.recalculateVendorTotal = (vendorEncoded) => {
    const qtyInput = document.getElementById(`qty-${vendorEncoded}`);
    const rateInput = document.getElementById(`rate-${vendorEncoded}`);
    const subtotalCell = document.getElementById(`subtotal-${vendorEncoded}`);
    const grandTotalCell = document.getElementById(`grand-total-cell-${vendorEncoded}`);
    const varCostValue = parseFloat(document.getElementById(`var-val-${vendorEncoded}`).value) || 0;

    const newQty = parseInt(qtyInput.value) || 0;
    const rate = parseFloat(rateInput.value) || 0;
    
    // Hitung Fix Cost Baru
    const newFixCost = newQty * rate;
    
    // Hitung Total Tagihan Baru
    const newTotalVendor = newFixCost + varCostValue;

    // Update HTML
    subtotalCell.innerText = formatRupiah(newFixCost);
    if(grandTotalCell) grandTotalCell.innerText = formatRupiah(newTotalVendor);

    calculateGrandTotalAll();
    window.updateRitaseDashboard();
};

// --- 5. HITUNG GRAND TOTAL SEMUA (KOTAK WARNA-WARNI DI ATAS) ---
window.calculateGrandTotalAll = () => {
    let grandTotalFix = 0;
    let grandTotalVar = 0;

    // Cek apakah ada input edit (Mode Realtime)
    const inputs = document.querySelectorAll('.vendor-qty-input');
    
    if (inputs.length > 0) {
        // Jika mode edit, hitung dari nilai input
        inputs.forEach(input => {
            const vendorEncoded = input.getAttribute('data-vendor');
            const rate = parseFloat(document.getElementById(`rate-${vendorEncoded}`).value) || 0;
            const qty = parseInt(input.value) || 0;
            const varCost = parseFloat(document.getElementById(`var-val-${vendorEncoded}`).value) || 0;

            grandTotalFix += (qty * rate);
            grandTotalVar += varCost;
        });
    } else {
        // Jika mode locked (read-only), hitung dari teks di tabel (atau ambil dari window.currentReportData jika perlu)
        // Cara simpel: ambil dari variabel global window.currentReportData yang tersimpan/terload
        // Namun, jika sudah dirender, kita bisa membiarkan angka yang sudah ada. 
        // Agar akurat saat load closing, kita ambil dari data yang dirender.
        // *Opsional: Untuk simplifikasi, saat mode read-only biasanya angka di kotak atas sudah benar dari load awal.*
    }

    // Update Tampilan Kotak Atas
    const elFix = document.getElementById('rptTotalFix');
    const elVar = document.getElementById('rptTotalVar');
    const elGrand = document.getElementById('rptGrandTotal');

    if(elFix && inputs.length > 0) elFix.innerText = formatRupiah(grandTotalFix);
    if(elVar && inputs.length > 0) elVar.innerText = formatRupiah(grandTotalVar);
    if(elGrand && inputs.length > 0) elGrand.innerText = formatRupiah(grandTotalFix + grandTotalVar);
};

// --- 5. FUNGSI HITUNG GRAND TOTAL KESELURUHAN (KOTAK ATAS) ---
window.calculateGrandTotalAll = () => {
    let grandTotalFix = 0;
    let grandTotalVar = 0;

    // Loop semua input jumlah unit yang ada di tabel
    document.querySelectorAll('.vendor-qty-input').forEach(input => {
        const vendorEncoded = input.getAttribute('data-vendor');
        const rate = parseFloat(document.getElementById(`rate-${vendorEncoded}`).value) || 0;
        const qty = parseInt(input.value) || 0;
        const varCost = parseFloat(document.getElementById(`var-val-${vendorEncoded}`).value) || 0;

        grandTotalFix += (qty * rate);
        grandTotalVar += varCost;
    });

    // Jika mode locked (read-only), ambil dari total tabel biasa jika input tidak ada
    if(document.querySelectorAll('.vendor-qty-input').length === 0) {
        // Logic fallback sederhana jika read-only, atau biarkan di-handle oleh data snapshot
    }

    // Update Kotak Info di Atas
    const elFix = document.getElementById('rptTotalFix');
    const elVar = document.getElementById('rptTotalVar');
    const elGrand = document.getElementById('rptGrandTotal');

    if(elFix) elFix.innerText = formatRupiah(grandTotalFix);
    if(elVar) elVar.innerText = formatRupiah(grandTotalVar);
    if(elGrand) elGrand.innerText = formatRupiah(grandTotalFix + grandTotalVar);
};

    // 4. Fungsi Eksekusi CLOSING (Update Bahasa Alert)
    // --- 6. EKSEKUSI CLOSING (SIMPAN PERMANEN) ---
    window.closeBook = () => {
        const monthInput = document.getElementById('reportMonth').value;
        
        Swal.fire({
            title: 'Konfirmasi CLOSING',
            text: `Anda akan melakukan CLOSING untuk laporan bulan ${monthInput}. Data tidak bisa diedit lagi setelah ini. Pastikan jumlah unit sudah benar.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ya, Lakukan CLOSING!'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    // Ambil data report terakhir
                    let finalDataToSave = JSON.parse(JSON.stringify(window.currentReportData));
                    
                    // Update jumlah unit di data final sesuai inputan terakhir user
                    document.querySelectorAll('.vendor-qty-input').forEach(input => {
                        const vendorEncoded = input.getAttribute('data-vendor');
                        const vendorName = decodeURIComponent(vendorEncoded);
                        const finalQty = parseInt(input.value) || 0;
                        
                        if(finalDataToSave[vendorName]) {
                            finalDataToSave[vendorName].totalTrucks = finalQty;
                            // Hitung ulang total fix cost untuk disimpan
                            finalDataToSave[vendorName].totalFixCost = finalQty * (finalDataToSave[vendorName].ratePerTruck || 0);
                        }
                    });

                    // Simpan ke Firebase
                    await setDoc(doc(db, "financial_closings", monthInput), {
                        reportData: finalDataToSave,
                        closedAt: serverTimestamp(),
                        closedBy: currentUserData.name || 'Admin',
                        month: monthInput
                    });

                    Swal.fire('Berhasil!', 'Laporan telah di-CLOSING.', 'success');
                    
                    // Refresh agar masuk mode read-only
                    window.generateFinancialReport();

                } catch (error) {
                    console.error("Error closing:", error);
                    showErrorAlert("Gagal", "Terjadi kesalahan (Cek permission Firebase).");
                }
            }
        });
    };

    // --- 7. EKSEKUSI RE-OPEN (BUKA KEMBALI) ---
    window.reopenBook = () => {
        const monthInput = document.getElementById('reportMonth').value;
        
        Swal.fire({
            title: 'Buka Kembali Laporan?',
            text: `Status CLOSING bulan ${monthInput} akan dihapus. Data akan kembali menjadi Realtime dan bisa diedit.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Ya, Buka Kembali!',
            cancelButtonText: 'Batal'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    // Hapus dokumen closing
                    await deleteDoc(doc(db, "financial_closings", monthInput));
                    
                    Swal.fire('Berhasil!', 'Laporan dibuka kembali.', 'success');

                    // Refresh agar masuk mode edit
                    window.generateFinancialReport();

                } catch (error) {
                    console.error("Error reopen:", error);
                    showErrorAlert("Gagal", "Gagal membuka kembali (Cek permission Firebase).");
                }
            }
        });
    };

    window.exportFinancialExcel = () => {
        const table = document.getElementById("financialTable");
        if(!table) return;
        const wb = XLSX.utils.table_to_book(table, {sheet: "Laporan Keuangan"});
        const month = document.getElementById('reportMonth').value || 'All';
        XLSX.writeFile(wb, `Laporan_Keuangan_${month}.xlsx`);
    };

    // FUNGSI BARU: Ambil Data Ritase Sekali Saja (Hemat Kuota)
    window.loadRitaseData = async () => {
        try {
            // Tampilkan loading (opsional, agar user tahu proses berjalan)
            const tableBody = document.getElementById('ritaseTableBody');
            if (tableBody) {
                tableBody.innerHTML = `<tr><td colspan="14" class="text-center p-8 text-slate-500"><i class="fas fa-spinner fa-spin mr-2"></i>Mengambil data ritase...</td></tr>`;
            }

            // Ambil data menggunakan getDocs (Bukan onSnapshot)
            const q = query(collection(db, "completed_deliveries"), orderBy("timestamp_selesai", "desc"));
            const snapshot = await getDocs(q);

            // Simpan ke variabel global
            window.allRitaseData = snapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));

            // Refresh tampilan tabel jika sedang di halaman ritase
            if(document.getElementById('ritaseTruck').classList.contains('active')) {
                window.applyRitaseFiltersAndSort();
            }
            
            console.log(`Berhasil memuat ${window.allRitaseData.length} data ritase.`);

        } catch (error) {
            console.error("Gagal mengambil data ritase:", error);
            Swal.fire("Gagal", "Gagal memuat data ritase. Cek koneksi internet.", "error");
        }
    };
        
        document.addEventListener('DOMContentLoaded', () => {
            setInterval(updateRealTimeClock, 1000);
            document.getElementById('copyright-year-login-admin').textContent = new Date().getFullYear();

            // ===================================================================
            // INI KODE BARU YANG DITAMBAHKAN
            // ===================================================================
            const desktopSidebar = document.getElementById('sidebar');
            const desktopToggleBtn = document.getElementById('sidebar-toggle-btn');
            const sidebarStateKey = 'adminSidebarCollapsed'; // Key unik untuk admin

            if (desktopToggleBtn) {
                // 1. Cek status dari localStorage saat load
                if (localStorage.getItem(sidebarStateKey) === 'true') {
                    desktopSidebar.classList.add('sidebar-collapsed');
                }

                // 2. Tambah event listener untuk tombol
                desktopToggleBtn.addEventListener('click', () => {
                    desktopSidebar.classList.toggle('sidebar-collapsed');
                    const isCollapsed = desktopSidebar.classList.contains('sidebar-collapsed');
                    localStorage.setItem(sidebarStateKey, isCollapsed);
                    
                    // === TAMBAHKAN BARIS INI ===
                    // Panggil ulang renderHomePage untuk memperbarui nama vendor
                    renderHomePage(window.trucksData); 
                    // === BATAS TAMBAHAN ===

                    // Penting: Trigger map resize jika halaman map sedang aktif
                    if (document.getElementById('realtimeMonitoring').classList.contains('active') && typeof realtimeMap !== 'undefined' && realtimeMap) {
                        setTimeout(() => {
                            realtimeMap.invalidateSize();
                        }, 250); // Sesuaikan dengan durasi transisi CSS
                    }
                });
            }
            // ===================================================================
            // AKHIR DARI KODE BARU
            // ===================================================================
            
            document.getElementById('loginButton').addEventListener('click', () => signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value).catch(e => {
                document.getElementById('loginError').textContent = 'Email atau password salah.';
                showErrorAlert('Login Gagal', 'Email atau password salah.');
            }));
            
            document.getElementById('logoutButton').addEventListener('click', () => {
                showConfirmAlert(
                    "Konfirmasi Logout", 
                    "Apakah Anda yakin ingin keluar?", 
                    "Ya, Logout", 
                    (isConfirmed) => {
                        if (isConfirmed) {
                            signOut(auth);
                        }
                    }
                );
            });
            
            document.getElementById('copyright-year').textContent = new Date().getFullYear();
            
            document.getElementById('applyDateFilterBtn').addEventListener('click', applyRitaseFiltersAndSort);
            document.getElementById('resetDateFilterBtn').addEventListener('click', () => {
                document.getElementById('ritaseStartDate').value = '';
                document.getElementById('ritaseEndDate').value = '';
                applyRitaseFiltersAndSort();
            });

            document.getElementById('modalSearchInput').addEventListener('input', applyModalFiltersAndSort);
            document.getElementById('modalFilterAngkutan').addEventListener('change', applyModalFiltersAndSort);

            document.getElementById('gps-search-input').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('.gps-truck-item').forEach(item => {
                    const plate = item.getAttribute('data-plate').toLowerCase();
                    if (plate.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });

            document.addEventListener('click', (event) => {
                const popup = document.getElementById('header-filter-popup');
                if (!popup.classList.contains('hidden') && !popup.contains(event.target) && !event.target.closest('th[data-filter]')) {
                    closeFilterPopup();
                }
            });

            // Ini adalah kode LAMA Anda untuk sidebar mobile
            const sidebar = document.getElementById('sidebar');
            const openBtn = document.getElementById('sidebar-open-btn');
            const closeBtn = document.getElementById('sidebar-close-btn');
            const overlay = document.getElementById('sidebar-overlay');

            const openSidebar = () => {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            };

            const closeSidebar = () => {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            };

            openBtn.addEventListener('click', openSidebar);
            closeBtn.addEventListener('click', closeSidebar);
            overlay.addEventListener('click', closeSidebar);

            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth < 1024) {
                        closeSidebar();
                    }
                });
            });
        });


        // --- LOGIKA CRUD RITASE ---

        // 1. Buka Modal (Add atau Edit)
        // --- GANTI FUNGSI INI DI ADMIN.HTML ---
        window.openRitaseModal = (mode, docId = null) => {
            const modal = document.getElementById('ritase-form-modal');
            const form = document.getElementById('ritaseForm');
            const title = document.getElementById('ritase-modal-title');
            const idInput = document.getElementById('ritaseId');
            
            // Populate dropdown jenis truck
            const jenisSelect = document.getElementById('ritaseJenisTruck');
            jenisSelect.innerHTML = '<option value="">- Pilih -</option>';
            
            if (window.jenisTruckData) {
                window.jenisTruckData.forEach(j => {
                    jenisSelect.innerHTML += `<option value="${j.name}">${j.name}</option>`;
                });
            }

            if (mode === 'add') {
                title.textContent = "Tambah Data Ritase Manual";
                form.reset();
                idInput.value = "";
            } else if (mode === 'edit' && docId) {
                title.textContent = "Edit Data Ritase";
                const data = window.allRitaseData.find(d => d.docId === docId);
                if (!data) return;

                idInput.value = docId;
                document.getElementById('ritaseAngkutan').value = data.angkutanName || '';
                document.getElementById('ritasePlat').value = data.plat_nomor || '';

                // Logika Fallback Jenis Truck
                let selectedJenis = data.jenis_mobil;
                if (!selectedJenis && data.plat_nomor) {
                    const truckRef = window.trucksData.find(t => t.no_mobil === data.plat_nomor);
                    if (truckRef) {
                        selectedJenis = truckRef.jenis_mobil;
                    }
                }
                document.getElementById('ritaseJenisTruck').value = selectedJenis || '';

                document.getElementById('ritaseDriver').value = data.nama_driver || '';
                document.getElementById('ritaseCustomer').value = data.customer || '';
                document.getElementById('ritaseKota').value = data.tujuan || '';
                document.getElementById('ritaseFO').value = data.fo || '';

                // --- PERBAIKAN FORMAT TANGGAL ---
                // Fungsi helper ini memastikan tanggal terbaca dengan benar oleh input HTML
                const safeDateToInput = (val) => {
                    if (!val) return "";
                    let dateObj;
                    
                    // Cek tipe data (Firestore Timestamp vs String vs Date Object)
                    if (val.toDate) dateObj = val.toDate(); 
                    else if (typeof val === 'string') dateObj = new Date(val); 
                    else if (val instanceof Date) dateObj = val;

                    if (!dateObj || isNaN(dateObj)) return "";

                    // Konversi ke format YYYY-MM-DDTHH:mm (Waktu Lokal)
                    const offsetMs = dateObj.getTimezoneOffset() * 60 * 1000;
                    const localISOTime = (new Date(dateObj.getTime() - offsetMs)).toISOString().slice(0, 16);
                    return localISOTime;
                };

                // Isi input tanggal dengan format yang benar
                document.getElementById('ritaseTibaMuat').value = safeDateToInput(data.tiba_lokasi_muat);
                document.getElementById('ritaseKeluarMuat').value = safeDateToInput(data.keluar_lokasi_muat);
                document.getElementById('ritaseTibaBongkar').value = safeDateToInput(data.tiba_lokasi_bongkar);
                document.getElementById('ritaseKeluarBongkar').value = safeDateToInput(data.keluar_lokasi_bongkar);
                document.getElementById('ritaseSelesai').value = safeDateToInput(data.timestamp_selesai);
            }

            modal.classList.remove('hidden');
        };        

        // 2. Tutup Modal
        window.closeRitaseModal = () => {
            document.getElementById('ritase-form-modal').classList.add('hidden');
        };

        // 3. Simpan Data (Create / Update)
        window.saveRitaseData = async () => {
            // 1. Ambil ID
            const docId = document.getElementById('ritaseId').value;
            
            // 2. Ambil Value Input Waktu (Helper)
            // Jika kosong (""), ubah jadi null agar tidak error di Firestore
            const getValOrNull = (id) => {
                const val = document.getElementById(id).value;
                return val ? new Date(val) : null; 
            };

            // 3. Susun Data (Raw Data)
            const rawData = {
                angkutanName: document.getElementById('ritaseAngkutan').value,
                plat_nomor: document.getElementById('ritasePlat').value,
                jenis_mobil: document.getElementById('ritaseJenisTruck').value,
                nama_driver: document.getElementById('ritaseDriver').value,
                customer: document.getElementById('ritaseCustomer').value,
                tujuan: document.getElementById('ritaseKota').value,
                fo: document.getElementById('ritaseFO').value,
                
                // Simpan langsung sebagai Date Object (Firestore otomatis convert ke Timestamp)
                tiba_lokasi_muat: getValOrNull('ritaseTibaMuat'),
                keluar_lokasi_muat: getValOrNull('ritaseKeluarMuat'),
                tiba_lokasi_bongkar: getValOrNull('ritaseTibaBongkar'),
                keluar_lokasi_bongkar: getValOrNull('ritaseKeluarBongkar'),
            };

            // 4. Handle Tanggal Selesai (Wajib)
            const selesaiVal = document.getElementById('ritaseSelesai').value;
            if (selesaiVal) {
                rawData.timestamp_selesai = new Date(selesaiVal);
            } else {
                // Jika data baru dan tanggal kosong, pakai waktu sekarang
                rawData.timestamp_selesai = new Date(); 
            }

            // GANTI BAGIAN TRY-CATCH DI DALAM saveRitaseData
            try {
                if (docId) {
                    // --- UPDATE (EDIT) ---
                    await updateDoc(doc(db, "completed_deliveries", docId), rawData);
                    showSuccessAlert("Berhasil", "Data ritase berhasil diperbarui.");
                } else {
                    // --- CREATE (BARU) ---
                    await addDoc(collection(db, "completed_deliveries"), rawData);
                    showSuccessAlert("Berhasil", "Data ritase baru berhasil ditambahkan.");
                }
                
                // TUTUP MODAL DULU
                window.closeRitaseModal();

                // --- PERBAIKAN UTAMA: REFRESH DATA TABEL ---
                // Panggil ulang loadRitaseData agar Lama Inap dihitung ulang
                // Kita gunakan setTimeout kecil agar database sempat update
                setTimeout(() => {
                    // Cek apakah sedang mode filter tanggal atau tidak
                    const startDateVal = document.getElementById('ritaseStartDate').value;
                    const endDateVal = document.getElementById('ritaseEndDate').value;
                    const isFilterMode = (startDateVal && endDateVal);
                    
                    window.loadRitaseData(isFilterMode); 
                }, 500);

            } catch (error) {
                console.error("Error saving ritase:", error);
                showErrorAlert("Gagal", `Gagal menyimpan data: ${error.message}`);
            }
        };

        // 4. Hapus Data
        window.deleteRitaseData = async (docId) => {
            showConfirmAlert(
                "Hapus Data Ritase?",
                "Data yang dihapus tidak dapat dikembalikan.",
                "Ya, Hapus!",
                async (isConfirmed) => {
                    if (isConfirmed) {
                        try {
                            await deleteDoc(doc(db, "completed_deliveries", docId));
                            showSuccessAlert("Terhapus", "Data ritase berhasil dihapus.");
                        } catch (error) {
                            console.error("Error deleting ritase:", error);
                            showErrorAlert("Gagal", "Gagal menghapus data.");
                        }
                    }
                }
            );
        };

        // --- VARIABEL GLOBAL UNTUK CHART (Agar bisa di-update/destroy) ---
        let chartInstanceBar = null;
        let chartInstancePie = null;

        // --- FUNGSI UPDATE DASHBOARD RITASE ---
        window.updateRitaseDashboard = () => {
            // Pastikan data report tersedia
            if (!window.currentReportData) return;

            // Tampilkan Area Dashboard
            document.getElementById('ritase-dashboard-area').classList.remove('hidden');

            const vendors = [];
            const ritaseCounts = [];
            const unitCounts = [];
            const avgRitases = [];
            const bgColors = []; // Untuk Pie Chart

            let globalTotalRitase = 0;
            let globalTotalUnit = 0;

            // 1. ITERASI DATA & BACA INPUT MANUAL
            // Kita urutkan vendor agar konsisten dengan tabel utama
            const sortedVendors = Object.keys(window.currentReportData).sort();

            sortedVendors.forEach((vendor, index) => {
                const data = window.currentReportData[vendor];
                const vendorEncoded = encodeURIComponent(vendor).replace(/'/g, "%27");
                
                // AMBIL DATA RITASE (Total count dari array trucksList)
                let totalRitaseVendor = 0;
                Object.values(data.trucksList).forEach(t => {
                    totalRitaseVendor += (t.tripCount || 0);
                });

                // AMBIL DATA UNIT (PENTING: Ambil dari Input HTML jika ada, agar sinkron dengan edit manual)
                let totalUnitVendor = data.totalTrucks; // Default dari data
                const inputElem = document.getElementById(`qty-${vendorEncoded}`);
                if (inputElem) {
                    totalUnitVendor = parseInt(inputElem.value) || 0;
                }

                // HITUNG RATA-RATA
                const avg = totalUnitVendor > 0 ? (totalRitaseVendor / totalUnitVendor).toFixed(1) : 0;

                // Push ke Array Data
                vendors.push(vendor);
                ritaseCounts.push(totalRitaseVendor);
                unitCounts.push(totalUnitVendor);
                avgRitases.push(avg);

                // Akumulasi Global
                globalTotalRitase += totalRitaseVendor;
                globalTotalUnit += totalUnitVendor;

                // Generate Warna Unik untuk Pie Chart
                const hue = (index * 137.508) % 360; // Golden angle approximation
                bgColors.push(`hsla(${hue}, 70%, 60%, 0.8)`);
            });

            const globalAvg = globalTotalUnit > 0 ? (globalTotalRitase / globalTotalUnit).toFixed(1) : 0;

            // 2. UPDATE KPI BOXES
            document.getElementById('kpi-total-ritase').innerText = globalTotalRitase.toLocaleString('id-ID');
            document.getElementById('kpi-total-unit').innerText = globalTotalUnit.toLocaleString('id-ID');
            document.getElementById('kpi-avg-ritase').innerText = globalAvg;

            // 3. RENDER / UPDATE CHART
            renderCharts(vendors, ritaseCounts, unitCounts, avgRitases, bgColors);

            // 4. RENDER TABEL REKAP
            renderSummaryTable(vendors, unitCounts, ritaseCounts, avgRitases, globalTotalRitase);
        };

        function renderCharts(labels, ritaseData, unitData, avgData, colors) {
            // --- BAR CHART ---
            const ctxBar = document.getElementById('barChartRitase').getContext('2d');
            if (chartInstanceBar) chartInstanceBar.destroy(); // Hapus chart lama agar tidak numpuk

            chartInstanceBar = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Ritase',
                        data: ritaseData,
                        backgroundColor: '#4f46e5', // Indigo
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const idx = context.dataIndex;
                                    return [
                                        `Jumlah Unit: ${unitData[idx]}`,
                                        `Rata-rata: ${avgData[idx]} rit / unit`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 2] } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // --- PIE CHART ---
            const ctxPie = document.getElementById('pieChartRitase').getContext('2d');
            if (chartInstancePie) chartInstancePie.destroy();

            chartInstancePie = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: ritaseData,
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } }
                    }
                }
            });
        }

        function renderSummaryTable(vendors, units, ritases, avgs, globalTotal) {
            const tbody = document.getElementById('ritaseSummaryBody');
            tbody.innerHTML = '';

            vendors.forEach((vendor, i) => {
                const percent = globalTotal > 0 ? ((ritases[i] / globalTotal) * 100).toFixed(1) + '%' : '0%';
                
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-slate-50">
                        <td class="px-6 py-3 font-medium text-slate-700">${vendor}</td>
                        <td class="px-6 py-3 text-center">${units[i]}</td>
                        <td class="px-6 py-3 text-center font-bold text-indigo-600">${ritases[i]}</td>
                        <td class="px-6 py-3 text-center">${avgs[i]}</td>
                        <td class="px-6 py-3 text-center text-slate-500 text-xs">${percent}</td>
                    </tr>
                `;
            });
        }

        // --- EXPORT KHUSUS REKAP ---
        window.exportRitaseSummaryExcel = () => {
            const table = document.getElementById("ritaseSummaryTable");
            if(!table) return;
            const wb = XLSX.utils.table_to_book(table, {sheet: "Rekap Ritase"});
            const month = document.getElementById('reportMonth').value || 'Report';
            XLSX.writeFile(wb, `Rekap_Ritase_Analisa_${month}.xlsx`);
        };

// --- FUNGSI UPDATE: Render Kartu Vendor (Tampilan Besar & Jelas) ---
function renderRitaseCards(vendors, units, ritases, avgs, globalTotal) {
    const container = document.getElementById('ritase-cards-grid');
    container.innerHTML = '';

    // Warna border
    const borderColors = ['border-indigo-600', 'border-emerald-600', 'border-amber-500', 'border-rose-600', 'border-cyan-600', 'border-purple-600'];

    vendors.forEach((vendor, i) => {
        const percentVal = globalTotal > 0 ? ((ritases[i] / globalTotal) * 100).toFixed(1) : 0;
        const borderColor = borderColors[i % borderColors.length]; 

        const cardHtml = `
        <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 border-t-8 ${borderColor}">
            <div class="p-6">
                <div class="flex justify-between items-start mb-6">
                    <h4 class="text-xl md:text-2xl font-extrabold text-slate-800 leading-tight w-3/4" style="min-height: 3.5rem;">
                        ${vendor}
                    </h4>
                    <span class="bg-slate-800 text-white text-sm font-bold px-3 py-1.5 rounded-lg shadow-sm">
                        #${i + 1}
                    </span>
                </div>
                
                <div class="flex items-end justify-between mb-2">
                    <div>
                        <p class="text-sm font-bold text-slate-500 mb-1 uppercase tracking-wide">Total Ritase</p>
                        <p class="text-5xl font-black text-slate-900 tracking-tight">${ritases[i]}</p>
                    </div>
                    <div class="text-right">
                         <p class="text-xs font-bold text-slate-400 mb-1 uppercase">Kontribusi</p>
                         <p class="text-3xl font-extrabold text-indigo-600">${percentVal}%</p>
                    </div>
                </div>

                <div class="w-full bg-slate-200 rounded-full h-4 mb-8">
                    <div class="bg-indigo-600 h-4 rounded-full shadow-sm" style="width: ${percentVal}%"></div>
                </div>

                <div class="grid grid-cols-2 gap-4 border-t-2 border-slate-100 pt-5">
                    <div>
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-wide">Jml Unit</p>
                        <p class="text-2xl font-extrabold text-slate-700 mt-1 flex items-center">
                            <i class="fas fa-truck text-slate-400 mr-3 text-xl"></i>${units[i]}
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-wide">Rata-rata</p>
                        <p class="text-2xl font-extrabold text-slate-700 mt-1">
                            ${avgs[i]} <span class="text-sm font-bold text-slate-400">rit/unit</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        `;
        container.innerHTML += cardHtml;
    });
}

// --- FUNGSI UPDATE DASHBOARD (Tidak ada perubahan logika, hanya memastikan memanggil render terbaru) ---
window.updateRitaseDashboard = () => {
    if (!window.currentReportData) return;

    // Tampilkan Area Dashboard
    document.getElementById('ritase-dashboard-area').classList.remove('hidden');

    let dashboardData = [];
    let globalTotalRitase = 0;
    let globalTotalUnit = 0;

    const allVendors = Object.keys(window.currentReportData);

    allVendors.forEach((vendor) => {
        const data = window.currentReportData[vendor];
        const vendorEncoded = encodeURIComponent(vendor).replace(/'/g, "%27");
        
        let totalRitaseVendor = 0;
        Object.values(data.trucksList).forEach(t => {
            totalRitaseVendor += (t.tripCount || 0);
        });

        // Ambil Data Unit (dari Input HTML jika ada edit manual)
        let totalUnitVendor = data.totalTrucks;
        const inputElem = document.getElementById(`qty-${vendorEncoded}`);
        if (inputElem) {
            totalUnitVendor = parseInt(inputElem.value) || 0;
        }

        const avg = totalUnitVendor > 0 ? (totalRitaseVendor / totalUnitVendor).toFixed(1) : 0;

        globalTotalRitase += totalRitaseVendor;
        globalTotalUnit += totalUnitVendor;

        dashboardData.push({
            vendor: vendor,
            ritase: totalRitaseVendor,
            unit: totalUnitVendor,
            avg: avg
        });
    });

    const globalAvg = globalTotalUnit > 0 ? (globalTotalRitase / globalTotalUnit).toFixed(1) : 0;

    // UPDATE KPI BOXES
    document.getElementById('kpi-total-ritase').innerText = globalTotalRitase.toLocaleString('id-ID');
    document.getElementById('kpi-total-unit').innerText = globalTotalUnit.toLocaleString('id-ID');
    document.getElementById('kpi-avg-ritase').innerText = globalAvg;

    // SORTING DATA (Ritase Terbanyak di Atas)
    dashboardData.sort((a, b) => b.avg - a.avg);

    const sortedVendors = dashboardData.map(d => d.vendor);
    const sortedRitase = dashboardData.map(d => d.ritase);
    const sortedUnits = dashboardData.map(d => d.unit);
    const sortedAvgs = dashboardData.map(d => d.avg);

    // RENDER CARD
    renderRitaseCards(sortedVendors, sortedUnits, sortedRitase, sortedAvgs, globalTotalRitase);
};

// --- FUNGSI EXPORT EXCEL (Tetap sama, disertakan agar satu paket) ---
window.exportRitaseSummaryExcel = () => {
    if (!window.currentReportData) return;
    
    let exportData = [];
    let globalTotal = 0;

    Object.keys(window.currentReportData).forEach(vendor => {
        const data = window.currentReportData[vendor];
        const vendorEncoded = encodeURIComponent(vendor).replace(/'/g, "%27");
        let ritase = 0;
        Object.values(data.trucksList).forEach(t => ritase += (t.tripCount || 0));
        
        let unit = data.totalTrucks;
        const inputElem = document.getElementById(`qty-${vendorEncoded}`);
        if (inputElem) unit = parseInt(inputElem.value) || 0;

        globalTotal += ritase;
        
        exportData.push({
            vendor: vendor,
            unit: unit,
            ritase: ritase,
            avg: unit > 0 ? (ritase / unit).toFixed(1) : 0
        });
    });

    // Sort Descending by Ritase
    exportData.sort((a, b) => b.ritase - a.ritase);

    const headers = ["Rank", "Nama Vendor", "Jumlah Unit", "Total Ritase", "Rata-rata / Unit", "Kontribusi (%)"];
    const body = exportData.map((d, i) => [
        i + 1,
        d.vendor,
        d.unit,
        d.ritase,
        d.avg,
        globalTotal > 0 ? ((d.ritase / globalTotal) * 100).toFixed(1) + '%' : '0%'
    ]);

    const wsData = [headers, ...body];
    const worksheet = XLSX.utils.aoa_to_sheet(wsData);
    
    const range = XLSX.utils.decode_range(worksheet['!ref']);
    for (let C = range.s.c; C <= range.e.c; ++C) {
        const address = XLSX.utils.encode_col(C) + "1";
        if (!worksheet[address]) continue;
        worksheet[address].s = { font: { bold: true } };
    }

    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Rekap Performa Vendor");
    XLSX.writeFile(workbook, `Rekap_Performa_Vendor.xlsx`);
};
        
    </script>

</body>
</html>
